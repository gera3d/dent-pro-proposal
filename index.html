<!DOCTYPE html>
<html>

<head>
    <!-- Build Version: 2026-01-16 T14:46:00 -->
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quagga2 for VIN Barcode Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Hide scrollbar for iOS PWA feel */
        ::-webkit-scrollbar {
            display: none;
        }

        html {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            color: #fff;
            padding: 16px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 24px 0;
            margin-bottom: 24px;
        }

        .logo {
            margin-bottom: 4px;
        }

        .logo img {
            height: 60px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .subtitle {
            color: #a1a1a6;
            font-size: 14px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #4CD964;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            color: #a1a1a6;
            margin-bottom: 6px;
            font-weight: 500;
        }

        label .required {
            color: #FF453A;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
        }

        input::placeholder,
        textarea::placeholder {
            color: #666;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #fff;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .checkbox-item.selected {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 8px;
            accent-color: #4CD964;
        }

        .checkbox-item span {
            font-size: 13px;
            color: #e0e0e0;
        }

        /* Rating Scale Styles */
        .rating-scale {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rating-option {
            flex: 1;
            min-width: calc(33% - 8px);
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rating-option.selected {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .rating-option input {
            display: none;
        }

        .rating-option span {
            font-size: 13px;
            font-weight: 500;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            gap: 16px;
        }

        .toggle-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .toggle-item.active {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #4CD964;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Severity Pills */
        .severity-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .severity-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .severity-option:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .severity-option.selected {
            border-color: var(--severity-color);
            background: rgba(var(--severity-rgb), 0.15);
        }

        .severity-option input {
            display: none;
        }

        .severity-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .severity-option.light .severity-dot {
            background: #30D158;
        }

        .severity-option.moderate .severity-dot {
            background: #FF9F0A;
        }

        .severity-option.heavy .severity-dot {
            background: #FF453A;
        }

        .severity-option.total .severity-dot {
            background: #8E8E93;
        }

        .severity-option.light.selected {
            --severity-color: #30D158;
            --severity-rgb: 48, 209, 88;
        }

        .severity-option.moderate.selected {
            --severity-color: #FF9F0A;
            --severity-rgb: 255, 159, 10;
        }

        .severity-option.heavy.selected {
            --severity-color: #FF453A;
            --severity-rgb: 255, 69, 58;
        }

        .severity-option.total.selected {
            --severity-color: #8E8E93;
            --severity-rgb: 142, 142, 147;
        }

        /* Submit Button */
        .submit-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to top, rgba(10, 10, 10, 1) 0%, rgba(10, 10, 10, 0.95) 80%, transparent 100%);
        }

        .submit-btn button {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: block;
            padding: 18px 32px;
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            border: none;
            border-radius: 14px;
            color: #000;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .submit-btn button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(76, 217, 100, 0.3);
        }

        .submit-btn button:active {
            transform: translateY(0);
        }

        .submit-btn button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Success Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            max-width: 360px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .modal h2 {
            margin-bottom: 8px;
            font-size: 22px;
        }

        .modal p {
            color: #a1a1a6;
            margin-bottom: 24px;
        }

        .modal button {
            padding: 14px 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* VIN Counter */
        .vin-counter {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }

        .vin-counter.valid {
            color: #4CD964;
        }

        .vin-counter.invalid {
            color: #FF453A;
        }

        /* Photo Upload Styles */
        .photo-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .photo-upload-area:hover {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.05);
        }

        .photo-upload-area.dragover {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
        }

        .photo-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .photo-upload-text {
            color: #a1a1a6;
            font-size: 14px;
        }

        .photo-upload-text strong {
            color: #4CD964;
        }

        .photo-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .photo-btn {
            flex: 1;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .photo-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        .photo-btn:active {
            transform: scale(0.98);
        }

        .photo-btn.camera {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.25) 0%, rgba(0, 122, 255, 0.15) 100%);
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 2px 12px rgba(0, 122, 255, 0.2);
        }

        .photo-btn.camera:hover {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.35) 0%, rgba(0, 122, 255, 0.25) 100%);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        .photo-previews {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(255, 69, 58, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-preview .upload-status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 10px;
            text-align: center;
        }

        .photo-preview .upload-status.uploading {
            color: #FF9F0A;
        }

        .photo-preview .upload-status.uploaded {
            color: #4CD964;
        }

        .photo-preview .upload-status.error {
            color: #FF453A;
        }

        .photo-count {
            font-size: 12px;
            color: #a1a1a6;
            margin-top: 8px;
            text-align: center;
        }

        .photo-name-input {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 6px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: #fff;
            font-size: 10px;
            text-align: center;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .photo-name-input::placeholder {
            color: #888;
        }

        .photo-name-input:focus {
            outline: none;
            background: rgba(0, 122, 255, 0.3);
        }

        /* SAVED FORMS BAR */
        .saved-forms-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .saved-forms-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .saved-forms-left label {
            font-size: 13px;
            font-weight: 600;
            color: #a1a1a6;
            white-space: nowrap;
            margin: 0;
        }

        .saved-forms-select {
            flex: 1;
            min-width: 150px;
            padding: 10px 36px 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 18px;
            cursor: pointer;
        }

        .saved-forms-select:focus {
            outline: none;
            border-color: #007AFF;
            background-color: rgba(0, 122, 255, 0.1);
        }

        .saved-forms-select option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        .saved-forms-actions {
            display: flex;
            gap: 8px;
        }

        .saved-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            white-space: nowrap;
        }

        .saved-btn.save {
            background: rgba(0, 122, 255, 0.2);
            color: #007AFF;
            border: 1px solid rgba(0, 122, 255, 0.3);
        }

        .saved-btn.save:hover {
            background: rgba(0, 122, 255, 0.3);
        }

        .saved-btn.delete {
            background: rgba(255, 69, 58, 0.15);
            color: #FF453A;
            border: 1px solid rgba(255, 69, 58, 0.25);
        }

        .saved-btn.delete:hover {
            background: rgba(255, 69, 58, 0.25);
        }

        .saved-btn.new {
            background: rgba(76, 217, 100, 0.15);
            color: #4CD964;
            border: 1px solid rgba(76, 217, 100, 0.25);
        }

        .saved-btn.new:hover {
            background: rgba(76, 217, 100, 0.25);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: rgba(76, 217, 100, 0.5);
        }

        .toast.error {
            border-color: rgba(255, 69, 58, 0.5);
        }

        /* VIN Scanner Modal */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 10001;
            display: flex;
            flex-direction: column;
        }

        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.9);
        }

        .scanner-header h3 {
            margin: 0;
            color: #fff;
            font-size: 18px;
        }

        .scanner-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .scanner-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #111;
        }

        #scannerCamera {
            width: 100%;
            height: 100%;
        }

        #scannerCamera video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-guide {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .guide-box {
            width: 80%;
            height: 80px;
            border: 3px solid #4CD964;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .guide-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4CD964, transparent);
            animation: scanLine 1.5s ease-in-out infinite;
        }

        @keyframes scanLine {

            0%,
            100% {
                top: 0;
                opacity: 0.5;
            }

            50% {
                top: calc(100% - 3px);
                opacity: 1;
            }
        }

        .scanner-guide p {
            color: #fff;
            margin-top: 16px;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .scanner-status {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #a1a1a6;
            font-size: 14px;
            text-align: center;
        }

        .scanner-status.success {
            color: #4CD964;
        }

        .scanner-status.error {
            color: #FF453A;
        }

        /* Scanner Tips */
        .scanner-tips {
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tips-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            color: #FFD60A;
            font-size: 14px;
            font-weight: 500;
        }

        .tips-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tips-arrow {
            transition: transform 0.3s ease;
        }

        .tips-arrow.expanded {
            transform: rotate(180deg);
        }

        .tips-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 20px;
        }

        .tips-content.expanded {
            max-height: 300px;
            padding: 0 20px 16px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #a1a1a6;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tip-item:last-child {
            border-bottom: none;
        }

        .tip-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .scanner-actions {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.9);
        }

        .scanner-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .scanner-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .scanner-btn.manual {
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
            color: #fff;
        }

        @media (max-width: 500px) {
            .saved-forms-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .saved-forms-left {
                flex-direction: column;
                align-items: stretch;
            }

            .saved-forms-actions {
                justify-content: stretch;
            }

            .saved-btn {
                flex: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- NEW HEADER DESIGN (Split Layout) -->
        <div class="brand-bar">
            <div class="logo"><img src="logo.webp" alt="Dent Experts Logo"></div>
            <div class="brand-bar-right">
                <button id="appBtn" class="app-btn state-checking" onclick="handleAppButton()">
                    ‚è≥ Checking...
                </button>
                <a href="Option_B_Custom_WebApp/Training_Guide.html" class="help-link">üìñ Training Guide &
                    Terminology</a>
            </div>
        </div>

        <!-- SAVED FORMS SECTION -->
        <div class="saved-forms-bar">
            <div class="saved-forms-left">
                <label>üìÇ Saved Forms</label>
                <select id="savedFormsDropdown" class="saved-forms-select" onchange="loadSavedForm()">
                    <option value="">-- Select Saved Form --</option>
                </select>
            </div>
            <div class="saved-forms-actions">
                <button type="button" class="saved-btn save" onclick="saveCurrentForm()">üíæ Save</button>
                <button type="button" class="saved-btn delete" onclick="deleteSavedForm()">üóëÔ∏è Delete</button>
                <button type="button" class="saved-btn new" onclick="startNewForm()">‚ûï New</button>
            </div>
        </div>

        <div class="action-toolbar">
            <div class="meta-group">
                <label>RO#</label>
                <input type="text" id="roNumber" class="toolbar-input" required placeholder="e.g. 10452">
            </div>
            <div class="meta-group">
                <label>Estimator</label>
                <select id="estimator" class="toolbar-input">
                    <option value="">Select</option>
                    <option value="Oleg">Oleg</option>
                    <option value="Gera">Gera</option>
                    <option value="John">John</option>
                    <option value="Jane">Jane</option>
                </select>
            </div>
        </div>

        <form id="scopeForm">
            <!-- GENERAL INFORMATION (Compact Grid) -->
            <!-- GENERAL INFORMATION (Pro Grid) -->
            <div class="general-info-grid">
                <div class="info-group col-span-2">
                    <label>Insured (Customer Name)</label>
                    <input type="text" id="insuredName" required placeholder="Customer's full name">
                </div>
                <div class="info-group col-span-2">
                    <label>Carrier</label>
                    <select id="insuranceCompany" required>
                        <option value="">Select Insurance</option>
                    </select>
                </div>
                <div class="info-group col-span-2">
                    <label>Claim #</label>
                    <input type="text" id="claimNumber" required placeholder="e.g. 123-456-789">
                </div>


                <div class="info-group col-span-2">
                    <label>Year / Make / Model</label>
                    <div class="ymb-row">
                        <select id="year" style="width: 80px"></select>
                        <select id="make" style="flex:1"></select>
                        <input type="text" id="model" placeholder="Model (e.g. F-150)" style="flex:1">
                    </div>
                </div>

                <div class="info-group col-span-1">
                    <label>Odometer</label>
                    <input type="text" id="odometer" placeholder="e.g. 45,200">
                </div>

                <div class="info-group col-span-1">
                    <label>Location</label>
                    <select id="location"></select>
                </div>

                <div class="info-group col-span-2">
                    <label>VIN # <span id="vinCounter" class="vin-counter">0/17</span></label>
                    <div class="vin-row">
                        <input type="text" id="vin" maxlength="17" oninput="updateVinCounter()"
                            placeholder="17 Characters">
                        <button type="button" class="scan-btn" onclick="copyVin()" title="Copy VIN">üìã</button>
                        <button type="button" class="scan-btn" onclick="startScanner()" title="Scan VIN">üì∑</button>
                    </div>
                </div>

                <div class="info-group col-span-2">
                    <label>Color / Trim</label>
                    <input type="text" id="color" placeholder="e.g. Pearl White / LX">
                </div>
            </div>

            <!-- VEHICLE DAMAGE ASSESSMENT (Visual Grid) -->
            <div class="damage-grid-container">
                <div class="grid-header">Vehicle Damage Assessment</div>

                <div class="visual-grid">
                    <!-- LEFT COLUMN -->
                    <div class="side-column" id="col_left">
                        <!-- Left Fender -->
                        <div class="panel-box">
                            <div class="panel-header">Left Fender</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="lf_fender_dc"></label>
                                <label>OS: <input type="text" name="lf_fender_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="lf_fender_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="lf_fender_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_emblem"></td>
                                    <td>Emblem</td>
                                    <td><input type="checkbox" name="lf_fender_rr_emblem"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="lf_fender_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Front Door -->
                        <div class="panel-box">
                            <div class="panel-header">Left Front Door</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="lf_door_dc"></label>
                                <label>OS: <input type="text" name="lf_door_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_mirror"></td>
                                    <td>Mirror</td>
                                    <td><input type="checkbox" name="lf_door_rr_mirror"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="lf_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="lf_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="lf_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="lf_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="lf_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="lf_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Rear Door -->
                        <div class="panel-box">
                            <div class="panel-header">Left Rear Door</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="lr_door_dc"></label>
                                <label>OS: <input type="text" name="lr_door_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="lr_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="lr_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="lr_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="lr_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="lr_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="lr_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Quarter -->
                        <div class="panel-box">
                            <div class="panel-header">Left Quarter/Bed</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="lr_quarter_dc"></label>
                                <label>OS: <input type="text" name="lr_quarter_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_glass"></td>
                                    <td>Glass</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_glass"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Cab Corner (Ratings Only) -->
                        <div class="panel-box mini">
                            <div class="panel-header">Left Cab Corner</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="l_cab_dc"></label>
                                <label>OS: <input type="text" name="l_cab_os"></label>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER COLUMN (Schematic + Top/Bottom Panels) -->
                    <div class="center-column">
                        <!-- Schematic Visualization (CSS Art or Image Placehoder) -->
                        <!-- Schematic Visualization -->
                        <!-- Schematic Visualization -->
                        <div class="car-schematic" style="text-align: center; margin-bottom: 20px; position: relative;">
                            <!-- Glow Effect -->
                            <div
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 300px; background: radial-gradient(closest-side, rgba(76, 217, 100, 0.15), transparent); pointer-events: none;">
                            </div>
                            <svg width="220" height="330" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg"
                                style="filter: drop-shadow(0 0 10px rgba(76,217,100,0.2));">
                                <style>
                                    .car-line {
                                        fill: none;
                                        stroke: #4CD964;
                                        stroke-width: 2;
                                    }

                                    .car-fill {
                                        fill: #222;
                                        transition: fill 0.3s;
                                    }

                                    .car-fill:hover {
                                        fill: #2a2a2a;
                                    }

                                    .glass {
                                        fill: #333;
                                        stroke: #4CD964;
                                        stroke-width: 1;
                                    }

                                    .click-zone {
                                        fill: transparent;
                                        cursor: pointer;
                                    }

                                    .click-zone:hover {
                                        fill: rgba(76, 217, 100, 0.1);
                                    }

                                    text {
                                        pointer-events: none;
                                        user-select: none;
                                    }
                                </style>

                                <!-- Body Structure -->
                                <path class="car-line car-fill"
                                    d="M40,60 C40,40 60,20 100,20 C140,20 160,40 160,60 L160,240 C160,260 140,280 100,280 C60,280 40,260 40,240 Z" />
                                <path class="glass" d="M45,80 L155,80 L150,110 L50,110 Z" />
                                <path class="glass" d="M45,220 L155,220 L150,190 L50,190 Z" />
                                <line x1="45" y1="110" x2="45" y2="190" stroke="#444" stroke-width="1" />
                                <line x1="155" y1="110" x2="155" y2="190" stroke="#444" stroke-width="1" />

                                <!-- Labels -->
                                <text x="100" y="55" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">HOOD</text>
                                <text x="100" y="150" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">ROOF</text>
                                <text x="100" y="250" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">TRUNK</text>

                                <!-- Mirrors -->
                                <rect x="25" y="85" width="15" height="10" rx="2" fill="#444" />
                                <rect x="160" y="85" width="15" height="10" rx="2" fill="#444" />

                                <!-- INTERACTIVE ZONES -->
                                <rect x="0" y="0" width="40" height="300" class="click-zone"
                                    onclick="scrollToPanel('col_left')" title="Left Side Panels" />
                                <rect x="160" y="0" width="40" height="300" class="click-zone"
                                    onclick="scrollToPanel('col_right')" title="Right Side Panels" />
                                <rect x="40" y="0" width="120" height="100" class="click-zone"
                                    onclick="scrollToPanel('section_hood')" title="Front / Hood" />
                                <rect x="40" y="100" width="120" height="100" class="click-zone"
                                    onclick="scrollToPanel('section_roof')" title="Center / Roof" />
                                <rect x="40" y="200" width="120" height="120" class="click-zone"
                                    onclick="scrollToPanel('section_deck')" title="Rear / Trunk" />
                            </svg>
                        </div>

                        <!-- Hood/Windshield -->
                        <div class="panel-box" id="section_hood">
                            <div class="panel-header">Hood / Windshield</div>
                            <div class="panel-ratings">
                                <label>Hood DC: <input type="text" name="hood_dc"></label>
                                <label>Hood OS: <input type="text" name="hood_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_windshield"></td>
                                    <td>Windshield</td>
                                    <td><input type="checkbox" name="hood_rr_windshield"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_cowl"></td>
                                    <td>Cowl</td>
                                    <td><input type="checkbox" name="hood_rr_cowl"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_hood"></td>
                                    <td>Hood</td>
                                    <td><input type="checkbox" name="hood_rr_hood"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Roof -->
                        <div class="panel-box" id="section_roof">
                            <div class="panel-header">Roof</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="roof_dc"></label>
                                <label>OS: <input type="text" name="roof_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_hilamp"></td>
                                    <td>Hi-Mt Lamp</td>
                                    <td><input type="checkbox" name="roof_rr_hilamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_headliner"></td>
                                    <td>Headliner</td>
                                    <td><input type="checkbox" name="roof_rr_headliner"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_sunroof"></td>
                                    <td>Sunroof</td>
                                    <td><input type="checkbox" name="roof_rr_sunroof"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_l_mldg"></td>
                                    <td>L Roof Mldg</td>
                                    <td><input type="checkbox" name="roof_rr_l_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_r_mldg"></td>
                                    <td>R Roof Mldg</td>
                                    <td><input type="checkbox" name="roof_rr_r_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_rack"></td>
                                    <td>Roof Rack</td>
                                    <td><input type="checkbox" name="roof_rr_rack"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_ant"></td>
                                    <td>Antenna</td>
                                    <td><input type="checkbox" name="roof_rr_ant"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Rails -->
                        <div class="rails-row">
                            <div class="panel-box mini">
                                <div class="panel-header">Left Rail</div>
                                <div class="panel-ratings vertical">
                                    <label>DC: <input type="text" name="l_rail_dc"></label>
                                    <label>OS: <input type="text" name="l_rail_os"></label>
                                </div>
                            </div>
                            <div class="panel-box mini">
                                <div class="panel-header">Right Rail</div>
                                <div class="panel-ratings vertical">
                                    <label>DC: <input type="text" name="r_rail_dc"></label>
                                    <label>OS: <input type="text" name="r_rail_os"></label>
                                </div>
                            </div>
                        </div>

                        <!-- Deck/Lid -->
                        <div class="panel-box" id="section_deck">
                            <div class="panel-header">Deck / Lid / Gate</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="deck_dc"></label>
                                <label>OS: <input type="text" name="deck_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_llamp"></td>
                                    <td>L Lamp(s)</td>
                                    <td><input type="checkbox" name="deck_rr_llamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_rlamp"></td>
                                    <td>R Lamp(s)</td>
                                    <td><input type="checkbox" name="deck_rr_rlamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="deck_rr_handle"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_spoiler"></td>
                                    <td>Spoiler</td>
                                    <td><input type="checkbox" name="deck_rr_spoiler"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_ant"></td>
                                    <td>Antenna</td>
                                    <td><input type="checkbox" name="deck_rr_ant"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="side-column" id="col_right">
                        <!-- Right Fender -->
                        <div class="panel-box">
                            <div class="panel-header">Right Fender</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="rf_fender_dc"></label>
                                <label>OS: <input type="text" name="rf_fender_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="rf_fender_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="rf_fender_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_emblem"></td>
                                    <td>Emblem</td>
                                    <td><input type="checkbox" name="rf_fender_rr_emblem"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="rf_fender_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Front Door -->
                        <div class="panel-box">
                            <div class="panel-header">Right Front Door</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="rf_door_dc"></label>
                                <label>OS: <input type="text" name="rf_door_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_mirror"></td>
                                    <td>Mirror</td>
                                    <td><input type="checkbox" name="rf_door_rr_mirror"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="rf_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="rf_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="rf_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="rf_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="rf_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="rf_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Rear Door -->
                        <div class="panel-box">
                            <div class="panel-header">Right Rear Door</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="rr_door_dc"></label>
                                <label>OS: <input type="text" name="rr_door_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="rr_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="rr_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="rr_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="rr_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="rr_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="rr_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Quarter -->
                        <div class="panel-box">
                            <div class="panel-header">Right Quarter/Bed</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="rr_quarter_dc"></label>
                                <label>OS: <input type="text" name="rr_quarter_os"></label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_glass"></td>
                                    <td>Glass</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_glass"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Cab Corner (Ratings Only) -->
                        <div class="panel-box mini">
                            <div class="panel-header">Right Cab Corner</div>
                            <div class="panel-ratings">
                                <label>DC: <input type="text" name="r_cab_dc"></label>
                                <label>OS: <input type="text" name="r_cab_os"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PHOTOS ONLY (Reduced notes etc to match photo priority, kept Notes though) -->
            <div class="section footer-section">
                <!-- Notes -->
                <div class="notes-box">
                    <label>Notes:</label>
                    <textarea id="notes" rows="4"></textarea>
                </div>

                <!-- Photos -->
                <div class="photo-section">
                    <label>Photos (Vin/Odometer/Damage):</label>
                    <div class="photo-controls">
                        <button type="button" class="photo-btn camera" onclick="openCamera()">üì∑ Camera</button>
                        <button type="button" class="photo-btn"
                            onclick="document.getElementById('photoInput').click()">üñºÔ∏è Gallery</button>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none"
                        onchange="handlePhotoSelect(event)">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none"
                        onchange="handlePhotoSelect(event)">
                    <div id="photoPreviews" class="photo-previews-row"></div>
                </div>
            </div>

            <div class="submit-bar">
                <!-- Estimate Display -->
                <div class="estimate-bar" id="estimateBar">
                    <div>
                        <div class="estimate-label">PDR Estimate</div>
                        <div class="estimate-amount" id="estimateTotal">$0</div>
                    </div>
                    <button type="button" class="estimate-toggle" onclick="toggleEstimate()">
                        üëÅÔ∏è Hide
                    </button>
                </div>

                <!-- Stats Row -->
                <div class="footer-stats-row">
                    <div class="stat-box dents">
                        <span class="stat-label">Panels w/Damage</span>
                        <span class="stat-value" id="liveDentCount">0</span>
                    </div>
                    <div class="stat-box oversized">
                        <span class="stat-label">Oversized</span>
                        <span class="stat-value" id="liveOsCount">0</span>
                    </div>
                    <div class="stat-box parts">
                        <span class="stat-label">R&I Parts</span>
                        <span class="stat-value" id="liveRiCount">0</span>
                    </div>
                    <div class="stat-box parts">
                        <span class="stat-label">R&R Parts</span>
                        <span class="stat-value" id="liveRrCount">0</span>
                    </div>
                    <div class="stat-box" id="saveStatusBox" style="display:none;">
                        <span class="stat-label">Status</span>
                        <span class="stat-value" id="saveStatus">Saved</span>
                    </div>
                </div>


                <!-- Actions Row -->
                <div class="footer-actions-row">
                    <select id="status" class="footer-select" required>
                        <option value="Complete">‚úì Complete</option>
                        <option value="Partial">‚óê Partial</option>
                        <option value="Supplement">+ Supplement</option>
                    </select>

                    <div class="footer-buttons">
                        <button type="button" class="footer-btn orange" onclick="exportToCSV()">
                            üìä Export
                        </button>
                        <button type="button" class="footer-btn blue" onclick="nativeShare()">
                            üì§ Share
                        </button>
                        <button type="button" class="footer-btn green" id="submitBtn" onclick="submitForm()">
                            ‚úÖ Submit Scope
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- VIN Scanner Modal -->
    <div id="scannerModal" class="scanner-modal" style="display: none;">
        <div class="scanner-header">
            <h3>üì∑ Scan VIN Barcode</h3>
            <button type="button" onclick="closeScanner()" class="scanner-close">‚úï</button>
        </div>
        <div class="scanner-viewport">
            <div id="scannerCamera"></div>
            <div class="scanner-guide">
                <div class="guide-box"></div>
                <p>Align barcode within the frame</p>
            </div>
        </div>
        <div class="scanner-status" id="scannerStatus">Initializing camera...</div>

        <!-- Scanning Tips -->
        <div class="scanner-tips">
            <div class="tips-toggle" onclick="toggleScannerTips()">
                <span>üí° Tips for better scanning</span>
                <span class="tips-arrow" id="tipsArrow">‚ñº</span>
            </div>
            <div class="tips-content" id="tipsContent">
                <div class="tip-item">
                    <span class="tip-icon">‚òÄÔ∏è</span>
                    <span>Good lighting - avoid shadows on barcode</span>
                </div>
                <div class="tip-item">
                    <span class="tip-icon">üìè</span>
                    <span>Hold 4-8 inches from barcode</span>
                </div>
                <div class="tip-item">
                    <span class="tip-icon">üìê</span>
                    <span>Keep camera parallel, not angled</span>
                </div>
                <div class="tip-item">
                    <span class="tip-icon">üîç</span>
                    <span>Door jamb sticker has the barcode</span>
                </div>
                <div class="tip-item">
                    <span class="tip-icon">‚úã</span>
                    <span>Hold steady for 2-3 seconds</span>
                </div>
            </div>
        </div>

        <div class="scanner-actions">
            <button type="button" onclick="closeScanner()" class="scanner-btn cancel">Cancel</button>
            <button type="button" onclick="manualVinEntry()" class="scanner-btn manual">‚úçÔ∏è Type VIN Instead</button>
        </div>
    </div>

    <!-- Modal and Scripts -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-icon">‚úì</div>
            <h2>Scope Submitted!</h2>
            <button onclick="resetForm()">New Scope</button>
        </div>
    </div>

    <!-- Retaining Scripts & Styles block (will update CSS next tool call) -->
    <style>
        /* BASE & RESET */
        * {
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at 50% 0%, #252525 0%, #111111 100%);
            min-height: 100vh;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 140px !important;
            /* Footer Space: Sufficient but not crazy */
            touch-action: pan-x pan-y;
            /* Disable pinch-zoom */
        }

        /* GRID LAYOUTS */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 16px;
            /* standard 16px horiz padding */
        }

        /* HEADER REDESIGN (Split Layout) */
        .brand-bar {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-bar .logo {
            font-size: 24px;
            font-weight: 800;
            color: #4CD964;
            letter-spacing: -0.5px;
        }

        .brand-bar .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .help-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #007AFF;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .help-link:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .brand-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .app-btn:hover {
            transform: scale(1.05);
        }

        .app-btn.state-checking {
            background: rgba(255, 255, 255, 0.1);
            cursor: default;
        }

        .app-btn.state-install {
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
        }

        .app-btn.state-update {
            background: linear-gradient(135deg, #FF9F0A 0%, #FF6B00 100%);
            animation: pulse-update 2s ease-in-out infinite;
        }

        .app-btn.state-current {
            background: rgba(76, 217, 100, 0.2);
            border: 1px solid rgba(76, 217, 100, 0.4);
            color: #4CD964;
            cursor: default;
        }

        .app-btn.state-current:hover {
            transform: none;
        }

        @keyframes pulse-update {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 159, 10, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(255, 159, 10, 0);
            }
        }

        .action-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(45, 45, 45, 0.4);
            padding: 20px;
            /* Unified 20px */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meta-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .meta-group label {
            font-size: 14px;
            font-weight: 700;
            color: #bbb;
        }

        .toolbar-input {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            height: 44px;
            border-radius: 8px;
            padding: 0 12px;
            color: #fff;
            font-size: 16px;
            min-width: 140px;
        }

        /* Clear old header styles if any remain */
        .header,
        .form-meta,
        .inline-input {
            display: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            background: rgba(255, 255, 255, 0.08);
            /* Lighter Glass */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 0 12px;
            border-radius: 8px;
            font-size: 16px;
            /* Prevent iOS zoom */
            height: 44px;
            /* iOS Touch Target */
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
            -webkit-appearance: none;
            /* Remove default styling */
            appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 10px auto;
        }

        input:focus,
        select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4CD964;
            /* Highlight */
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 217, 100, 0.1);
        }

        .inline-input {
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 5px;
            border-radius: 4px;
        }

        /* GENERAL INFO GRID */
        .general-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .col-span-1 {
            grid-column: span 1;
        }

        .col-span-2 {
            grid-column: span 2;
        }

        .col-span-4 {
            grid-column: span 4;
        }

        @media (max-width: 768px) {
            .general-info-grid {
                grid-template-columns: 1fr;
            }

            .col-span-1,
            .col-span-2,
            .col-span-4 {
                grid-column: auto;
            }
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Fix Year/Make/Model Row */
        .ymb-row {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .ymb-row select,
        .ymb-row input {
            width: auto;
            /* Allow flex to control width */
        }

        .info-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .info-group input,
        .info-group select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
        }

        .vin-row {
            display: flex;
            gap: 5px;
        }

        /* DAMAGE GRID */
        .damage-grid-container {
            background: rgba(30, 30, 30, 0.4);
            padding: 20px;
            /* Unified 20px */
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .grid-header {
            background: rgba(51, 51, 51, 0.8);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }

        .visual-grid {
            display: grid;
            /* Optimized for iPad Landscape (1024px) */
            grid-template-columns: 290px 1fr 290px;
            gap: 16px;
            align-items: start;
        }

        /* iPad Pro / Landscape / Tablet Tweak (Prevent Cutoff on 820px) */
        @media (max-width: 1100px) {
            .visual-grid {
                grid-template-columns: 245px 1fr 245px;
                /* Slimmer to fit 820px width */
                gap: 12px;
            }

            .container {
                padding: 10px 12px;
                /* tighter padding saves ~10px */
            }

            .damage-grid-container {
                padding: 12px;
                /* tighter padding saves ~16px */
            }

            .panel-box {
                padding: 12px;
            }

            .brand-bar .logo {
                font-size: 20px;
            }
        }

        /* iPad Portrait & Tablets (Break layout early to prevent squishing) */
        @media (max-width: 780px) {
            .visual-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .center-column {
                grid-column: 1 / -1;
                order: -1;
                margin-bottom: 20px;
            }
        }

        /* Mobile Only (< 600px) */
        @media (max-width: 600px) {
            .visual-grid {
                grid-template-columns: 1fr;
            }
        }

        /* CAR SCHEMATIC */
        .car-schematic svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* PANEL BOXES (Glassmorphism) */
        /* INDIVIDUAL PANELS */
        .panel-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 16px;
            /* More padding */
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .panel-box:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
        }

        .panel-header {
            font-size: 15px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            border-left: 4px solid #4CD964;
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* DONE TOGGLE STYLES */
        .panel-done-toggle {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #888;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-done-toggle input {
            width: 16px;
            height: 16px;
            margin: 0;
            accent-color: #4CD964;
        }

        .panel-done-toggle:hover {
            color: #fff;
        }

        /* COMPLETE STATE */
        .panel-box.is-complete {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.05);
            box-shadow: 0 0 15px rgba(76, 217, 100, 0.1);
        }

        .panel-box.is-complete .panel-header {
            color: #4CD964;
        }

        .panel-box.is-complete .panel-done-toggle {
            background: #4CD964;
            color: #000;
        }

        .panel-ratings {
            display: grid;
            /* Stack vertically and fill width */
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            align-items: center;
        }











        .panel-ratings label {
            font-size: 11px;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .panel-ratings input {
            width: 44px;
            /* Larger touch target */
            height: 32px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #4CD964;
            padding: 4px;
            text-align: center;
            font-weight: bold;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .panel-ratings input:focus {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
            outline: none;
        }

        /* SMART STEPPER UI v2 */
        .stepper-ui {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Spread Label and Controls */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 4px 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0;
            width: 100%;
            /* Fill Container */
            height: 44px;
        }

        .st-label {
            font-size: 11px;
            color: #aaa;
            margin: 0 8px 0 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .st-btn {
            width: 40px;
            /* Large Hit Area */
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #4CD964;
            font-size: 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.1s;
        }

        .st-btn:active {
            background: #4CD964;
            color: #000;
        }

        .st-input {
            width: 40px !important;
            border: none !important;
            background: transparent !important;
            text-align: center;
            color: #fff !important;
            font-size: 18px !important;
            font-weight: bold;
            margin: 0;
            padding: 0 !important;
            height: 100% !important;
        }

        /* DENT COUNT RANGE BUTTONS */
        .dc-range-ui {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dc-range-label {
            font-size: 10px;
            color: #888;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dc-range-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .dc-range-btn {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #ccc;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 48px;
            text-align: center;
        }

        .dc-range-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .dc-range-btn.selected {
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.25) 0%, rgba(76, 217, 100, 0.15) 100%);
            border-color: #4CD964;
            color: #4CD964;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(76, 217, 100, 0.3);
        }

        /* COIN SIZE BUTTONS */
        .coin-size-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .coin-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #999;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .coin-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .coin-btn.selected {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.25) 0%, rgba(0, 122, 255, 0.15) 100%);
            border-color: #007AFF;
            color: #007AFF;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        /* ESTIMATE DISPLAY */
        .estimate-bar {
            background: linear-gradient(135deg, rgba(255, 159, 10, 0.15) 0%, rgba(255, 159, 10, 0.08) 100%);
            border: 1px solid rgba(255, 159, 10, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .estimate-bar.hidden {
            display: none;
        }

        .estimate-amount {
            font-size: 28px;
            font-weight: 700;
            color: #FF9F0A;
        }

        .estimate-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estimate-toggle {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #888;
            font-size: 11px;
            cursor: pointer;
        }

        .estimate-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* UPD TOGGLE */
        .upd-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(255, 159, 10, 0.08);
            border: 1px solid rgba(255, 159, 10, 0.15);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upd-toggle:hover {
            background: rgba(255, 159, 10, 0.12);
            border-color: rgba(255, 159, 10, 0.25);
        }

        .upd-toggle.active {
            background: rgba(255, 159, 10, 0.15);
            border-color: rgba(255, 159, 10, 0.4);
        }

        .upd-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #FF9500;
        }

        .upd-toggle span {
            font-size: 11px;
            font-weight: 600;
            color: #FF9500;
        }

        .panel-box.has-upd {
            border-color: #FF9500 !important;
            box-shadow: 0 0 12px rgba(255, 149, 0, 0.2);
        }

        .panel-box.has-upd .panel-header {
            border-left-color: #FF9500;
        }

        .upd-notes {
            display: none;
            margin-top: 8px;
        }

        .upd-notes.visible {
            display: block;
        }

        .upd-notes textarea {
            width: 100%;
            min-height: 60px;
            background: rgba(255, 149, 0, 0.05);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: 6px;
            color: #fff;
            padding: 8px;
            font-size: 13px;
            resize: vertical;
        }

        .upd-notes textarea::placeholder {
            color: rgba(255, 149, 0, 0.5);
        }

        /* CHECKLIST TABLES */
        .checklist-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 2px;
            margin-top: 10px;
            table-layout: fixed;
            /* Force fixed columns */
        }

        /* Explicit Column Widths */
        .checklist-table th:nth-child(1) {
            width: 18%;
        }

        .checklist-table th:nth-child(2) {
            width: 64%;
        }

        .checklist-table th:nth-child(3) {
            width: 18%;
        }

        .checklist-table th {
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
            padding: 8px 2px;
            font-size: 10px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            white-space: nowrap;
        }

        .checklist-table td {
            padding: 0 2px;
            border: none;
            height: 48px;
            vertical-align: middle;
            font-size: 14px;
            text-align: center;
        }

        .checklist-table td:nth-child(2) {
            text-align: left;
            padding-left: 8px;
            width: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ddd;
            font-weight: 500;
        }

        /* CUSTOM CHECKBOX (Touch Friendly) */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 26px;
            height: 26px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #555;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type="checkbox"]:checked {
            background: #4CD964;
            border-color: #4CD964;
            box-shadow: 0 0 10px rgba(76, 217, 100, 0.4);
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 45%;
            width: 6px;
            height: 12px;
            border: solid #000;
            border-width: 0 2.5px 2.5px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        input[type="checkbox"]:active {
            transform: scale(0.92);
        }

        /* Add row hover effect for easier tracking */
        .checklist-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        /* FOOTER */
        .footer-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .notes-box textarea {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
        }

        /* REBUILT FOOTER CSS */
        .submit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(15, 15, 15, 0.98) 0%, rgba(20, 20, 20, 0.95) 100%);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            z-index: 9999;
            gap: 10px;
        }

        .footer-stats-row {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            width: 100%;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 60px;
            flex: 1;
        }

        .stat-box .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .stat-box .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .stat-box.dents {
            border-color: rgba(76, 217, 100, 0.3);
            background: rgba(76, 217, 100, 0.08);
        }

        .stat-box.dents .stat-value {
            color: #4CD964;
        }

        .stat-box.oversized {
            border-color: rgba(255, 59, 48, 0.3);
            background: rgba(255, 59, 48, 0.08);
        }

        .stat-box.oversized .stat-value {
            color: #FF3B30;
        }

        .stat-box.parts {
            border-color: rgba(0, 122, 255, 0.3);
            background: rgba(0, 122, 255, 0.08);
        }

        .stat-box.parts .stat-value {
            color: #007AFF;
        }

        .stat-box.estimate {
            border-color: rgba(255, 214, 10, 0.4);
            background: rgba(255, 214, 10, 0.12);
            min-width: 90px;
        }

        .stat-box.estimate .stat-value {
            color: #FFD60A;
            font-size: 16px;
        }

        .footer-actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .footer-select {
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 18px;
            padding-right: 36px;
            min-width: 130px;
        }

        .footer-select option {
            background: #1a1a1a;
            color: #fff;
        }

        .footer-buttons {
            display: flex;
            gap: 8px;
        }

        .footer-btn {
            height: 44px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            padding: 0 16px;
            cursor: pointer;
            white-space: nowrap;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .footer-btn:active {
            transform: scale(0.96);
        }

        .footer-btn.blue {
            background: linear-gradient(135deg, #007AFF 0%, #0066DD 100%);
            color: #fff;
        }

        .footer-btn.blue:hover {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .footer-btn.green {
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            color: #000;
        }

        .footer-btn.green:hover {
            box-shadow: 0 4px 12px rgba(76, 217, 100, 0.4);
        }

        .footer-btn.orange {
            background: linear-gradient(135deg, #FF9F0A 0%, #FF7A00 100%);
            color: #000;
        }

        .footer-btn.orange:hover {
            box-shadow: 0 4px 12px rgba(255, 159, 10, 0.4);
        }

        @media (max-width: 500px) {
            .footer-stats-row {
                flex-wrap: wrap;
            }

            .stat-box {
                min-width: calc(33% - 8px);
            }

            .footer-actions-row {
                flex-direction: column;
            }

            .footer-select {
                width: 100%;
            }

            .footer-buttons {
                width: 100%;
            }

            .footer-btn {
                flex: 1;
            }
        }

        /* Clear old styles */
        .status-select,
        .submit-btn {
            display: none;
        }
    </style>

    <script>
        // CONFIGURATION
        const CONFIG = {
            photoFolderId: 'YOUR_FOLDER_ID_HERE'
        };

        // STATE
        let selectedPhotos = [];
        const SAVED_FORMS_KEY = 'dent_pro_saved_forms';

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            loadSavedFormsList();

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed', err));
            }
        });

        // =============================================
        // SAVED FORMS MANAGEMENT (localStorage)
        // =============================================

        function getSavedForms() {
            const saved = localStorage.getItem(SAVED_FORMS_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        function setSavedForms(forms) {
            localStorage.setItem(SAVED_FORMS_KEY, JSON.stringify(forms));
        }

        function loadSavedFormsList() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const forms = getSavedForms();

            // Clear existing options except the default
            dropdown.innerHTML = '<option value="">-- Select Saved Form --</option>';

            // Sort forms by timestamp (newest first)
            const sortedKeys = Object.keys(forms).sort((a, b) => {
                return (forms[b].savedAt || 0) - (forms[a].savedAt || 0);
            });

            sortedKeys.forEach(key => {
                const form = forms[key];
                const opt = document.createElement('option');
                opt.value = key;

                // Create display label: RO# - Year Make Model - Date
                const parts = [];
                if (form.roNumber) parts.push('RO: ' + form.roNumber);
                if (form.year || form.make || form.model) {
                    parts.push([form.year, form.make, form.model].filter(Boolean).join(' '));
                }
                if (form.savedAt) {
                    const date = new Date(form.savedAt);
                    parts.push(date.toLocaleDateString());
                }

                opt.text = parts.length > 0 ? parts.join(' ‚Ä¢ ') : key;
                dropdown.add(opt);
            });
        }

        function saveCurrentForm() {
            // Get RO number as the primary identifier
            const roNumber = document.getElementById('roNumber').value.trim();

            if (!roNumber) {
                showToast('Please enter an RO# to save the form', 'error');
                document.getElementById('roNumber').focus();
                return;
            }

            // Collect all form data
            const formData = collectFormData();
            formData.savedAt = Date.now();

            // Add photos to saved data
            formData.photos = selectedPhotos;

            // Get existing forms and add/update this one
            const forms = getSavedForms();
            const key = 'form_' + roNumber;

            const isUpdate = forms[key] !== undefined;
            forms[key] = formData;

            try {
                setSavedForms(forms);

                // Refresh dropdown and select this form
                loadSavedFormsList();
                document.getElementById('savedFormsDropdown').value = key;

                showToast(isUpdate ? '‚úÖ Form updated successfully!' : '‚úÖ Form saved successfully!', 'success');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ö†Ô∏è Storage full! Photos may be too large.', 'error');
                } else {
                    showToast('‚ùå Save failed: ' + e.message, 'error');
                }
            }
        }

        function collectFormData() {
            const data = {};

            // Collect header inputs (outside of form)
            data.roNumber = document.getElementById('roNumber').value;
            data.estimator = document.getElementById('estimator').value;

            // Collect all form inputs
            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                if (el.type === 'checkbox') {
                    data[el.name] = el.checked;
                } else if (el.type === 'radio') {
                    if (el.checked) data[el.name] = el.value;
                } else {
                    data[el.name] = el.value;
                }
            });

            // Also collect standalone IDs that might not have name attributes
            const standaloneIds = ['insuranceCompany', 'claimNumber', 'year', 'make', 'model',
                'odometer', 'location', 'vin', 'color', 'notes', 'status'];
            standaloneIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && !data[id]) {
                    data[id] = el.value;
                }
            });

            return data;
        }

        function loadSavedForm() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const key = dropdown.value;

            if (!key) return; // No selection

            const forms = getSavedForms();
            const formData = forms[key];

            if (!formData) {
                showToast('Form not found', 'error');
                return;
            }

            // Restore header inputs
            if (formData.roNumber) document.getElementById('roNumber').value = formData.roNumber;
            if (formData.estimator) document.getElementById('estimator').value = formData.estimator;

            // Restore form data
            Object.keys(formData).forEach(name => {
                if (name === 'savedAt' || name === 'roNumber' || name === 'estimator') return;

                // Try by name first
                const elsByName = document.getElementsByName(name);
                if (elsByName.length > 0) {
                    const el = elsByName[0];
                    if (el.type === 'checkbox') {
                        el.checked = formData[name];
                        // Handle "Done" toggles visual state
                        if (name.endsWith('_done')) {
                            const box = el.closest('.panel-box');
                            if (box) {
                                if (el.checked) box.classList.add('is-complete');
                                else box.classList.remove('is-complete');
                            }
                        }
                    } else if (el.type === 'radio') {
                        if (el.value === formData[name]) el.checked = true;
                    } else {
                        el.value = formData[name];
                    }
                } else {
                    // Try by ID
                    const elById = document.getElementById(name);
                    if (elById) {
                        elById.value = formData[name];
                    }
                }
            });

            // Restore photos
            if (formData.photos && Array.isArray(formData.photos)) {
                selectedPhotos = formData.photos;
                renderPreviews();
            } else {
                selectedPhotos = [];
                renderPreviews();
            }

            // Update VIN counter
            updateVinCounter();

            // Update summary stats
            updateSummary();

            // Also save to draft so auto-save continues
            saveDraft();

            showToast('üìÇ Form loaded successfully!', 'success');
        }

        function deleteSavedForm() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const key = dropdown.value;

            if (!key) {
                showToast('Please select a form to delete', 'error');
                return;
            }

            const forms = getSavedForms();
            const formData = forms[key];
            const displayName = formData?.roNumber ? `RO: ${formData.roNumber}` : key;

            if (confirm(`Are you sure you want to delete "${displayName}"?\n\nThis cannot be undone.`)) {
                delete forms[key];
                setSavedForms(forms);
                loadSavedFormsList();
                showToast('üóëÔ∏è Form deleted', 'success');
            }
        }

        function startNewForm() {
            if (confirm('Start a new blank form?\n\nMake sure you\'ve saved your current work.')) {
                // Reset form
                document.getElementById('scopeForm').reset();
                document.getElementById('roNumber').value = '';
                document.getElementById('estimator').value = '';

                // Reset dropdown selection
                document.getElementById('savedFormsDropdown').value = '';

                // Reset photos
                selectedPhotos = [];
                renderPreviews();

                // Clear panel complete states
                document.querySelectorAll('.panel-box.is-complete').forEach(box => {
                    box.classList.remove('is-complete');
                });

                // Update UI
                updateVinCounter();
                updateSummary();

                // Clear draft
                localStorage.removeItem(DRAFT_KEY);

                showToast('üìù New form started', 'success');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function loadDropdowns() {
            // Populate Year (back to 1960)
            const yearSelect = document.getElementById('year');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= 1960; i--) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                yearSelect.add(opt);
            }

            // Populate basic Makes (can expand later)
            const makes = ["Ford", "Chevy", "Dodge/Ram", "Toyota", "Honda", "Nissan", "Hyundai/Kia", "BMW", "Mercedes", "Audi", "VW", "Tesla", "Subaru", "Other"];
            const makeSelect = document.getElementById('make');
            makes.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.text = m;
                makeSelect.add(opt);
            });
            // Locations
            const locs = ["Progressive Cat Drive", "Shop", "Mobile", "Dealership", "Auction"];
            const locSelect = document.getElementById('location');
            locs.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.text = l;
                locSelect.add(opt);
            });

            // Insurance
            const ins = ["State Farm", "Geico", "Progressive", "Allstate", "Liberty Mutual", "Farmers", "Nationwide", "USAA", "Other"];
            const insSelect = document.getElementById('insuranceCompany');
            ins.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                insSelect.add(opt);
            });
        }

        // --- VIN LOGIC ---
        let lastDecodedVin = '';
        let vinDecodeTimeout = null;

        function updateVinCounter() {
            const vinInput = document.getElementById('vin');
            const vin = vinInput.value.toUpperCase();

            // Auto-uppercase while typing
            if (vinInput.value !== vin) {
                vinInput.value = vin;
            }

            // Update counter display
            const counter = document.getElementById('vinCounter');
            counter.textContent = `${vin.length}/17`;

            // Update counter styling
            if (vin.length === 17 && /^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                counter.classList.add('valid');
                counter.classList.remove('invalid');

                // Auto-decode if this is a new valid VIN
                if (vin !== lastDecodedVin) {
                    // Debounce to avoid rapid API calls while typing
                    clearTimeout(vinDecodeTimeout);
                    vinDecodeTimeout = setTimeout(() => {
                        lastDecodedVin = vin;
                        decodeVin(vin);
                    }, 500);
                }
            } else if (vin.length > 0) {
                counter.classList.remove('valid');
                counter.classList.add('invalid');
            } else {
                counter.classList.remove('valid', 'invalid');
            }
        }

        // --- PHOTO LOGIC ---
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        // --- INITIALIZATION ---
        // Convert DC to range buttons, OS to steppers, add UPD toggles
        const DC_RANGES = ['1-5', '6-15', '16-30', '31-50', '51-75', '76-100', '101-150', '151-200', '201-300', '301-400'];
        const COIN_SIZES = ['dime', 'nickel', 'quarter', 'half'];
        const COIN_LABELS = { dime: 'Dime', nickel: 'Nickel', quarter: 'Quarter', half: 'Half $' };

        // ==================== DENT WIZARD MATRIX PRICING ====================
        // Prices by panel type, then by DC range, then by coin size
        // Format: PANEL_PRICES[panelType][dcRange][coinSize] = price
        const PANEL_PRICES = {
            hood: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 125, nickel: 150, quarter: 175, half: 240 },
                '16-30': { dime: 175, nickel: 200, quarter: 250, half: 300 },
                '31-50': { dime: 225, nickel: 275, quarter: 325, half: 400 },
                '51-75': { dime: 300, nickel: 350, quarter: 425, half: 500 },
                '76-100': { dime: 375, nickel: 450, quarter: 550, half: 650 },
                '101-150': { dime: 475, nickel: 550, quarter: 650, half: 800 },
                '151-200': { dime: 550, nickel: 650, quarter: 775, half: 950 },
                '201-300': { dime: 625, nickel: 750, quarter: 900, half: 1100 },
                '301-400': { dime: 700, nickel: 850, quarter: 1000, half: 1250 }
            },
            roof: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 175, nickel: 225, quarter: 295, half: 400 },
                '16-30': { dime: 225, nickel: 300, quarter: 375, half: 475 },
                '31-50': { dime: 300, nickel: 400, quarter: 475, half: 575 },
                '51-75': { dime: 375, nickel: 500, quarter: 600, half: 700 },
                '76-100': { dime: 475, nickel: 600, quarter: 725, half: 850 },
                '101-150': { dime: 600, nickel: 750, quarter: 900, half: 1050 },
                '151-200': { dime: 750, nickel: 950, quarter: 1100, half: 1300 },
                '201-300': { dime: 900, nickel: 1100, quarter: 1300, half: 1500 },
                '301-400': { dime: 1050, nickel: 1250, quarter: 1500, half: 1750 }
            },
            fender: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 175 },
                '6-15': { dime: 100, nickel: 125, quarter: 175, half: 225 },
                '16-30': { dime: 150, nickel: 200, quarter: 250, half: 325 },
                '31-50': { dime: 200, nickel: 275, quarter: 350, half: 425 },
                '51-75': { dime: 275, nickel: 350, quarter: 450, half: 550 },
                '76-100': { dime: 350, nickel: 450, quarter: 550, half: 675 },
                '101-150': { dime: 450, nickel: 575, quarter: 700, half: 850 },
                '151-200': { dime: 575, nickel: 725, quarter: 875, half: 1050 },
                '201-300': { dime: 700, nickel: 875, quarter: 1050, half: 1250 },
                '301-400': { dime: 825, nickel: 1025, quarter: 1225, half: 1450 }
            },
            door: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 150 },
                '6-15': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '16-30': { dime: 125, nickel: 175, quarter: 225, half: 275 },
                '31-50': { dime: 175, nickel: 225, quarter: 300, half: 375 },
                '51-75': { dime: 225, nickel: 300, quarter: 400, half: 475 },
                '76-100': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '101-150': { dime: 400, nickel: 500, quarter: 625, half: 750 },
                '151-200': { dime: 500, nickel: 625, quarter: 775, half: 925 },
                '201-300': { dime: 600, nickel: 750, quarter: 925, half: 1100 },
                '301-400': { dime: 700, nickel: 875, quarter: 1075, half: 1275 }
            },
            quarter: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 175 },
                '6-15': { dime: 125, nickel: 150, quarter: 175, half: 225 },
                '16-30': { dime: 175, nickel: 225, quarter: 275, half: 350 },
                '31-50': { dime: 225, nickel: 300, quarter: 375, half: 475 },
                '51-75': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '76-100': { dime: 400, nickel: 525, quarter: 650, half: 775 },
                '101-150': { dime: 525, nickel: 675, quarter: 825, half: 1000 },
                '151-200': { dime: 650, nickel: 825, quarter: 1000, half: 1200 },
                '201-300': { dime: 775, nickel: 975, quarter: 1175, half: 1400 },
                '301-400': { dime: 900, nickel: 1125, quarter: 1350, half: 1600 }
            },
            decklid: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 175 },
                '6-15': { dime: 100, nickel: 150, quarter: 200, half: 250 },
                '16-30': { dime: 175, nickel: 250, quarter: 325, half: 400 },
                '31-50': { dime: 250, nickel: 350, quarter: 450, half: 550 },
                '51-75': { dime: 325, nickel: 450, quarter: 575, half: 700 },
                '76-100': { dime: 400, nickel: 550, quarter: 700, half: 850 },
                '101-150': { dime: 500, nickel: 675, quarter: 850, half: 1025 },
                '151-200': { dime: 600, nickel: 800, quarter: 1000, half: 1200 },
                '201-300': { dime: 700, nickel: 925, quarter: 1150, half: 1375 },
                '301-400': { dime: 800, nickel: 1050, quarter: 1300, half: 1550 }
            },
            cab: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 150 },
                '6-15': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '16-30': { dime: 125, nickel: 175, quarter: 225, half: 275 },
                '31-50': { dime: 175, nickel: 225, quarter: 300, half: 375 },
                '51-75': { dime: 225, nickel: 300, quarter: 400, half: 475 },
                '76-100': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '101-150': { dime: 400, nickel: 500, quarter: 625, half: 750 },
                '151-200': { dime: 500, nickel: 625, quarter: 775, half: 925 },
                '201-300': { dime: 600, nickel: 750, quarter: 925, half: 1100 },
                '301-400': { dime: 700, nickel: 875, quarter: 1075, half: 1275 }
            },
            bedside: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 125, nickel: 175, quarter: 225, half: 300 },
                '16-30': { dime: 200, nickel: 275, quarter: 350, half: 450 },
                '31-50': { dime: 275, nickel: 375, quarter: 475, half: 600 },
                '51-75': { dime: 375, nickel: 500, quarter: 625, half: 775 },
                '76-100': { dime: 475, nickel: 625, quarter: 775, half: 950 },
                '101-150': { dime: 600, nickel: 775, quarter: 975, half: 1175 },
                '151-200': { dime: 725, nickel: 925, quarter: 1150, half: 1400 },
                '201-300': { dime: 850, nickel: 1075, quarter: 1325, half: 1625 },
                '301-400': { dime: 975, nickel: 1225, quarter: 1500, half: 1850 }
            }
        };

        // Map panel names to pricing categories
        const PANEL_CATEGORY = {
            'l_fender': 'fender', 'r_fender': 'fender',
            'hood': 'hood',
            'roof': 'roof', 'cowl': 'roof',
            'l_front_door': 'door', 'r_front_door': 'door',
            'l_rear_door': 'door', 'r_rear_door': 'door',
            'l_quarter': 'quarter', 'r_quarter': 'quarter',
            'decklid': 'decklid', 'tailgate': 'decklid',
            'l_cab': 'cab', 'r_cab': 'cab',
            'l_bedside': 'bedside', 'r_bedside': 'bedside'
        };

        // Pricing constants
        const OS_PRICE = 50;  // Oversized dent
        const DOS_PRICE = 100; // Double oversized dent
        let showPricing = true;


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.panel-ratings input[type="text"]').forEach(input => {
                const name = input.name;
                const parentLabel = input.closest('label');
                if (!parentLabel) return;

                if (name.endsWith('_dc')) {
                    // Convert DC to range buttons + coin size selector
                    const panelKey = name.replace('_dc', '');
                    const wrapper = document.createElement('div');
                    wrapper.className = 'dc-range-ui';
                    wrapper.innerHTML = `
                        <span class="dc-range-label">Dent Count</span>
                        <div class="dc-range-buttons">
                            ${DC_RANGES.map(range => `
                                <button type="button" class="dc-range-btn" data-range="${range}" data-input="${name}">${range}</button>
                            `).join('')}
                        </div>
                        <input type="hidden" name="${name}" value="">
                        <span class="dc-range-label" style="margin-top: 8px;">Coin Size</span>
                        <div class="coin-size-buttons">
                            ${COIN_SIZES.map(size => `
                                <button type="button" class="coin-btn" data-size="${size}" data-panel="${panelKey}">${COIN_LABELS[size]}</button>
                            `).join('')}
                        </div>
                        <input type="hidden" name="${panelKey}_coin" value="">
                    `;

                    // Add click handlers for DC range
                    wrapper.querySelectorAll('.dc-range-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Deselect siblings
                            wrapper.querySelectorAll('.dc-range-btn').forEach(b => b.classList.remove('selected'));
                            // Select this one
                            btn.classList.add('selected');
                            // Update hidden input
                            wrapper.querySelector(`input[name="${name}"]`).value = btn.dataset.range;
                            // Trigger save and update
                            updateSummary();
                            calculateEstimate();
                            saveDraft();
                        });
                    });

                    // Add click handlers for Coin Size
                    wrapper.querySelectorAll('.coin-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Deselect siblings
                            wrapper.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('selected'));
                            // Select this one
                            btn.classList.add('selected');
                            // Update hidden input
                            wrapper.querySelector(`input[name="${panelKey}_coin"]`).value = btn.dataset.size;
                            // Trigger update
                            calculateEstimate();
                            saveDraft();
                        });
                    });

                    parentLabel.parentNode.insertBefore(wrapper, parentLabel);
                    parentLabel.remove();

                } else if (name.endsWith('_os')) {
                    // Keep OS as stepper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'stepper-ui';
                    wrapper.innerHTML = `
                        <span class="st-label">OS</span>
                        <button type="button" class="st-btn" onclick="adjustStepper('${name}', -1)">‚àí</button>
                    `;
                    input.classList.add('st-input');
                    wrapper.appendChild(input);

                    const plusBtn = document.createElement('button');
                    plusBtn.type = 'button';
                    plusBtn.className = 'st-btn';
                    plusBtn.innerHTML = '+';
                    plusBtn.onclick = function () { adjustStepper(name, 1); };
                    wrapper.appendChild(plusBtn);

                    parentLabel.parentNode.insertBefore(wrapper, parentLabel);
                    parentLabel.remove();
                }
            });

            // Camera handler
            document.getElementById('cameraInput').addEventListener('change', handlePhotoSelect);

            // Inject "Done" and "UPD" Toggles
            initPanelToggles();

            // Initialize Auto-Save
            initAutoSave();
        });

        function initPanelToggles() {
            document.querySelectorAll('.panel-box').forEach(box => {
                const header = box.querySelector('.panel-header');
                if (!header) return;

                // Derive a unique name for this panel
                const refInput = box.querySelector('input[name]');
                let baseName = "panel";
                if (refInput) {
                    const match = refInput.name.match(/^(.+?)_/);
                    if (match) baseName = match[1];
                }
                const doneName = baseName + "_done";
                const updName = baseName + "_upd";
                const updNotesName = baseName + "_upd_notes";

                // Create Done Toggle
                const doneLabel = document.createElement('label');
                doneLabel.className = 'panel-done-toggle';
                doneLabel.innerHTML = `<input type="checkbox" name="${doneName}" class="done-chk"> Done`;

                const doneChk = doneLabel.querySelector('input');
                doneChk.addEventListener('change', () => {
                    if (doneChk.checked) box.classList.add('is-complete');
                    else box.classList.remove('is-complete');
                    saveDraft();
                });
                header.appendChild(doneLabel);

                // Create UPD Toggle + Notes (at end of panel)
                const updContainer = document.createElement('div');
                updContainer.className = 'upd-container';
                updContainer.innerHTML = `
                    <label class="upd-toggle">
                        <input type="checkbox" name="${updName}">
                        <span>‚ö†Ô∏è UPD (Unrelated Prior Damage)</span>
                    </label>
                    <div class="upd-notes">
                        <textarea name="${updNotesName}" placeholder="Describe the unrelated prior damage..."></textarea>
                    </div>
                `;

                const updChk = updContainer.querySelector('input[type="checkbox"]');
                const updNotes = updContainer.querySelector('.upd-notes');
                const updToggle = updContainer.querySelector('.upd-toggle');

                updChk.addEventListener('change', () => {
                    if (updChk.checked) {
                        box.classList.add('has-upd');
                        updToggle.classList.add('active');
                        updNotes.classList.add('visible');
                    } else {
                        box.classList.remove('has-upd');
                        updToggle.classList.remove('active');
                        updNotes.classList.remove('visible');
                    }
                    saveDraft();
                });

                box.appendChild(updContainer);
            });
        }

        // --- AUTO-SAVE & SUMMARY ---
        const DRAFT_KEY = 'dent_pro_scope_draft';

        function initAutoSave() {
            // Restore if exists
            const saved = localStorage.getItem(DRAFT_KEY);
            if (saved) {
                try {
                    restoreDraft(JSON.parse(saved));
                    console.log('Draft restored');
                } catch (e) {
                    console.error('Error restoring draft', e);
                }
            }
            updateSummary();

            // Listeners for form inputs
            document.getElementById('scopeForm').addEventListener('input', () => {
                saveDraft();
                updateSummary();
            });
            document.getElementById('scopeForm').addEventListener('change', () => {
                saveDraft();
                updateSummary();
            });

            // Add explicit listeners to ALL checkboxes for real-time R&I/R&R updates
            document.querySelectorAll('#scopeForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSummary();
                    saveDraft();
                });
            });
        }

        function saveDraft() {
            const data = {};
            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                if (el.type === 'checkbox') data[el.name] = el.checked;
                else data[el.name] = el.value;
            });
            // Also save header inputs not in form
            const headerIds = ['roNumber', 'estimator', 'insuredName'];
            headerIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) data[id] = el.value;
            });
            localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
            // Show save status briefly
            const statusBox = document.getElementById('saveStatusBox');
            const statusEl = document.getElementById('saveStatus');
            if (statusBox && statusEl) {
                statusBox.style.display = 'flex';
                statusEl.textContent = '‚úì Saved';
                setTimeout(() => {
                    statusBox.style.display = 'none';
                }, 1500);
            }
        }

        function restoreDraft(data) {
            Object.keys(data).forEach(name => {
                const els = document.getElementsByName(name);
                if (els.length > 0) {
                    const el = els[0];
                    if (el.type === 'checkbox') {
                        el.checked = data[name];
                        // Handle Done toggle visual state
                        if (name.endsWith('_done')) {
                            const box = el.closest('.panel-box');
                            if (box && el.checked) box.classList.add('is-complete');
                        }
                        // Handle UPD toggle visual state
                        if (name.endsWith('_upd')) {
                            const box = el.closest('.panel-box');
                            const updToggle = el.closest('.upd-toggle');
                            const updNotes = box?.querySelector('.upd-notes');
                            if (el.checked) {
                                box?.classList.add('has-upd');
                                updToggle?.classList.add('active');
                                updNotes?.classList.add('visible');
                            }
                        }
                    } else if (el.type === 'hidden' && name.endsWith('_dc')) {
                        // Restore range button selection
                        el.value = data[name];
                        const wrapper = el.closest('.dc-range-ui');
                        if (wrapper && data[name]) {
                            const btn = wrapper.querySelector(`[data-range="${data[name]}"]`);
                            if (btn) btn.classList.add('selected');
                        }
                    } else {
                        el.value = data[name];
                    }
                }
                // Restore header inputs by ID
                const elById = document.getElementById(name);
                if (elById && !els.length) {
                    elById.value = data[name];
                }
            });
        }


        function updateSummary() {
            let panelsWithDamage = 0;
            let totalOs = 0;
            let totalRi = 0;
            let totalRr = 0;

            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                const name = el.name;

                // Count R&I checkboxes
                if (el.type === 'checkbox' && name.includes('_ri_') && el.checked) {
                    totalRi++;
                    return;
                }

                // Count R&R checkboxes
                if (el.type === 'checkbox' && name.includes('_rr_') && el.checked) {
                    totalRr++;
                    return;
                }

                // Count panels with DC range selected
                if (el.type === 'hidden' && name.endsWith('_dc') && el.value) {
                    panelsWithDamage++;
                }

                // Sum Oversized values
                if (name.endsWith('_os') && el.value) {
                    totalOs += parseInt(el.value) || 0;
                }
            });

            // Update UI - use panelsWithDamage as the "Dent Count" display showing # of panels
            document.getElementById('liveDentCount').textContent = panelsWithDamage;
            document.getElementById('liveOsCount').textContent = totalOs;
            document.getElementById('liveRiCount').textContent = totalRi;
            document.getElementById('liveRrCount').textContent = totalRr;
        }

        // ==================== PRICING CALCULATOR ====================
        function calculateEstimate() {
            let totalEstimate = 0;

            // Get all panels with DC selected
            document.querySelectorAll('#scopeForm input[type="hidden"][name$="_dc"]').forEach(dcInput => {
                const dcRange = dcInput.value;
                if (!dcRange) return;

                // Get panel name and coin size
                const panelKey = dcInput.name.replace('_dc', '');
                const coinInput = document.querySelector(`input[name="${panelKey}_coin"]`);
                const coinSize = coinInput?.value || 'quarter'; // Default to quarter if not selected

                // Get OS count
                const osInput = document.querySelector(`input[name="${panelKey}_os"]`);
                const osCount = parseInt(osInput?.value) || 0;

                // Look up base price
                const category = PANEL_CATEGORY[panelKey] || 'door';
                const priceTable = PANEL_PRICES[category];

                if (priceTable && priceTable[dcRange] && priceTable[dcRange][coinSize]) {
                    const basePrice = priceTable[dcRange][coinSize];
                    totalEstimate += basePrice;
                }

                // Add OS pricing
                totalEstimate += osCount * OS_PRICE;
            });

            // Update display
            const estimateEl = document.getElementById('estimateTotal');
            if (estimateEl) {
                estimateEl.textContent = '$' + totalEstimate.toLocaleString();
            }
        }

        function toggleEstimate() {
            const bar = document.getElementById('estimateBar');
            const btn = bar.querySelector('.estimate-toggle');

            if (bar.classList.contains('hidden')) {
                bar.classList.remove('hidden');
                btn.textContent = 'üëÅÔ∏è Hide';
            } else {
                bar.classList.add('hidden');
                btn.textContent = 'üëÅÔ∏è Show';
            }
        }

        // NOTE: PRICING moved to DENT WIZARD MATRIX approach (see PANEL_PRICES above)

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            document.getElementById('scopeForm').reset();
            updateSummary();
            // Reset steppers visual? They read input value, so reset() works?
            // Yes, input value becomes "" or default.
            // But we might need to manually set steppers to 0 if reset doesn't trigger 'input' event?
            // Steppers read `input.value`. If `reset()` clears it, the `adjustStepper` reads it next time.
            // But the Visual `input` needs to update? Browser handles reset of inputs. Smart.
        }

        function adjustStepper(name, delta) {
            const input = document.querySelector(`input[name="${name}"]`);
            if (input) {
                let val = parseInt(input.value) || 0;
                val += delta;
                if (val < 0) val = 0;
                input.value = val;

                // Trigger real-time update of stats
                updateSummary();
                calculateEstimate();
                saveDraft();
            }
        }

        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            files.forEach(file => {
                compressImage(file, (compressedBase64, mimeType) => {
                    selectedPhotos.push({
                        base64Data: compressedBase64,
                        mimeType: mimeType,
                        name: file.name
                    });
                    renderPreviews();
                });
            });
            event.target.value = ''; // Reset input
        }

        function renderPreviews() {
            const container = document.getElementById('photoPreviews');
            container.innerHTML = '';
            selectedPhotos.forEach((photo, idx) => {
                const div = document.createElement('div');
                div.className = 'photo-preview';
                div.style.cssText = `
                    width: 80px; height: 100px; position: relative; border-radius: 6px; overflow: hidden; border: 1px solid #444; background: #000;
                    display: inline-block; margin-right: 8px; margin-bottom: 8px;
                `;
                const displayName = photo.label || '';
                div.innerHTML = `
                    <img src="data:${photo.mimeType};base64,${photo.base64Data}" style="width:100%; height:80px; object-fit:cover;">
                    <button onclick="removePhoto(${idx})" style="
                        position: absolute; top: 2px; right: 2px; background: rgba(255,69,58,0.9); color: #fff; border: none; width: 18px; height: 18px; cursor: pointer; font-size: 12px; line-height: 1; border-radius: 50%;
                    ">√ó</button>
                    <input type="text" class="photo-name-input" placeholder="Add label..." value="${displayName}" onchange="updatePhotoName(${idx}, this.value)" onclick="event.stopPropagation()">
                `;
                container.appendChild(div);
            });
            saveDraft();
        }

        function updatePhotoName(index, name) {
            if (selectedPhotos[index]) {
                selectedPhotos[index].label = name;
                saveDraft();
            }
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            renderPreviews();
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_SIZE = 1200;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl.split(',')[1], 'image/jpeg');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- UI HELPER FUNCTIONS ---
        function scrollToPanel(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a flash effect
                el.style.transition = 'box-shadow 0.3s ease';
                el.style.boxShadow = '0 0 20px #4CD964';
                setTimeout(() => {
                    el.style.boxShadow = '';
                }, 1000);
            }
        }

        // --- SUBMISSION LOGIC ---
        function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;

            // Validate Basics
            const roNumber = document.getElementById('roNumber').value;
            if (!roNumber) {
                alert('RO Number is required');
                submitBtn.textContent = 'Submit Scope'; submitBtn.disabled = false;
                return;
            }

            // Photos
            if (selectedPhotos.length > 0) {
                google.script.run
                    .withSuccessHandler((photoUrls) => {
                        // photoUrls is an array of strings
                        submitData(photoUrls);
                    })
                    .withFailureHandler(err => {
                        alert('Photo upload failed: ' + err);
                        submitBtn.textContent = 'Submit Scope'; submitBtn.disabled = false;
                    })
                    .uploadMultiplePhotos(selectedPhotos, roNumber);
            } else {
                // Return empty array if no photos
                submitData([]);
            }
        }

        // ==================== iOS NATIVE FEATURES ====================

        // Haptic feedback (iOS Safari)
        function haptic(style = 'light') {
            if ('vibrate' in navigator) {
                navigator.vibrate(style === 'heavy' ? 50 : 10);
            }
        }

        // Copy VIN to clipboard
        async function copyVin() {
            const vin = document.getElementById('vin').value.trim().toUpperCase();
            if (!vin) {
                showToast('Enter a VIN first', 'error');
                return;
            }
            try {
                await navigator.clipboard.writeText(vin);
                haptic();
                showToast('VIN copied: ' + vin, 'success');
            } catch (e) {
                // Fallback for older iOS
                const input = document.getElementById('vin');
                input.select();
                document.execCommand('copy');
                showToast('VIN copied!', 'success');
            }
        }

        // ==================== EXPORT TO CSV ====================
        function exportToCSV() {
            haptic();

            const formData = collectFormData();
            const vin = formData.vin || 'Unknown';
            const roNum = formData.roNumber || 'Unknown';
            const vehicle = `${formData.year || ''} ${formData.make || ''} ${formData.model || ''}`.trim() || 'Unknown';

            // CSV Headers
            let csv = 'Panel,Dent Count,Coin Size,Oversized,R&I Parts,R&R Parts,Price,UPD,Notes\n';

            // Panel mapping for display names
            const PANEL_NAMES = {
                'l_fender': 'Left Fender', 'r_fender': 'Right Fender',
                'hood': 'Hood', 'roof': 'Roof', 'cowl': 'Cowl',
                'l_front_door': 'Left Front Door', 'r_front_door': 'Right Front Door',
                'l_rear_door': 'Left Rear Door', 'r_rear_door': 'Right Rear Door',
                'l_quarter': 'Left Quarter', 'r_quarter': 'Right Quarter',
                'decklid': 'Decklid', 'tailgate': 'Tailgate',
                'l_cab': 'Left Cab Corner', 'r_cab': 'Right Cab Corner',
                'l_bedside': 'Left Bedside', 'r_bedside': 'Right Bedside'
            };

            let totalEstimate = 0;

            // Collect panel data
            document.querySelectorAll('#scopeForm input[type="hidden"][name$="_dc"]').forEach(dcInput => {
                const dcRange = dcInput.value;
                if (!dcRange) return;

                const panelKey = dcInput.name.replace('_dc', '');
                const panelName = PANEL_NAMES[panelKey] || panelKey;

                // Get coin size
                const coinInput = document.querySelector(`input[name="${panelKey}_coin"]`);
                const coinSize = coinInput?.value || 'quarter';
                const coinLabel = COIN_LABELS[coinSize] || coinSize;

                // Get OS count
                const osInput = document.querySelector(`input[name="${panelKey}_os"]`);
                const osCount = parseInt(osInput?.value) || 0;

                // Count R&I parts for this panel
                let riCount = 0;
                document.querySelectorAll(`input[name*="${panelKey}_ri_"]`).forEach(cb => {
                    if (cb.checked) riCount++;
                });

                // Count R&R parts for this panel
                let rrCount = 0;
                document.querySelectorAll(`input[name*="${panelKey}_rr_"]`).forEach(cb => {
                    if (cb.checked) rrCount++;
                });

                // Get UPD status
                const updInput = document.querySelector(`input[name="${panelKey}_upd"]`);
                const hasUpd = updInput?.checked ? 'Yes' : 'No';

                // Get UPD notes
                const notesInput = document.querySelector(`textarea[name="${panelKey}_upd_notes"]`);
                const notes = (notesInput?.value || '').replace(/"/g, '""').replace(/\n/g, ' ');

                // Calculate price
                const category = PANEL_CATEGORY[panelKey] || 'door';
                const priceTable = PANEL_PRICES[category];
                let price = 0;
                if (priceTable && priceTable[dcRange] && priceTable[dcRange][coinSize]) {
                    price = priceTable[dcRange][coinSize];
                }
                price += osCount * OS_PRICE;
                totalEstimate += price;

                // Add CSV row
                csv += `"${panelName}","${dcRange}","${coinLabel}",${osCount},${riCount},${rrCount},$${price},"${hasUpd}","${notes}"\n`;
            });

            // Add summary row
            csv += `\n"TOTAL ESTIMATE",,,,,,"$${totalEstimate.toLocaleString()}",,\n`;
            csv += `\n"Vehicle Info:","${vehicle}"\n`;
            csv += `"VIN:","${vin}"\n`;
            csv += `"RO#:","${roNum}"\n`;
            csv += `"Date:","${new Date().toLocaleDateString()}"\n`;

            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `PDR_Scope_${roNum}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast('üìä CSV exported!', 'success');
        }

        // Native iOS Share Sheet
        async function nativeShare() {
            haptic('heavy');

            const formData = collectFormData();
            const roNum = formData.roNumber || 'Unknown';
            const vehicle = [formData.year, formData.make, formData.model].filter(Boolean).join(' ') || 'Vehicle';

            // Build text summary
            let summary = `üöó PDR Scope - RO# ${roNum}\n`;
            summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            summary += `üìã ${vehicle}\n`;
            summary += `VIN: ${formData.vin || 'N/A'}\n`;
            summary += `Carrier: ${formData.insuranceCompany || 'N/A'}\n`;
            summary += `Claim: ${formData.claimNumber || 'N/A'}\n`;
            summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;

            // Add panel damage summary
            let panelCount = 0;
            let totalOS = 0;
            document.querySelectorAll('.panel-box').forEach(box => {
                const dcInput = box.querySelector('input[name$="_dc"]');
                const osInput = box.querySelector('input[name$="_os"]');
                const dcVal = dcInput ? dcInput.value : '';
                const osVal = osInput ? parseInt(osInput.value) || 0 : 0;
                if (dcVal) {
                    const panelName = box.querySelector('.panel-header')?.textContent?.trim() || 'Panel';
                    summary += `‚Ä¢ ${panelName}: ${dcVal} dents`;
                    if (osVal > 0) summary += ` (${osVal} OS)`;
                    summary += '\n';
                    panelCount++;
                    totalOS += osVal;
                }
            });

            if (panelCount > 0) {
                summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                summary += `üìä ${panelCount} panels with damage\n`;
                if (totalOS > 0) summary += `‚ö†Ô∏è ${totalOS} oversized dents\n`;
            }

            // Add notes if any
            const notes = document.getElementById('notes')?.value?.trim();
            if (notes) {
                summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                summary += `üìù Notes: ${notes}\n`;
            }

            // Check if Web Share API is available
            if (navigator.share) {
                try {
                    // Try to share with files (photos) - iOS 15+
                    const shareData = {
                        title: `PDR Scope - RO# ${roNum}`,
                        text: summary
                    };

                    // Add photos if available and supported
                    if (selectedPhotos.length > 0 && navigator.canShare) {
                        const files = [];
                        for (let i = 0; i < selectedPhotos.length; i++) {
                            const photo = selectedPhotos[i];
                            const blob = base64ToBlob(photo.base64Data, photo.mimeType);
                            const fileName = photo.label || `photo_${i + 1}`;
                            files.push(new File([blob], `${fileName}.jpg`, { type: photo.mimeType }));
                        }

                        if (navigator.canShare({ files })) {
                            shareData.files = files;
                        }
                    }

                    await navigator.share(shareData);
                    showToast('Shared successfully!', 'success');
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        // User didn't cancel, show fallback
                        fallbackShare(summary);
                    }
                }
            } else {
                // Fallback for older browsers
                fallbackShare(summary);
            }
        }

        // Fallback: Copy to clipboard
        function fallbackShare(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Scope copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Could not share', 'error');
            });
        }

        // Helper: Convert base64 to Blob
        function base64ToBlob(base64, mimeType) {
            const byteChars = atob(base64);
            const byteNumbers = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) {
                byteNumbers[i] = byteChars.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // 2. Submit Data Function
        function submitData(photoUrls) {
            const submitBtn = document.getElementById('submitBtn'); // Get button reference here
            // updateStatus('Saving data...'); // Assuming updateStatus is defined elsewhere or removed

            // Base Data
            const rawData = {
                roNumber: document.getElementById('roNumber').value,
                vin: document.getElementById('vin').value.toUpperCase(),
                year: document.getElementById('year').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                color: document.getElementById('color').value,
                insurance: document.getElementById('insuranceCompany').value, // Corrected ID
                claimNumber: document.getElementById('claimNumber').value,
                location: document.getElementById('location').value,
                // scoper: document.getElementById('scoper').value, // Not in original form
                estimator: document.getElementById('estimator').value,
                // severity: severityRadio.value, // Not in original form
                // panelCount: document.getElementById('panelCount').value, // Not in original form
                notes: document.getElementById('notes').value,
                status: document.getElementById('status').value,
                photoUrls: photoUrls
            };

            // Collect and Bundle Panel Data
            const checklistBundles = {}; // { 'lf_fender_ri': ['Lamp', 'Liner'] }

            // Scan all inputs with names
            document.querySelectorAll('#scopeForm [name]').forEach(input => {
                const name = input.name;
                let value = input.value;

                if (input.type === 'checkbox') {
                    if (!input.checked) return; // Skip unchecked
                    value = 'Yes';

                    // Check for R&I / R&R Pattern: {panel}_{ri|rr}_{part}
                    // Regex: matches anything ending in _ri_{part} or _rr_{part}
                    // We want to capture the panel name and the type.
                    const match = name.match(/^(.+)_(ri|rr)_(.+)$/);
                    if (match) {
                        const panel = match[1];
                        const type = match[2]; // ri or rr
                        const part = match[3];
                        // Create bundle key: lf_fender_ri
                        const bundleKey = `${panel}_${type}`;

                        if (!checklistBundles[bundleKey]) checklistBundles[bundleKey] = [];
                        // Add part name (Capitalized)
                        checklistBundles[bundleKey].push(part.charAt(0).toUpperCase() + part.slice(1));
                        return; // handled
                    }

                    // Other checkboxes (General flags?)
                    rawData[name] = 'Yes';
                } else if (input.type === 'radio') {
                    if (input.checked) rawData[name] = value;
                } else {
                    // Text/Number inputs
                    rawData[name] = value;
                }
            });

            // Merge Bundles into Raw Data
            Object.keys(checklistBundles).forEach(key => {
                rawData[key] = checklistBundles[key].join(', ');
            });

            // Submit to Apps Script
            google.script.run
                .withSuccessHandler(function (result) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Submit Scope';

                    // Assuming 'result' from Apps Script indicates success/failure
                    if (result && result.success) {
                        document.getElementById('successModal').style.display = 'flex'; // Use style.display for visibility
                        clearDraft(); // Clear local storage on success
                    } else {
                        alert('Error: ' + (result ? (result.error || 'Unknown error') : 'Unknown error from server'));
                    }
                })
                .withFailureHandler(function (error) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Submit Scope';
                    alert('Error submitting form: ' + error.message);
                })
                .saveToSheet(rawData);
        }

        function resetForm() {
            document.getElementById('scopeForm').reset();
            selectedPhotos = [];
            renderPreviews();
            document.getElementById('successModal').style.display = 'none';
        }

        // ==================== VIN BARCODE SCANNER ====================
        let scannerActive = false;

        function startScanner() {
            const modal = document.getElementById('scannerModal');
            const status = document.getElementById('scannerStatus');
            modal.style.display = 'flex';
            scannerActive = true;
            status.textContent = 'Initializing camera...';
            status.className = 'scanner-status';

            // Check if Quagga is available
            if (typeof Quagga === 'undefined') {
                status.textContent = 'Scanner library not loaded. Using manual entry.';
                status.className = 'scanner-status error';
                return;
            }

            Quagga.init({
                inputStream: {
                    name: 'Live',
                    type: 'LiveStream',
                    target: document.getElementById('scannerCamera'),
                    constraints: {
                        facingMode: 'environment',
                        width: { min: 640, ideal: 1920, max: 1920 },
                        height: { min: 480, ideal: 1080, max: 1080 },
                        aspectRatio: { min: 1, max: 2 }
                    },
                    area: {
                        top: "20%",
                        right: "10%",
                        left: "10%",
                        bottom: "20%"
                    }
                },
                frequency: 10, // Scan 10 times per second
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: {
                    readers: [
                        'code_39_reader',
                        'code_128_reader',
                        'code_39_vin_reader',
                        'ean_reader',
                        'ean_8_reader',
                        'i2of5_reader'
                    ],
                    multiple: false
                },
                locate: true,
                locator: {
                    halfSample: false,
                    patchSize: 'large'
                },
                debug: {
                    drawBoundingBox: true,
                    showFrequency: true,
                    drawScanline: true,
                    showPattern: true
                }
            }, function (err) {
                if (err) {
                    console.error('[Scanner] Init error:', err);
                    status.textContent = 'Camera error: ' + (err.message || err.name || 'Unknown');
                    status.className = 'scanner-status error';
                    return;
                }
                console.log('[Scanner] Quagga initialized successfully');
                status.textContent = 'üì° Scanning... Point at VIN barcode';
                Quagga.start();
            });

            // Process every frame for debugging
            Quagga.onProcessed(function (result) {
                if (result && result.codeResult) {
                    console.log('[Scanner] Processing:', result.codeResult.code, 'Format:', result.codeResult.format);
                }
            });

            Quagga.onDetected(onBarcodeDetected);
        }

        function onBarcodeDetected(result) {
            const code = result.codeResult.code;
            console.log('[Scanner] Detected:', code);

            // VINs are 17 characters, alphanumeric
            if (code && code.length >= 17) {
                const vin = code.substring(0, 17).toUpperCase();
                // Validate VIN format (no I, O, Q)
                if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                    haptic('heavy');
                    closeScanner();
                    document.getElementById('vin').value = vin;
                    updateVinCounter();
                    decodeVin(vin);
                    return;
                }
            }

            // Check if it's a partial match
            if (code && code.length >= 10) {
                document.getElementById('scannerStatus').textContent = 'Partial read: ' + code + ' (need 17 chars)';
            }
        }

        function closeScanner() {
            const modal = document.getElementById('scannerModal');
            modal.style.display = 'none';
            scannerActive = false;

            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.offDetected(onBarcodeDetected);
                    Quagga.stop();
                } catch (e) {
                    console.log('[Scanner] Stop error:', e);
                }
            }
        }

        function toggleScannerTips() {
            const content = document.getElementById('tipsContent');
            const arrow = document.getElementById('tipsArrow');
            content.classList.toggle('expanded');
            arrow.classList.toggle('expanded');
        }

        function manualVinEntry() {
            closeScanner();
            document.getElementById('vin').focus();
            showToast('üí° Type VIN - auto-lookup will find Year/Make/Model', 'info');
        }

        // NHTSA VIN Decoder API (Free)
        async function decodeVin(vin) {
            // Track this VIN to prevent duplicate lookups
            lastDecodedVin = vin;

            const status = document.getElementById('scannerStatus');
            showToast('üîç Looking up vehicle...', 'info');

            try {
                const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
                const data = await response.json();

                if (data.Results && data.Results.length > 0) {
                    const vehicle = data.Results[0];

                    // Log full response for debugging
                    console.log('[VIN Decode] Full response:', vehicle);

                    // Extract values with fallbacks
                    const year = vehicle.ModelYear || '';
                    const make = vehicle.Make || '';
                    // Model has fallbacks: Model -> Series -> Trim -> BodyClass
                    let model = vehicle.Model || vehicle.Series || vehicle.Trim || '';
                    const bodyClass = vehicle.BodyClass || '';

                    // If still no model but we have body class, use it
                    if (!model && bodyClass) {
                        model = bodyClass;
                    }

                    // Auto-fill Year
                    if (year) {
                        const yearSelect = document.getElementById('year');
                        for (let i = 0; i < yearSelect.options.length; i++) {
                            if (yearSelect.options[i].value === year) {
                                yearSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    // Auto-fill Make
                    if (make) {
                        const makeSelect = document.getElementById('make');
                        // Try to find exact match (case-insensitive)
                        let found = false;
                        const makeLower = make.toLowerCase();
                        for (let i = 0; i < makeSelect.options.length; i++) {
                            if (makeSelect.options[i].value.toLowerCase() === makeLower ||
                                makeSelect.options[i].textContent.toLowerCase() === makeLower) {
                                makeSelect.selectedIndex = i;
                                found = true;
                                break;
                            }
                        }
                        // If not found, add it as new option
                        if (!found && make) {
                            const opt = document.createElement('option');
                            // Capitalize properly
                            const formattedMake = make.charAt(0).toUpperCase() + make.slice(1).toLowerCase();
                            opt.value = formattedMake;
                            opt.textContent = formattedMake;
                            makeSelect.appendChild(opt);
                            makeSelect.value = formattedMake;
                        }
                    }

                    // Auto-fill Model
                    if (model) {
                        document.getElementById('model').value = model;
                    }

                    haptic();

                    // Show appropriate success message
                    if (year && make && model) {
                        showToast(`‚úÖ ${year} ${make} ${model}`, 'success');
                    } else if (year && make) {
                        showToast(`‚úÖ ${year} ${make} (model not in database)`, 'success');
                    } else {
                        showToast(`‚ö†Ô∏è Partial data: ${year || 'No year'} ${make || 'No make'}`, 'error');
                    }

                    saveDraft();
                } else {
                    showToast('‚ö†Ô∏è VIN not found in database', 'error');
                }
            } catch (e) {
                console.error('[VIN Decode] Error:', e);
                showToast('‚ö†Ô∏è Could not decode VIN - check connection', 'error');
            }
        }


        // ==================== APP BUTTON (Install/Update) ====================
        const LOCAL_APP_VERSION = '2026.01.18.3';
        let deferredInstallPrompt = null;
        let appButtonState = 'checking'; // checking, install, update, current

        // Capture the install prompt before it's shown
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            console.log('[PWA] Install prompt captured');
            // If we're still checking, this means we can show install
            if (appButtonState === 'checking' || appButtonState === 'current') {
                setAppButtonState('install');
            }
        });

        function setAppButtonState(state) {
            appButtonState = state;
            const btn = document.getElementById('appBtn');
            if (!btn) return;

            // Remove all state classes
            btn.classList.remove('state-checking', 'state-install', 'state-update', 'state-current');

            switch (state) {
                case 'checking':
                    btn.classList.add('state-checking');
                    btn.innerHTML = '‚è≥ Checking...';
                    break;
                case 'install':
                    btn.classList.add('state-install');
                    btn.innerHTML = 'üì• Install App';
                    break;
                case 'update':
                    btn.classList.add('state-update');
                    btn.innerHTML = 'üîÑ Update Available';
                    break;
                case 'current':
                    btn.classList.add('state-current');
                    btn.innerHTML = '‚úì v' + LOCAL_APP_VERSION;
                    break;
            }
        }

        async function checkForUpdates() {
            try {
                const response = await fetch('version.json?t=' + Date.now(), { cache: 'no-store' });
                if (!response.ok) {
                    setAppButtonState('current');
                    return;
                }

                const data = await response.json();
                const serverVersion = data.version;

                console.log('[Version Check] Local:', LOCAL_APP_VERSION, 'Server:', serverVersion);

                if (serverVersion && serverVersion !== LOCAL_APP_VERSION) {
                    setAppButtonState('update');
                } else if (deferredInstallPrompt) {
                    setAppButtonState('install');
                } else {
                    setAppButtonState('current');
                }
            } catch (err) {
                console.log('[Version Check] Error:', err.message);
                setAppButtonState('current');
            }
        }

        async function handleAppButton() {
            const btn = document.getElementById('appBtn');

            if (appButtonState === 'install' && deferredInstallPrompt) {
                // Trigger PWA install
                deferredInstallPrompt.prompt();
                const { outcome } = await deferredInstallPrompt.userChoice;
                console.log('[PWA] Install outcome:', outcome);
                deferredInstallPrompt = null;
                if (outcome === 'accepted') {
                    setAppButtonState('current');
                }
            } else if (appButtonState === 'update') {
                // Clear cache and reload
                if (btn) {
                    btn.innerHTML = '‚è≥ Updating...';
                    btn.disabled = true;
                }

                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }

                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));

                    console.log('[Update] Caches cleared, reloading...');
                    window.location.reload(true);
                } catch (err) {
                    console.error('[Update] Error:', err);
                    alert('Update failed. Please clear your browser cache manually.');
                    setAppButtonState('update');
                }
            }
            // If state is 'current' or 'checking', button does nothing
        }

        // Check for updates on page load
        window.addEventListener('load', () => {
            setTimeout(checkForUpdates, 1500);
        });
    </script>
</body>

</html>