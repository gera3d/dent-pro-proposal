<!DOCTYPE html>
<html>

<head>
    <!-- Build Version: 2026-01-24 T17:55:00 - PDF Photo Pages + Airtable Integration -->
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google Vision OCR for VIN text recognition -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Hide scrollbar for iOS PWA feel */
        ::-webkit-scrollbar {
            display: none;
        }

        html {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            color: #fff;
            padding: 16px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 24px 0;
            margin-bottom: 24px;
        }

        .logo {
            margin-bottom: 4px;
        }

        .logo img {
            height: 60px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .subtitle {
            color: #a1a1a6;
            font-size: 14px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #4CD964;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            color: #a1a1a6;
            margin-bottom: 6px;
            font-weight: 500;
        }

        label .required {
            color: #FF453A;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
        }

        input::placeholder,
        textarea::placeholder {
            color: #666;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #fff;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .checkbox-item.selected {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 8px;
            accent-color: #4CD964;
        }

        .checkbox-item span {
            font-size: 13px;
            color: #e0e0e0;
        }

        /* Rating Scale Styles */
        .rating-scale {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rating-option {
            flex: 1;
            min-width: calc(33% - 8px);
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rating-option.selected {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .rating-option input {
            display: none;
        }

        .rating-option span {
            font-size: 13px;
            font-weight: 500;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            gap: 16px;
        }

        .toggle-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .toggle-item.active {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #4CD964;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Severity Pills */
        .severity-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .severity-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .severity-option:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .severity-option.selected {
            border-color: var(--severity-color);
            background: rgba(var(--severity-rgb), 0.15);
        }

        .severity-option input {
            display: none;
        }

        .severity-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .severity-option.light .severity-dot {
            background: #30D158;
        }

        .severity-option.moderate .severity-dot {
            background: #FF9F0A;
        }

        .severity-option.heavy .severity-dot {
            background: #FF453A;
        }

        .severity-option.total .severity-dot {
            background: #8E8E93;
        }

        .severity-option.light.selected {
            --severity-color: #30D158;
            --severity-rgb: 48, 209, 88;
        }

        .severity-option.moderate.selected {
            --severity-color: #FF9F0A;
            --severity-rgb: 255, 159, 10;
        }

        .severity-option.heavy.selected {
            --severity-color: #FF453A;
            --severity-rgb: 255, 69, 58;
        }

        .severity-option.total.selected {
            --severity-color: #8E8E93;
            --severity-rgb: 142, 142, 147;
        }

        /* Submit Button */
        .submit-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to top, rgba(10, 10, 10, 1) 0%, rgba(10, 10, 10, 0.95) 80%, transparent 100%);
        }

        .submit-btn button {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: block;
            padding: 18px 32px;
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            border: none;
            border-radius: 14px;
            color: #000;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .submit-btn button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(76, 217, 100, 0.3);
        }

        .submit-btn button:active {
            transform: translateY(0);
        }

        .submit-btn button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Validation Error Styles */
        .validation-error {
            border-color: #FF453A !important;
            background: rgba(255, 69, 58, 0.1) !important;
            animation: shake 0.4s ease-in-out;
        }

        .validation-error-label {
            color: #FF453A !important;
        }

        .validation-hint {
            font-size: 11px;
            color: #FF9F0A;
            margin-top: 4px;
            display: none;
        }

        .validation-hint.show {
            display: block;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-5px);
            }

            40%,
            80% {
                transform: translateX(5px);
            }
        }

        /* Success Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            max-width: 360px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .modal h2 {
            margin-bottom: 8px;
            font-size: 22px;
        }

        .modal p {
            color: #a1a1a6;
            margin-bottom: 24px;
        }

        .modal button {
            padding: 14px 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* VIN Counter */
        .vin-counter {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }

        .vin-counter.valid {
            color: #4CD964;
        }

        .vin-counter.invalid {
            color: #FF453A;
        }

        /* Photo Upload Styles */
        .photo-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .photo-upload-area:hover {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.05);
        }

        .photo-upload-area.dragover {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
        }

        .photo-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .photo-upload-text {
            color: #a1a1a6;
            font-size: 14px;
        }

        .photo-upload-text strong {
            color: #4CD964;
        }

        .photo-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .photo-btn {
            flex: 1;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .photo-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        .photo-btn:active {
            transform: scale(0.98);
        }

        .photo-btn.camera {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.25) 0%, rgba(0, 122, 255, 0.15) 100%);
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 2px 12px rgba(0, 122, 255, 0.2);
        }

        .photo-btn.camera:hover {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.35) 0%, rgba(0, 122, 255, 0.25) 100%);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        .photo-previews {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(255, 69, 58, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-preview .upload-status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 10px;
            text-align: center;
        }

        .photo-preview .upload-status.uploading {
            color: #FF9F0A;
        }

        .photo-preview .upload-status.uploaded {
            color: #4CD964;
        }

        .photo-preview .upload-status.error {
            color: #FF453A;
        }

        .photo-count {
            font-size: 12px;
            color: #a1a1a6;
            margin-top: 8px;
            text-align: center;
        }

        .photo-name-input {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 6px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: #fff;
            font-size: 10px;
            text-align: center;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .photo-name-input::placeholder {
            color: #888;
        }

        .photo-name-input:focus {
            outline: none;
            background: rgba(0, 122, 255, 0.3);
        }

        /* Photo Upload Status */
        .photo-upload-status {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(76, 217, 100, 0.3);
        }

        .upload-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CD964, #34C759);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .photo-upload-status p {
            font-size: 12px;
            color: #a1a1a6;
            text-align: center;
            margin: 0;
        }

        .photo-count-display {
            margin-top: 8px;
            font-size: 12px;
            color: #4CD964;
            text-align: center;
        }

        /* SAVED FORMS BAR */
        .saved-forms-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .saved-forms-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .saved-forms-left label {
            font-size: 13px;
            font-weight: 600;
            color: #a1a1a6;
            white-space: nowrap;
            margin: 0;
        }

        .saved-forms-select {
            flex: 1;
            min-width: 150px;
            padding: 10px 36px 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 18px;
            cursor: pointer;
        }

        .saved-forms-select:focus {
            outline: none;
            border-color: #007AFF;
            background-color: rgba(0, 122, 255, 0.1);
        }

        .saved-forms-select option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        .saved-forms-actions {
            display: flex;
            gap: 8px;
        }

        .saved-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            white-space: nowrap;
        }

        .saved-btn.save {
            background: rgba(0, 122, 255, 0.2);
            color: #007AFF;
            border: 1px solid rgba(0, 122, 255, 0.3);
        }

        .saved-btn.save:hover {
            background: rgba(0, 122, 255, 0.3);
        }

        .saved-btn.delete {
            background: rgba(255, 69, 58, 0.15);
            color: #FF453A;
            border: 1px solid rgba(255, 69, 58, 0.25);
        }

        .saved-btn.delete:hover {
            background: rgba(255, 69, 58, 0.25);
        }

        .saved-btn.new {
            background: rgba(76, 217, 100, 0.15);
            color: #4CD964;
            border: 1px solid rgba(76, 217, 100, 0.25);
        }

        .saved-btn.new:hover {
            background: rgba(76, 217, 100, 0.25);
        }

        /* VIN Scan Section */
        .vin-scan-section {
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border: 2px solid rgba(76, 217, 100, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .vin-scan-content h2 {
            font-size: 22px;
            font-weight: 700;
            color: #4CD964;
            margin-bottom: 8px;
        }

        .vin-scan-content p {
            font-size: 14px;
            color: #a1a1a6;
            margin-bottom: 20px;
        }

        .vin-scan-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 18px 36px;
            background: linear-gradient(135deg, #4CD964 0%, #34C759 100%);
            border: none;
            border-radius: 14px;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 6px 20px rgba(76, 217, 100, 0.4);
            transition: all 0.2s;
            margin-right: 12px;
        }

        .vin-scan-btn:active {
            transform: scale(0.98);
        }

        .vin-manual-btn {
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            color: #a1a1a6;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .vin-manual-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .vin-scan-progress {
            margin-top: 20px;
            padding: 20px;
        }

        .vin-progress-bar {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto 12px;
        }

        .vin-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4CD964, #30D158);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .vin-scan-progress p {
            color: #a1a1a6;
            font-size: 14px;
            margin: 0;
        }

        .vin-scan-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .vin-scan-result h3 {
            font-size: 18px;
            color: #4CD964;
            margin-bottom: 16px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: left;
        }

        .result-item.filled {
            border-left: 3px solid #4CD964;
        }

        .result-item.missing {
            border-left: 3px solid #FF9500;
        }

        .result-item .label {
            font-size: 11px;
            color: #a1a1a6;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .result-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .auto-filled {
            border: 1px solid #4CD964 !important;
            background-color: rgba(76, 217, 100, 0.1) !important;
            box-shadow: 0 0 10px rgba(76, 217, 100, 0.2);
            transition: all 0.3s ease;
        }

        .result-item.missing .value {
            color: #FF9500;
        }

        .vin-continue-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: rgba(76, 217, 100, 0.5);
        }

        .toast.error {
            border-color: rgba(255, 69, 58, 0.5);
        }

        /* VIN Scanner Modal */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 10001;
            display: flex;
            flex-direction: column;
        }

        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.9);
        }

        .scanner-header h3 {
            margin: 0;
            color: #fff;
            font-size: 18px;
        }

        .scanner-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .scanner-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #111;
        }

        #scannerCamera {
            width: 100%;
            height: 100%;
        }

        #scannerCamera video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-guide {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .guide-box {
            width: 80%;
            height: 80px;
            border: 3px solid #4CD964;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .guide-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4CD964, transparent);
            animation: scanLine 1.5s ease-in-out infinite;
        }

        @keyframes scanLine {

            0%,
            100% {
                top: 0;
                opacity: 0.5;
            }

            50% {
                top: calc(100% - 3px);
                opacity: 1;
            }
        }

        .scanner-guide p {
            color: #fff;
            margin-top: 16px;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .scanner-status {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #a1a1a6;
            font-size: 14px;
            text-align: center;
        }

        .scanner-status.success {
            color: #4CD964;
        }

        .scanner-status.error {
            color: #FF453A;
        }

        /* Scanner Tips */
        .scanner-tips {
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tips-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            color: #FFD60A;
            font-size: 14px;
            font-weight: 500;
        }

        .tips-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tips-arrow {
            transition: transform 0.3s ease;
        }

        .tips-arrow.expanded {
            transform: rotate(180deg);
        }

        .tips-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 20px;
        }

        .tips-content.expanded {
            max-height: 300px;
            padding: 0 20px 16px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #a1a1a6;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tip-item:last-child {
            border-bottom: none;
        }

        .tip-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        /* Scanner Tabs */
        .scanner-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scanner-tab {
            flex: 1;
            padding: 14px;
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .scanner-tab.active {
            color: #4CD964;
            border-bottom-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
        }

        .scanner-view {
            display: none;
        }

        .scanner-view.active {
            display: block;
        }

        /* OCR Capture Area */
        .ocr-capture-area {
            padding: 20px;
            background: #111;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .ocr-preview {
            width: 100%;
            max-width: 300px;
            height: 180px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .ocr-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ocr-placeholder {
            text-align: center;
            color: #666;
        }

        .ocr-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 12px;
        }

        .ocr-placeholder p {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ocr-placeholder small {
            font-size: 12px;
            opacity: 0.7;
        }

        .ocr-capture-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #4CD964 0%, #34C759 100%);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(76, 217, 100, 0.4);
            transition: all 0.2s;
        }

        .ocr-capture-btn:active {
            transform: scale(0.98);
        }

        /* OCR Progress */
        .ocr-progress {
            padding: 20px;
            background: #111;
            text-align: center;
        }

        .ocr-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .ocr-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4CD964, #30D158);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .ocr-progress p {
            color: #a1a1a6;
            font-size: 14px;
        }

        .scanner-actions {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.9);
        }

        .scanner-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .scanner-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .scanner-btn.manual {
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
            color: #fff;
        }

        @media (max-width: 500px) {
            .saved-forms-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .saved-forms-left {
                flex-direction: column;
                align-items: stretch;
            }

            .saved-forms-actions {
                justify-content: stretch;
            }

            .saved-btn {
                flex: 1;
            }
        }

        /* PDF Export Styles */
        .export-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-options {
            margin-bottom: 16px;
        }

        .export-checkbox {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .export-checkbox:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .export-checkbox.selected {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
        }

        .export-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #4CD964;
            cursor: pointer;
        }

        .export-checkbox label {
            margin: 0;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
        }

        .photo-mode-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .photo-mode-option {
            flex: 1;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #a1a1a6;
        }

        .photo-mode-option:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .photo-mode-option.active {
            background: rgba(76, 217, 100, 0.15);
            border-color: #4CD964;
            color: #4CD964;
        }

        .export-btn {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        /* Airtable Upload Button */
        .export-btn.airtable-btn {
            background: linear-gradient(135deg, #18BFFF 0%, #2D7FF9 100%);
            margin-top: 10px;
        }

        .export-btn.airtable-btn:hover {
            box-shadow: 0 8px 24px rgba(24, 191, 255, 0.3);
        }

        /* Hidden PDF Template */
        #pdfTemplate {
            position: fixed;
            left: -99999px;
            width: 612px;
            height: 792px;
            background: white;
            padding: 36px;
            font-family: Arial, sans-serif;
            font-size: 9pt;
            color: black;
            overflow: hidden;
        }

        #pdfTemplate h1 {
            margin: 0;
            font-size: 18pt;
            color: #000;
        }

        #pdfTemplate h3 {
            margin: 0 0 6px 0;
            font-size: 10pt;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }

        #pdfTemplate table {
            width: 100%;
            border-collapse: collapse;
            font-size: 7pt;
        }

        #pdfTemplate th,
        #pdfTemplate td {
            border: 1px solid #ccc;
            padding: 3px;
        }

        #pdfTemplate th {
            background: #f0f0f0;
            font-weight: bold;
        }
    </style>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- ZIP Compression Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- NEW HEADER DESIGN (Split Layout) -->
        <div class="brand-bar">
            <div class="logo"><img src="logo.webp" alt="Dent Experts Logo"></div>
            <div class="brand-bar-right">
                <button id="appBtn" class="app-btn state-checking" onclick="handleAppButton()">
                    ‚è≥ Checking...
                </button>
                <a href="Option_B_Custom_WebApp/Training_Guide.html" class="help-link">üìñ Training Guide &
                    Terminology</a>
            </div>
        </div>

        <!-- SAVED FORMS SECTION -->
        <div class="saved-forms-bar">
            <div class="saved-forms-left">
                <label>üìÇ Saved Forms</label>
                <select id="savedFormsDropdown" class="saved-forms-select" onchange="loadSavedForm()">
                    <option value="">-- Select Saved Form --</option>
                </select>
            </div>
            <div class="saved-forms-actions">
                <button type="button" class="saved-btn save" onclick="saveCurrentForm()">üíæ Save</button>
                <button type="button" class="saved-btn delete" onclick="deleteSavedForm()">üóëÔ∏è Delete</button>
                <button type="button" class="saved-btn new" onclick="startNewForm()">‚ûï New</button>
            </div>
        </div>

        <!-- VIN SCAN TO START Section -->
        <div class="vin-scan-section">
            <div class="vin-scan-content">
                <h2>üì∏ Scan VIN to Start</h2>
                <p>Take a photo of the VIN sticker to auto-fill vehicle info</p>
                <input type="file" id="vinCameraInput" accept="image/*" capture="environment" style="display: none;"
                    onchange="handleVinScan(event)">
                <button type="button" class="vin-scan-btn" onclick="document.getElementById('vinCameraInput').click()">
                    üì∑ Take Photo of VIN
                </button>
                <button type="button" class="vin-manual-btn" onclick="skipVinScan()">
                    ‚úçÔ∏è Enter Manually
                </button>
            </div>
            <!-- OCR Progress -->
            <div class="vin-scan-progress" id="vinScanProgress" style="display: none;">
                <div class="vin-progress-bar">
                    <div class="vin-progress-fill" id="vinProgressFill"></div>
                </div>
                <p id="vinProgressText">Processing...</p>
            </div>
            <!-- Result Summary -->
            <div class="vin-scan-result" id="vinScanResult" style="display: none;">
                <h3>üöó Vehicle Found</h3>
                <div class="result-grid" id="resultGrid"></div>
                <button type="button" class="vin-continue-btn" onclick="continueToForm()">
                    ‚úÖ Continue to Form
                </button>
            </div>
        </div>

        <div class="action-toolbar">
            <div class="meta-group">
                <label>RO#</label>
                <input type="text" id="roNumber" class="toolbar-input" required placeholder="e.g. 10452">
            </div>
            <div class="meta-group">
                <label>Estimator</label>
                <select id="estimator" class="toolbar-input">
                    <option value="">Select</option>
                    <option value="Oleg">Oleg</option>
                    <option value="Gera">Gera</option>
                    <option value="John">John</option>
                    <option value="Jane">Jane</option>
                </select>
            </div>
            <div class="meta-group">
                <label>Pipeline</label>
                <select id="pipelineSelect" class="toolbar-input">
                    <option value="production">Repair Tracker</option>
                    <option value="expert_path">Expert Path</option>
                </select>
            </div>
        </div>

        <form id="scopeForm">
            <!-- GENERAL INFORMATION (Compact Grid) -->
            <!-- GENERAL INFORMATION (Pro Grid) -->
            <div class="general-info-grid">
                <div class="info-group col-span-2">
                    <label>Insured (Customer Name)</label>
                    <input type="text" id="insuredName" required placeholder="Customer's full name">
                </div>
                <div class="info-group col-span-1">
                    <label id="emailLabel">Customer Email <span class="required">*</span></label>
                    <input type="email" id="customerEmail" placeholder="email@example.com">
                    <div id="emailHint" class="validation-hint">üìß Email or phone required for GHL</div>
                </div>
                <div class="info-group col-span-1">
                    <label id="phoneLabel">Customer Phone <span class="required">*</span></label>
                    <input type="tel" id="customerPhone" placeholder="(555) 123-4567">
                    <div id="phoneHint" class="validation-hint">üì± Email or phone required for GHL</div>
                </div>
                <div class="info-group col-span-2">
                    <label>Carrier</label>
                    <select id="insuranceCompany" required>
                        <option value="">Select Insurance</option>
                    </select>
                </div>
                <div class="info-group col-span-2">
                    <label>Claim #</label>
                    <input type="text" id="claimNumber" required placeholder="e.g. 123-456-789">
                </div>


                <div class="info-group col-span-2">
                    <label>Year / Make / Model</label>
                    <div class="ymb-row">
                        <select id="year" style="width: 80px">
                            <option value="">Year</option>
                        </select>
                        <select id="make" style="flex:1">
                            <option value="">Make</option>
                        </select>
                        <input type="text" id="model" placeholder="Model (e.g. F-150)" style="flex:1">
                    </div>
                </div>

                <div class="info-group col-span-1">
                    <label>Odometer</label>
                    <input type="text" id="odometer" placeholder="e.g. 45,200">
                </div>

                <div class="info-group col-span-1">
                    <label>Location</label>
                    <select id="location">
                        <option value="">Select Location</option>
                    </select>
                </div>

                <div class="info-group col-span-2">
                    <label>VIN # <span id="vinCounter" class="vin-counter">0/17</span></label>
                    <div class="vin-row">
                        <input type="text" id="vin" maxlength="17" oninput="updateVinCounter()"
                            placeholder="17 Characters">
                        <button type="button" class="scan-btn" onclick="copyVin()" title="Copy VIN">üìã</button>
                        <button type="button" class="scan-btn" onclick="startScanner()" title="Scan VIN">üì∑</button>
                    </div>
                </div>

                <div class="info-group col-span-2">
                    <label>Color / Trim</label>
                    <input type="text" id="color" placeholder="e.g. Pearl White / LX">
                </div>
            </div>

            <!-- VEHICLE DAMAGE ASSESSMENT (Visual Grid) -->
            <div class="damage-grid-container">
                <div class="grid-header">Vehicle Damage Assessment</div>

                <div class="visual-grid">
                    <!-- LEFT COLUMN -->
                    <div class="side-column" id="col_left">
                        <!-- Left Fender -->
                        <div class="panel-box">
                            <div class="panel-header">Left Fender</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('lf_fender_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="lf_fender_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('lf_fender_dc', 1)">+</button>
                                        <input type="hidden" name="lf_fender_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="lf_fender_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lf_fender', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('lf_fender', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('lf_fender', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lf_fender', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="lf_fender_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('lf_fender_os', -1)">-</button>
                                        <div class="stepper-value" id="lf_fender_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('lf_fender_os', 1)">+</button>
                                        <input type="hidden" name="lf_fender_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="lf_fender_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="lf_fender_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_emblem"></td>
                                    <td>Emblem</td>
                                    <td><input type="checkbox" name="lf_fender_rr_emblem"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_fender_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="lf_fender_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Front Door -->
                        <div class="panel-box">
                            <div class="panel-header">Left Front Door</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('lf_door_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="lf_door_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('lf_door_dc', 1)">+</button>
                                        <input type="hidden" name="lf_door_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="lf_door_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lf_door', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lf_door', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('lf_door', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lf_door', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="lf_door_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('lf_door_os', -1)">-</button>
                                        <div class="stepper-value" id="lf_door_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('lf_door_os', 1)">+</button>
                                        <input type="hidden" name="lf_door_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_mirror"></td>
                                    <td>Mirror</td>
                                    <td><input type="checkbox" name="lf_door_rr_mirror"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="lf_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="lf_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="lf_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="lf_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="lf_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lf_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="lf_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Rear Door -->
                        <div class="panel-box">
                            <div class="panel-header">Left Rear Door</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('lr_door_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="lr_door_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('lr_door_dc', 1)">+</button>
                                        <input type="hidden" name="lr_door_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="lr_door_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lr_door', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lr_door', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('lr_door', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('lr_door', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="lr_door_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('lr_door_os', -1)">-</button>
                                        <div class="stepper-value" id="lr_door_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('lr_door_os', 1)">+</button>
                                        <input type="hidden" name="lr_door_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="lr_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="lr_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="lr_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="lr_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="lr_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="lr_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Quarter -->
                        <div class="panel-box">
                            <div class="panel-header">Left Quarter/Bed</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('lr_quarter_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="lr_quarter_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('lr_quarter_dc', 1)">+</button>
                                        <input type="hidden" name="lr_quarter_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="lr_quarter_coin_wrapper">
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('lr_quarter', 'dime')" data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('lr_quarter', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('lr_quarter', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('lr_quarter', 'half')" data-size="half">Half $</button>
                                    <input type="hidden" name="lr_quarter_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('lr_quarter_os', -1)">-</button>
                                        <div class="stepper-value" id="lr_quarter_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('lr_quarter_os', 1)">+</button>
                                        <input type="hidden" name="lr_quarter_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_glass"></td>
                                    <td>Glass</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_glass"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="lr_quarter_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="lr_quarter_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Left Cab Corner (Ratings Only) -->
                        <div class="panel-box mini">
                            <div class="panel-header">Left Cab Corner</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('l_cab_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="l_cab_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('l_cab_dc', 1)">+</button>
                                        <input type="hidden" name="l_cab_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="l_cab_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('l_cab', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('l_cab', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('l_cab', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('l_cab', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="l_cab_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('l_cab_os', -1)">-</button>
                                        <div class="stepper-value" id="l_cab_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('l_cab_os', 1)">+</button>
                                        <input type="hidden" name="l_cab_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER COLUMN (Schematic + Top/Bottom Panels) -->
                    <div class="center-column">
                        <!-- Schematic Visualization (CSS Art or Image Placehoder) -->
                        <!-- Schematic Visualization -->
                        <!-- Schematic Visualization -->
                        <div class="car-schematic" style="text-align: center; margin-bottom: 20px; position: relative;">
                            <!-- Glow Effect -->
                            <div
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 300px; background: radial-gradient(closest-side, rgba(76, 217, 100, 0.15), transparent); pointer-events: none;">
                            </div>
                            <svg width="220" height="330" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg"
                                style="filter: drop-shadow(0 0 10px rgba(76,217,100,0.2));">
                                <style>
                                    .car-line {
                                        fill: none;
                                        stroke: #4CD964;
                                        stroke-width: 2;
                                    }

                                    .car-fill {
                                        fill: #222;
                                        transition: fill 0.3s;
                                    }

                                    .car-fill:hover {
                                        fill: #2a2a2a;
                                    }

                                    .glass {
                                        fill: #333;
                                        stroke: #4CD964;
                                        stroke-width: 1;
                                    }

                                    .click-zone {
                                        fill: transparent;
                                        cursor: pointer;
                                    }

                                    .click-zone:hover {
                                        fill: rgba(76, 217, 100, 0.1);
                                    }

                                    text {
                                        pointer-events: none;
                                        user-select: none;
                                    }
                                </style>

                                <!-- Body Structure -->
                                <path class="car-line car-fill"
                                    d="M40,60 C40,40 60,20 100,20 C140,20 160,40 160,60 L160,240 C160,260 140,280 100,280 C60,280 40,260 40,240 Z" />
                                <path class="glass" d="M45,80 L155,80 L150,110 L50,110 Z" />
                                <path class="glass" d="M45,220 L155,220 L150,190 L50,190 Z" />
                                <line x1="45" y1="110" x2="45" y2="190" stroke="#444" stroke-width="1" />
                                <line x1="155" y1="110" x2="155" y2="190" stroke="#444" stroke-width="1" />

                                <!-- Labels -->
                                <text x="100" y="55" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">HOOD</text>
                                <text x="100" y="150" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">ROOF</text>
                                <text x="100" y="250" fill="#666" font-size="10" text-anchor="middle"
                                    font-family="sans-serif">TRUNK</text>

                                <!-- Mirrors -->
                                <rect x="25" y="85" width="15" height="10" rx="2" fill="#444" />
                                <rect x="160" y="85" width="15" height="10" rx="2" fill="#444" />

                                <!-- INTERACTIVE ZONES -->
                                <rect x="0" y="0" width="40" height="300" class="click-zone"
                                    onclick="scrollToPanel('col_left')" title="Left Side Panels" />
                                <rect x="160" y="0" width="40" height="300" class="click-zone"
                                    onclick="scrollToPanel('col_right')" title="Right Side Panels" />
                                <rect x="40" y="0" width="120" height="100" class="click-zone"
                                    onclick="scrollToPanel('section_hood')" title="Front / Hood" />
                                <rect x="40" y="100" width="120" height="100" class="click-zone"
                                    onclick="scrollToPanel('section_roof')" title="Center / Roof" />
                                <rect x="40" y="200" width="120" height="120" class="click-zone"
                                    onclick="scrollToPanel('section_deck')" title="Rear / Trunk" />
                            </svg>
                        </div>

                        <!-- Hood/Windshield -->
                        <div class="panel-box" id="section_hood">
                            <div class="panel-header">Hood / Windshield</div>
                            <div class="panel-ratings">
                                <label>Hood DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('hood_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="hood_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('hood_dc', 1)">+</button>
                                        <input type="hidden" name="hood_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="hood_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('hood', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('hood', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('hood', 'quarter')" data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('hood', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="hood_coin" value="quarter">
                                </div>
                                <label>Hood OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('hood_os', -1)">-</button>
                                        <div class="stepper-value" id="hood_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('hood_os', 1)">+</button>
                                        <input type="hidden" name="hood_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_windshield"></td>
                                    <td>Windshield</td>
                                    <td><input type="checkbox" name="hood_rr_windshield"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_cowl"></td>
                                    <td>Cowl</td>
                                    <td><input type="checkbox" name="hood_rr_cowl"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="hood_ri_hood"></td>
                                    <td>Hood</td>
                                    <td><input type="checkbox" name="hood_rr_hood"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Roof -->
                        <div class="panel-box" id="section_roof">
                            <div class="panel-header">Roof</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('roof_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="roof_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('roof_dc', 1)">+</button>
                                        <input type="hidden" name="roof_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="roof_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('roof', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('roof', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('roof', 'quarter')" data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('roof', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="roof_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('roof_os', -1)">-</button>
                                        <div class="stepper-value" id="roof_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('roof_os', 1)">+</button>
                                        <input type="hidden" name="roof_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_hilamp"></td>
                                    <td>Hi-Mt Lamp</td>
                                    <td><input type="checkbox" name="roof_rr_hilamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_headliner"></td>
                                    <td>Headliner</td>
                                    <td><input type="checkbox" name="roof_rr_headliner"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_sunroof"></td>
                                    <td>Sunroof</td>
                                    <td><input type="checkbox" name="roof_rr_sunroof"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_l_mldg"></td>
                                    <td>L Roof Mldg</td>
                                    <td><input type="checkbox" name="roof_rr_l_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_r_mldg"></td>
                                    <td>R Roof Mldg</td>
                                    <td><input type="checkbox" name="roof_rr_r_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_rack"></td>
                                    <td>Roof Rack</td>
                                    <td><input type="checkbox" name="roof_rr_rack"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="roof_ri_ant"></td>
                                    <td>Antenna</td>
                                    <td><input type="checkbox" name="roof_rr_ant"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Rails -->
                        <div class="rails-row">
                            <div class="panel-box mini">
                                <div class="panel-header">Left Rail</div>
                                <div class="panel-ratings vertical">
                                    <label>DC:
                                        <div class="stepper-wrapper">
                                            <button type="button" class="stepper-btn minus"
                                                onclick="updateDentCount('l_rail_dc', -1)">-</button>
                                            <div class="stepper-value placeholder" id="l_rail_dc_display">0</div>
                                            <button type="button" class="stepper-btn plus"
                                                onclick="updateDentCount('l_rail_dc', 1)">+</button>
                                            <input type="hidden" name="l_rail_dc" value="" class="stepper-input">
                                        </div>
                                    </label>
                                    <div class="coin-selector disabled" id="l_rail_coin_wrapper">
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('l_rail', 'dime')" data-size="dime">Dime</button>
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('l_rail', 'nickel')"
                                            data-size="nickel">Nickel</button>
                                        <button type="button" class="coin-btn selected"
                                            onclick="updateCoinSize('l_rail', 'quarter')"
                                            data-size="quarter">Quarter</button>
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('l_rail', 'half')" data-size="half">Half $</button>
                                        <input type="hidden" name="l_rail_coin" value="quarter">
                                    </div>
                                    <label>OS:
                                        <div class="stepper-wrapper os-stepper">
                                            <button type="button" class="stepper-btn minus"
                                                onclick="updateOsCount('l_rail_os', -1)">-</button>
                                            <div class="stepper-value" id="l_rail_os_display">0</div>
                                            <button type="button" class="stepper-btn plus"
                                                onclick="updateOsCount('l_rail_os', 1)">+</button>
                                            <input type="hidden" name="l_rail_os" value="0" class="stepper-input">
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="panel-box mini">
                                <div class="panel-header">Right Rail</div>
                                <div class="panel-ratings vertical">
                                    <label>DC:
                                        <div class="stepper-wrapper">
                                            <button type="button" class="stepper-btn minus"
                                                onclick="updateDentCount('r_rail_dc', -1)">-</button>
                                            <div class="stepper-value placeholder" id="r_rail_dc_display">0</div>
                                            <button type="button" class="stepper-btn plus"
                                                onclick="updateDentCount('r_rail_dc', 1)">+</button>
                                            <input type="hidden" name="r_rail_dc" value="" class="stepper-input">
                                        </div>
                                    </label>
                                    <div class="coin-selector disabled" id="r_rail_coin_wrapper">
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('r_rail', 'dime')" data-size="dime">Dime</button>
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('r_rail', 'nickel')"
                                            data-size="nickel">Nickel</button>
                                        <button type="button" class="coin-btn selected"
                                            onclick="updateCoinSize('r_rail', 'quarter')"
                                            data-size="quarter">Quarter</button>
                                        <button type="button" class="coin-btn"
                                            onclick="updateCoinSize('r_rail', 'half')" data-size="half">Half $</button>
                                        <input type="hidden" name="r_rail_coin" value="quarter">
                                    </div>
                                    <label>OS:
                                        <div class="stepper-wrapper os-stepper">
                                            <button type="button" class="stepper-btn minus"
                                                onclick="updateOsCount('r_rail_os', -1)">-</button>
                                            <div class="stepper-value" id="r_rail_os_display">0</div>
                                            <button type="button" class="stepper-btn plus"
                                                onclick="updateOsCount('r_rail_os', 1)">+</button>
                                            <input type="hidden" name="r_rail_os" value="0" class="stepper-input">
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Deck/Lid -->
                        <div class="panel-box" id="section_deck">
                            <div class="panel-header">Deck / Lid / Gate</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('deck_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="deck_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('deck_dc', 1)">+</button>
                                        <input type="hidden" name="deck_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="deck_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('deck', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('deck', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('deck', 'quarter')" data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('deck', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="deck_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('deck_os', -1)">-</button>
                                        <div class="stepper-value" id="deck_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('deck_os', 1)">+</button>
                                        <input type="hidden" name="deck_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_llamp"></td>
                                    <td>L Lamp(s)</td>
                                    <td><input type="checkbox" name="deck_rr_llamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_rlamp"></td>
                                    <td>R Lamp(s)</td>
                                    <td><input type="checkbox" name="deck_rr_rlamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="deck_rr_handle"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_spoiler"></td>
                                    <td>Spoiler</td>
                                    <td><input type="checkbox" name="deck_rr_spoiler"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="deck_ri_ant"></td>
                                    <td>Antenna</td>
                                    <td><input type="checkbox" name="deck_rr_ant"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="side-column" id="col_right">
                        <!-- Right Fender -->
                        <div class="panel-box">
                            <div class="panel-header">Right Fender</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('rf_fender_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="rf_fender_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('rf_fender_dc', 1)">+</button>
                                        <input type="hidden" name="rf_fender_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="rf_fender_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rf_fender', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('rf_fender', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('rf_fender', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rf_fender', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="rf_fender_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('rf_fender_os', -1)">-</button>
                                        <div class="stepper-value" id="rf_fender_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('rf_fender_os', 1)">+</button>
                                        <input type="hidden" name="rf_fender_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="rf_fender_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="rf_fender_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_emblem"></td>
                                    <td>Emblem</td>
                                    <td><input type="checkbox" name="rf_fender_rr_emblem"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_fender_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="rf_fender_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Front Door -->
                        <div class="panel-box">
                            <div class="panel-header">Right Front Door</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('rf_door_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="rf_door_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('rf_door_dc', 1)">+</button>
                                        <input type="hidden" name="rf_door_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="rf_door_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rf_door', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rf_door', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('rf_door', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rf_door', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="rf_door_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('rf_door_os', -1)">-</button>
                                        <div class="stepper-value" id="rf_door_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('rf_door_os', 1)">+</button>
                                        <input type="hidden" name="rf_door_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_mirror"></td>
                                    <td>Mirror</td>
                                    <td><input type="checkbox" name="rf_door_rr_mirror"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="rf_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="rf_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="rf_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="rf_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="rf_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rf_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="rf_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Rear Door -->
                        <div class="panel-box">
                            <div class="panel-header">Right Rear Door</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('rr_door_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="rr_door_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('rr_door_dc', 1)">+</button>
                                        <input type="hidden" name="rr_door_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="rr_door_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rr_door', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rr_door', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('rr_door', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('rr_door', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="rr_door_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('rr_door_os', -1)">-</button>
                                        <div class="stepper-value" id="rr_door_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('rr_door_os', 1)">+</button>
                                        <input type="hidden" name="rr_door_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_uppermldg"></td>
                                    <td>Upper Mldg</td>
                                    <td><input type="checkbox" name="rr_door_rr_uppermldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_beltmldg"></td>
                                    <td>Belt Mldg</td>
                                    <td><input type="checkbox" name="rr_door_rr_beltmldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_applique"></td>
                                    <td>Applique</td>
                                    <td><input type="checkbox" name="rr_door_rr_applique"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_trim"></td>
                                    <td>Trim Panel</td>
                                    <td><input type="checkbox" name="rr_door_rr_trim"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_door"></td>
                                    <td>Door</td>
                                    <td><input type="checkbox" name="rr_door_rr_door"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_door_ri_handle"></td>
                                    <td>Handle</td>
                                    <td><input type="checkbox" name="rr_door_rr_handle"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Quarter -->
                        <div class="panel-box">
                            <div class="panel-header">Right Quarter/Bed</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('rr_quarter_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="rr_quarter_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('rr_quarter_dc', 1)">+</button>
                                        <input type="hidden" name="rr_quarter_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="rr_quarter_coin_wrapper">
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('rr_quarter', 'dime')" data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('rr_quarter', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('rr_quarter', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn"
                                        onclick="updateCoinSize('rr_quarter', 'half')" data-size="half">Half $</button>
                                    <input type="hidden" name="rr_quarter_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('rr_quarter_os', -1)">-</button>
                                        <div class="stepper-value" id="rr_quarter_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('rr_quarter_os', 1)">+</button>
                                        <input type="hidden" name="rr_quarter_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                            <table class="checklist-table">
                                <tr>
                                    <th>R&I</th>
                                    <th>Part</th>
                                    <th>R&R</th>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_lamp"></td>
                                    <td>Lamp(s)</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_lamp"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_mldg"></td>
                                    <td>Side Mldg</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_mldg"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_glass"></td>
                                    <td>Glass</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_glass"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" name="rr_quarter_ri_liner"></td>
                                    <td>Liner/Flare</td>
                                    <td><input type="checkbox" name="rr_quarter_rr_liner"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Right Cab Corner (Ratings Only) -->
                        <div class="panel-box mini">
                            <div class="panel-header">Right Cab Corner</div>
                            <div class="panel-ratings">
                                <label>DC:
                                    <div class="stepper-wrapper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateDentCount('r_cab_dc', -1)">-</button>
                                        <div class="stepper-value placeholder" id="r_cab_dc_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateDentCount('r_cab_dc', 1)">+</button>
                                        <input type="hidden" name="r_cab_dc" value="" class="stepper-input">
                                    </div>
                                </label>
                                <div class="coin-selector disabled" id="r_cab_coin_wrapper">
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('r_cab', 'dime')"
                                        data-size="dime">Dime</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('r_cab', 'nickel')"
                                        data-size="nickel">Nickel</button>
                                    <button type="button" class="coin-btn selected"
                                        onclick="updateCoinSize('r_cab', 'quarter')"
                                        data-size="quarter">Quarter</button>
                                    <button type="button" class="coin-btn" onclick="updateCoinSize('r_cab', 'half')"
                                        data-size="half">Half $</button>
                                    <input type="hidden" name="r_cab_coin" value="quarter">
                                </div>
                                <label>OS:
                                    <div class="stepper-wrapper os-stepper">
                                        <button type="button" class="stepper-btn minus"
                                            onclick="updateOsCount('r_cab_os', -1)">-</button>
                                        <div class="stepper-value" id="r_cab_os_display">0</div>
                                        <button type="button" class="stepper-btn plus"
                                            onclick="updateOsCount('r_cab_os', 1)">+</button>
                                        <input type="hidden" name="r_cab_os" value="0" class="stepper-input">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PHOTOS ONLY (Reduced notes etc to match photo priority, kept Notes though) -->
            <div class="section footer-section">
                <!-- Notes -->
                <div class="notes-box">
                    <label>Notes:</label>
                    <textarea id="notes" rows="4"></textarea>
                </div>

                <!-- Photos -->
                <div class="photo-section">
                    <label>Photos (Vin/Odometer/Damage):</label>
                    <div class="photo-controls">
                        <button type="button" class="photo-btn camera" onclick="openCamera()">üì∑ Camera</button>
                        <button type="button" class="photo-btn"
                            onclick="document.getElementById('photoInput').click()">üñºÔ∏è Gallery</button>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none"
                        onchange="handlePhotoSelect(event)">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none"
                        onchange="handlePhotoSelect(event)">
                    <div id="photoPreviews" class="photo-previews-row"></div>
                    <div id="photoUploadStatus" class="photo-upload-status" style="display: none;">
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" id="photoProgressFill"></div>
                        </div>
                        <p id="photoStatusText">Preparing photos...</p>
                    </div>
                    <div id="photoCount" class="photo-count-display" style="display: none;"></div>
                </div>
            </div>

            <!-- PDF EXPORT SECTION -->
            <div class="section export-section">
                <div class="section-title">üìÑ PDF Export Options</div>

                <div class="export-options">
                    <!-- Include Text Toggle -->
                    <div class="export-checkbox selected" onclick="toggleExportCheckbox(this)">
                        <input type="checkbox" id="includeTextVersion" checked>
                        <label for="includeTextVersion">Include detailed damage table</label>
                    </div>

                    <!-- Photo Handling -->
                    <div class="form-group">
                        <label>Photo Handling</label>
                        <div class="photo-mode-toggle">
                            <div class="photo-mode-option" data-mode="thumbnails"
                                onclick="selectPhotoMode('thumbnails')">
                                üñºÔ∏è Thumbnails in PDF
                            </div>
                            <div class="photo-mode-option active" data-mode="attached"
                                onclick="selectPhotoMode('attached')">
                                üìé Photos Attached Separately
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Button -->
                <button type="button" class="export-btn" onclick="generatePDF()">
                    <span>üìÑ</span> Export as PDF
                </button>

                <!-- Airtable Upload Button -->
                <button type="button" class="export-btn airtable-btn" onclick="uploadToAirtable()">
                    <span>‚òÅÔ∏è</span> Upload to Airtable
                </button>
            </div>

            <div class="submit-bar">
                <!-- Estimate Display -->
                <div class="estimate-bar" id="estimateBar">
                    <div>
                        <div class="estimate-label">PDR Estimate</div>
                        <div class="estimate-amount" id="estimateTotal">$0</div>
                    </div>
                    <button type="button" class="estimate-toggle" onclick="toggleEstimate()">
                        üëÅÔ∏è Hide
                    </button>
                </div>

                <!-- Stats Row -->
                <div class="footer-stats-row">
                    <div class="stat-box dents">
                        <span class="stat-label">Panels w/Damage</span>
                        <span class="stat-value" id="liveDentCount">0</span>
                    </div>
                    <div class="stat-box oversized">
                        <span class="stat-label">Oversized</span>
                        <span class="stat-value" id="liveOsCount">0</span>
                    </div>
                    <div class="stat-box parts">
                        <span class="stat-label">R&I Parts</span>
                        <span class="stat-value" id="liveRiCount">0</span>
                    </div>
                    <div class="stat-box parts">
                        <span class="stat-label">R&R Parts</span>
                        <span class="stat-value" id="liveRrCount">0</span>
                    </div>
                    <div class="stat-box" id="saveStatusBox" style="display:none;">
                        <span class="stat-label">Status</span>
                        <span class="stat-value" id="saveStatus">Saved</span>
                    </div>
                </div>


                <!-- Actions Row -->
                <div class="footer-actions-row">
                    <select id="status" class="footer-select" required>
                        <option value="Complete">‚úì Complete</option>
                        <option value="Partial">‚óê Partial</option>
                        <option value="Supplement">+ Supplement</option>
                    </select>

                    <div class="footer-buttons">
                        <button type="button" class="footer-btn orange" onclick="exportToCSV()">
                            üìä Export
                        </button>
                        <button type="button" class="footer-btn blue" onclick="nativeShare()">
                            üì§ Share
                        </button>
                        <button type="button" class="footer-btn teal" onclick="uploadToAirtable()">
                            ‚òÅÔ∏è Airtable
                        </button>
                        <button type="button" class="footer-btn green" id="submitBtn" onclick="submitForm()">
                            ‚úÖ Submit
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- HIDDEN PDF TEMPLATE -->
        <div id="pdfTemplate">
            <!-- HEADER -->
            <div
                style="text-align: center; border-bottom: 2px solid #4CD964; padding-bottom: 8px; margin-bottom: 12px;">
                <h1>DENT EXPERTS PDR SCOPE</h1>
                <p style="margin: 4px 0 0 0; font-size: 8pt; color: #666;">
                    RO#: <span id="pdf-ro"></span> | Estimator: <span id="pdf-estimator"></span> | Date: <span
                        id="pdf-date"></span>
                </p>
            </div>

            <!-- VEHICLE INFO (2-column grid) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 8pt;">
                <div><strong>VIN:</strong> <span id="pdf-vin"></span></div>
                <div><strong>Year:</strong> <span id="pdf-year"></span></div>
                <div><strong>Make:</strong> <span id="pdf-make"></span></div>
                <div><strong>Model:</strong> <span id="pdf-model"></span></div>
                <div><strong>Color:</strong> <span id="pdf-color"></span></div>
                <div><strong>Trim:</strong> <span id="pdf-trim"></span></div>
                <div><strong>Insured:</strong> <span id="pdf-insured"></span></div>
                <div><strong>Carrier:</strong> <span id="pdf-carrier"></span></div>
                <div><strong>Claim #:</strong> <span id="pdf-claim"></span></div>
                <div><strong>Odometer:</strong> <span id="pdf-odometer"></span></div>
            </div>

            <!-- DAMAGE ASSESSMENT TABLE -->
            <div id="pdf-damage-section" style="margin-bottom: 12px;">
                <h3>Damage Assessment</h3>
                <table>
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="text-align: left;">Panel</th>
                            <th style="text-align: center; width: 50px;">DC</th>
                            <th style="text-align: center; width: 50px;">OS</th>
                            <th style="text-align: left;">R&I</th>
                            <th style="text-align: center; width: 40px;">R&R</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-panel-rows">
                        <!-- Rows inserted via JS -->
                    </tbody>
                </table>
            </div>

            <!-- PHOTOS -->
            <div id="pdf-photos-section" style="margin-bottom: 12px;">
                <h3>Photos</h3>
                <div id="pdf-photo-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
                    <!-- Photos or message inserted via JS -->
                </div>
            </div>

            <!-- NOTES -->
            <div id="pdf-notes-section" style="margin-bottom: 12px;">
                <h3>Notes</h3>
                <p id="pdf-notes-text" style="font-size: 8pt; margin: 0; white-space: pre-wrap;"></p>
            </div>

            <!-- FOOTER -->
            <div
                style="position: absolute; bottom: 24px; left: 36px; right: 36px; text-align: center; font-size: 7pt; color: #999; border-top: 1px solid #ddd; padding-top: 6px;">
                Generated by Dent Experts PDR Scope App | <span id="pdf-timestamp"></span>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- VIN Scanner Modal -->
    <div id="scannerModal" class="scanner-modal" style="display: none;">
        <div class="scanner-header">
            <h3>üì∑ Scan VIN</h3>
            <button type="button" onclick="closeScanner()" class="scanner-close">‚úï</button>
        </div>

        <!-- Method Tabs -->
        <div class="scanner-tabs">
            <button type="button" class="scanner-tab active" id="tabBarcode" onclick="switchScannerTab('barcode')">üìä
                Barcode</button>
            <button type="button" class="scanner-tab" id="tabPhoto" onclick="switchScannerTab('photo')">üì∏ Photo
                OCR</button>
        </div>

        <!-- Barcode Scanner View -->
        <div id="barcodeView" class="scanner-view active">
            <div class="scanner-viewport">
                <div id="scannerCamera"></div>
                <div class="scanner-guide">
                    <div class="guide-box"></div>
                    <p>Align barcode within the frame</p>
                </div>
            </div>
        </div>

        <!-- OCR Photo View -->
        <div id="photoView" class="scanner-view" style="display: none;">
            <div class="ocr-capture-area">
                <div class="ocr-preview" id="ocrPreview">
                    <div class="ocr-placeholder">
                        <span class="ocr-icon">üì∏</span>
                        <p>Take a photo of the VIN sticker</p>
                        <small>Works with text - no barcode needed!</small>
                    </div>
                </div>
                <input type="file" id="ocrCameraInput" accept="image/*" capture="environment" style="display: none;"
                    onchange="handleOcrCapture(event)">
                <button type="button" class="ocr-capture-btn"
                    onclick="document.getElementById('ocrCameraInput').click()">
                    üì∑ Take Photo
                </button>
            </div>
            <div class="ocr-progress" id="ocrProgress" style="display: none;">
                <div class="ocr-progress-bar">
                    <div class="ocr-progress-fill" id="ocrProgressFill"></div>
                </div>
                <p id="ocrProgressText">Initializing OCR...</p>
            </div>
        </div>

        <div class="scanner-status" id="scannerStatus">Choose a method above</div>

        <div class="scanner-actions">
            <button type="button" onclick="closeScanner()" class="scanner-btn cancel">Cancel</button>
            <button type="button" onclick="manualVinEntry()" class="scanner-btn manual">‚úçÔ∏è Type VIN</button>
        </div>
    </div>

    <!-- Modal and Scripts -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-icon">‚úì</div>
            <h2>Scope Submitted!</h2>
            <button onclick="resetForm()">New Scope</button>
        </div>
    </div>

    <!-- Retaining Scripts & Styles block (will update CSS next tool call) -->
    <style>
        /* BASE & RESET */
        * {
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at 50% 0%, #252525 0%, #111111 100%);
            min-height: 100vh;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 140px !important;
            /* Footer Space: Sufficient but not crazy */
            touch-action: pan-x pan-y;
            /* Disable pinch-zoom */
        }

        /* GRID LAYOUTS */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 16px;
            /* standard 16px horiz padding */
        }

        /* HEADER REDESIGN (Split Layout) */
        .brand-bar {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-bar .logo {
            font-size: 24px;
            font-weight: 800;
            color: #4CD964;
            letter-spacing: -0.5px;
        }

        .brand-bar .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .help-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #007AFF;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .help-link:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .brand-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .app-btn:hover {
            transform: scale(1.05);
        }

        .app-btn.state-checking {
            background: rgba(255, 255, 255, 0.1);
            cursor: default;
        }

        .app-btn.state-install {
            background: linear-gradient(135deg, #007AFF 0%, #0051D4 100%);
        }

        .app-btn.state-update {
            background: linear-gradient(135deg, #FF9F0A 0%, #FF6B00 100%);
            animation: pulse-update 2s ease-in-out infinite;
        }

        .app-btn.state-current {
            background: rgba(76, 217, 100, 0.2);
            border: 1px solid rgba(76, 217, 100, 0.4);
            color: #4CD964;
            cursor: default;
        }

        .app-btn.state-current:hover {
            transform: none;
        }

        @keyframes pulse-update {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 159, 10, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(255, 159, 10, 0);
            }
        }

        .action-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(45, 45, 45, 0.4);
            padding: 20px;
            /* Unified 20px */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meta-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .meta-group label {
            font-size: 14px;
            font-weight: 700;
            color: #bbb;
        }

        .toolbar-input {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            height: 44px;
            border-radius: 8px;
            padding: 0 12px;
            color: #fff;
            font-size: 16px;
            min-width: 140px;
        }

        /* Clear old header styles if any remain */
        .header,
        .form-meta,
        .inline-input {
            display: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            background: rgba(255, 255, 255, 0.08);
            /* Lighter Glass */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 0 12px;
            border-radius: 8px;
            font-size: 16px;
            /* Prevent iOS zoom */
            height: 44px;
            /* iOS Touch Target */
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
            -webkit-appearance: none;
            /* Remove default styling */
            appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 10px auto;
        }

        input:focus,
        select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4CD964;
            /* Highlight */
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 217, 100, 0.1);
        }

        .inline-input {
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 5px;
            border-radius: 4px;
        }

        /* GENERAL INFO GRID */
        .general-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .col-span-1 {
            grid-column: span 1;
        }

        .col-span-2 {
            grid-column: span 2;
        }

        .col-span-4 {
            grid-column: span 4;
        }

        @media (max-width: 768px) {
            .general-info-grid {
                grid-template-columns: 1fr;
            }

            .col-span-1,
            .col-span-2,
            .col-span-4 {
                grid-column: auto;
            }
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Fix Year/Make/Model Row */
        .ymb-row {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .ymb-row select,
        .ymb-row input {
            width: auto;
            /* Allow flex to control width */
        }

        .info-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .info-group input,
        .info-group select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
        }

        .vin-row {
            display: flex;
            gap: 5px;
        }

        /* DAMAGE GRID */
        .damage-grid-container {
            background: rgba(30, 30, 30, 0.4);
            padding: 20px;
            /* Unified 20px */
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .grid-header {
            background: rgba(51, 51, 51, 0.8);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }

        .visual-grid {
            display: grid;
            /* Optimized for iPad Landscape (1024px) */
            grid-template-columns: 290px 1fr 290px;
            gap: 16px;
            align-items: start;
        }

        /* iPad Pro / Landscape / Tablet Tweak (Prevent Cutoff on 820px) */
        @media (max-width: 1100px) {
            .visual-grid {
                grid-template-columns: 245px 1fr 245px;
                /* Slimmer to fit 820px width */
                gap: 12px;
            }

            .container {
                padding: 10px 12px;
                /* tighter padding saves ~10px */
            }

            .damage-grid-container {
                padding: 12px;
                /* tighter padding saves ~16px */
            }

            .panel-box {
                padding: 12px;
            }

            .brand-bar .logo {
                font-size: 20px;
            }
        }

        /* iPad Portrait & Tablets (Break layout early to prevent squishing) */
        @media (max-width: 780px) {
            .visual-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .center-column {
                grid-column: 1 / -1;
                order: -1;
                margin-bottom: 20px;
            }
        }

        /* Mobile Only (< 600px) */
        @media (max-width: 600px) {
            .visual-grid {
                grid-template-columns: 1fr;
            }
        }

        /* CAR SCHEMATIC */
        .car-schematic svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* PANEL BOXES (Glassmorphism) */
        /* INDIVIDUAL PANELS */
        .panel-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 16px;
            /* More padding */
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .panel-box:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
        }

        .panel-header {
            font-size: 15px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            border-left: 4px solid #4CD964;
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* DONE TOGGLE STYLES */
        .panel-done-toggle {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #888;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-done-toggle input {
            width: 16px;
            height: 16px;
            margin: 0;
            accent-color: #4CD964;
        }

        .panel-done-toggle:hover {
            color: #fff;
        }

        /* COMPLETE STATE */
        .panel-box.is-complete {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.05);
            box-shadow: 0 0 15px rgba(76, 217, 100, 0.1);
        }

        .panel-box.is-complete .panel-header {
            color: #4CD964;
        }

        .panel-box.is-complete .panel-done-toggle {
            background: #4CD964;
            color: #000;
        }

        .panel-ratings {
            display: grid;
            /* Stack vertically and fill width */
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            align-items: center;
        }











        .panel-ratings label {
            font-size: 11px;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .panel-ratings input {
            width: 44px;
            /* Larger touch target */
            height: 32px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #4CD964;
            padding: 4px;
            text-align: center;
            font-weight: bold;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .panel-ratings input:focus {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.1);
            outline: none;
        }

        /* SMART STEPPER UI v2 */
        .stepper-ui {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Spread Label and Controls */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 4px 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0;
            width: 100%;
            /* Fill Container */
            height: 44px;
        }

        .st-label {
            font-size: 11px;
            color: #aaa;
            margin: 0 8px 0 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .st-btn {
            width: 40px;
            /* Large Hit Area */
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #4CD964;
            font-size: 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.1s;
        }

        .st-btn:active {
            background: #4CD964;
            color: #000;
        }

        .st-input {
            width: 40px !important;
            border: none !important;
            background: transparent !important;
            text-align: center;
            color: #fff !important;
            font-size: 18px !important;
            font-weight: bold;
            margin: 0;
            padding: 0 !important;
            height: 100% !important;
        }

        /* DENT COUNT RANGE BUTTONS */
        .dc-range-ui {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dc-range-label {
            font-size: 10px;
            color: #888;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dc-range-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .dc-range-btn {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #ccc;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 48px;
            text-align: center;
        }

        .dc-range-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .dc-range-btn.selected {
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.25) 0%, rgba(76, 217, 100, 0.15) 100%);
            border-color: #4CD964;
            color: #4CD964;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(76, 217, 100, 0.3);
        }

        /* COIN SIZE BUTTONS */
        .coin-size-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .coin-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #999;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .coin-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .coin-btn.selected {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.25) 0%, rgba(0, 122, 255, 0.15) 100%);
            border-color: #007AFF;
            color: #007AFF;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        /* ESTIMATE DISPLAY */
        .estimate-bar {
            background: linear-gradient(135deg, rgba(255, 159, 10, 0.15) 0%, rgba(255, 159, 10, 0.08) 100%);
            border: 1px solid rgba(255, 159, 10, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .estimate-bar.hidden {
            display: none;
        }

        .estimate-amount {
            font-size: 28px;
            font-weight: 700;
            color: #FF9F0A;
        }

        .estimate-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estimate-toggle {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #888;
            font-size: 11px;
            cursor: pointer;
        }

        .estimate-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* UPD TOGGLE */
        .upd-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(255, 159, 10, 0.08);
            border: 1px solid rgba(255, 159, 10, 0.15);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upd-toggle:hover {
            background: rgba(255, 159, 10, 0.12);
            border-color: rgba(255, 159, 10, 0.25);
        }

        .upd-toggle.active {
            background: rgba(255, 159, 10, 0.15);
            border-color: rgba(255, 159, 10, 0.4);
        }

        .upd-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #FF9500;
        }

        .upd-toggle span {
            font-size: 11px;
            font-weight: 600;
            color: #FF9500;
        }

        .panel-box.has-upd {
            border-color: #FF9500 !important;
            box-shadow: 0 0 12px rgba(255, 149, 0, 0.2);
        }

        .panel-box.has-upd .panel-header {
            border-left-color: #FF9500;
        }

        .upd-notes {
            display: none;
            margin-top: 8px;
        }

        .upd-notes.visible {
            display: block;
        }

        .upd-notes textarea {
            width: 100%;
            min-height: 60px;
            background: rgba(255, 149, 0, 0.05);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: 6px;
            color: #fff;
            padding: 8px;
            font-size: 13px;
            resize: vertical;
        }

        .upd-notes textarea::placeholder {
            color: rgba(255, 149, 0, 0.5);
        }

        /* CHECKLIST TABLES */
        .checklist-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 2px;
            margin-top: 10px;
            table-layout: fixed;
            /* Force fixed columns */
        }

        /* Explicit Column Widths */
        .checklist-table th:nth-child(1) {
            width: 18%;
        }

        .checklist-table th:nth-child(2) {
            width: 64%;
        }

        .checklist-table th:nth-child(3) {
            width: 18%;
        }

        .checklist-table th {
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
            padding: 8px 2px;
            font-size: 10px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            white-space: nowrap;
        }

        .checklist-table td {
            padding: 0 2px;
            border: none;
            height: 48px;
            vertical-align: middle;
            font-size: 14px;
            text-align: center;
        }

        .checklist-table td:nth-child(2) {
            text-align: left;
            padding-left: 8px;
            width: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ddd;
            font-weight: 500;
        }

        /* CUSTOM CHECKBOX (Touch Friendly) */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 26px;
            height: 26px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #555;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type="checkbox"]:checked {
            background: #4CD964;
            border-color: #4CD964;
            box-shadow: 0 0 10px rgba(76, 217, 100, 0.4);
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 45%;
            width: 6px;
            height: 12px;
            border: solid #000;
            border-width: 0 2.5px 2.5px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        input[type="checkbox"]:active {
            transform: scale(0.92);
        }

        /* Add row hover effect for easier tracking */
        .checklist-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        /* FOOTER */
        .footer-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .notes-box textarea {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
        }

        /* REBUILT FOOTER CSS */
        .submit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(15, 15, 15, 0.98) 0%, rgba(20, 20, 20, 0.95) 100%);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            z-index: 9999;
            gap: 10px;
        }

        .footer-stats-row {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            width: 100%;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 60px;
            flex: 1;
        }

        .stat-box .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .stat-box .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .stat-box.dents {
            border-color: rgba(76, 217, 100, 0.3);
            background: rgba(76, 217, 100, 0.08);
        }

        .stat-box.dents .stat-value {
            color: #4CD964;
        }

        .stat-box.oversized {
            border-color: rgba(255, 59, 48, 0.3);
            background: rgba(255, 59, 48, 0.08);
        }

        .stat-box.oversized .stat-value {
            color: #FF3B30;
        }

        .stat-box.parts {
            border-color: rgba(0, 122, 255, 0.3);
            background: rgba(0, 122, 255, 0.08);
        }

        .stat-box.parts .stat-value {
            color: #007AFF;
        }

        .stat-box.estimate {
            border-color: rgba(255, 214, 10, 0.4);
            background: rgba(255, 214, 10, 0.12);
            min-width: 90px;
        }

        .stat-box.estimate .stat-value {
            color: #FFD60A;
            font-size: 16px;
        }

        .footer-actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .footer-select {
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a6' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 18px;
            padding-right: 36px;
            min-width: 130px;
        }

        .footer-select option {
            background: #1a1a1a;
            color: #fff;
        }

        .footer-buttons {
            display: flex;
            gap: 8px;
        }

        .footer-btn {
            height: 44px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            padding: 0 16px;
            cursor: pointer;
            white-space: nowrap;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .footer-btn:active {
            transform: scale(0.96);
        }

        .footer-btn.blue {
            background: linear-gradient(135deg, #007AFF 0%, #0066DD 100%);
            color: #fff;
        }

        .footer-btn.blue:hover {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .footer-btn.green {
            background: linear-gradient(135deg, #4CD964 0%, #30D158 100%);
            color: #000;
        }

        .footer-btn.green:hover {
            box-shadow: 0 4px 12px rgba(76, 217, 100, 0.4);
        }

        .footer-btn.orange {
            background: linear-gradient(135deg, #FF9F0A 0%, #FF7A00 100%);
            color: #000;
        }

        .footer-btn.orange:hover {
            box-shadow: 0 4px 12px rgba(255, 159, 10, 0.4);
        }

        .footer-btn.teal {
            background: linear-gradient(135deg, #18BFFF 0%, #2D7FF9 100%);
            color: #fff;
        }

        .footer-btn.teal:hover {
            box-shadow: 0 4px 12px rgba(24, 191, 255, 0.4);
        }

        @media (max-width: 500px) {
            .footer-stats-row {
                flex-wrap: wrap;
            }

            .stat-box {
                min-width: calc(33% - 8px);
            }

            .footer-actions-row {
                flex-direction: column;
            }

            .footer-select {
                width: 100%;
            }

            .footer-buttons {
                width: 100%;
            }

            .footer-btn {
                flex: 1;
            }
        }

        /* Clear old styles */
        .status-select,
        .submit-btn {
            display: none;
        }

        /* Stepper Component Polished */
        .stepper-wrapper {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 0;
            height: 44px;
            /* Slightly more compact height */
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .stepper-btn {
            width: 48px;
            height: 100%;
            border: none;
            background: transparent;
            color: #4CD964;
            font-size: 28px;
            /* Larger symbol */
            font-weight: 200;
            /* Thinner weight for iOS feel */
            line-height: 1;
            padding-bottom: 4px;
            /* Center vertical alignment visually */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .stepper-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .stepper-btn:active {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(0.95);
        }

        .stepper-btn.minus {
            color: #FF453A;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stepper-btn.plus {
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stepper-value {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            user-select: none;
            white-space: nowrap;
            letter-spacing: 0.5px;
            transition: transform 0.1s;
        }

        .stepper-value.placeholder {
            color: #555;
            font-weight: 400;
        }

        .stepper-value.is-off-matrix {
            color: #FF453A;
            /* Red warning color */
            font-size: 13px;
            /* Smaller to fit */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0;
        }

        /* Hide the actual input but keep it for form submission logic */
        input[type="hidden"].stepper-input {
            display: none;
        }

        /* Adjustment for side labels */
        .panel-ratings label {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Coin Size Selector */
        .coin-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 2px;
            margin-top: 4px;
            margin-bottom: 8px;
            /* Space before OS */
        }

        .coin-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            padding: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .coin-btn.selected {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .coin-selector.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* OS Stepper Styling (Reuse stepper classes but maybe smaller?) */
        .stepper-wrapper.os-stepper {
            border-color: rgba(255, 59, 48, 0.3);
            /* Reddish tint for OS */
            background: rgba(255, 59, 48, 0.05);
        }

        .stepper-wrapper.os-stepper .stepper-btn {
            color: #FF453A;
        }

        /* =========================================
           POLISH ROUND - Enhanced Micro-Interactions
           ========================================= */

        /* --- Stepper Enhancements --- */
        .stepper-wrapper {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .stepper-wrapper:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .stepper-wrapper:focus-within {
            border-color: rgba(76, 217, 100, 0.4);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(76, 217, 100, 0.15);
        }

        .stepper-btn {
            position: relative;
            overflow: hidden;
        }

        /* Ripple effect on button click */
        .stepper-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .stepper-btn:active::before {
            width: 100px;
            height: 100px;
            opacity: 0;
        }

        /* Value pop animation */
        .stepper-value {
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s ease;
        }

        .stepper-value.pop {
            transform: scale(1.15);
        }

        /* --- Coin Selector Polish --- */
        .coin-selector {
            transition: opacity 0.3s ease, transform 0.2s ease;
            position: relative;
        }

        .coin-selector.disabled {
            opacity: 0.25;
            transform: scale(0.98);
        }

        .coin-btn {
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .coin-btn:hover:not(.selected) {
            background: rgba(255, 255, 255, 0.08);
            color: #bbb;
        }

        .coin-btn.selected {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.25) 0%, rgba(0, 122, 255, 0.15) 100%);
            color: #4FC3F7;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
            transform: scale(1.02);
        }

        .coin-btn:active {
            transform: scale(0.96);
        }

        /* --- Panel Box Enhancements --- */
        .panel-box {
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        .panel-box:hover {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.045);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
        }

        .panel-box.is-complete {
            border-color: rgba(76, 217, 100, 0.5);
            background: rgba(76, 217, 100, 0.06);
            box-shadow: 0 0 20px rgba(76, 217, 100, 0.12), 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .panel-box.has-upd {
            animation: upd-pulse 2s ease-in-out infinite;
        }

        @keyframes upd-pulse {

            0%,
            100% {
                box-shadow: 0 0 12px rgba(255, 149, 0, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 149, 0, 0.35);
            }
        }

        /* Panel header glow on data entry */
        .panel-box.has-data .panel-header {
            border-left-color: #4CD964;
            text-shadow: 0 0 10px rgba(76, 217, 100, 0.3);
        }

        /* --- Footer Stats Animation --- */
        .stat-box {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stat-value.updated {
            animation: stat-pop 0.3s ease;
        }

        @keyframes stat-pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- Button Enhancements --- */
        .footer-btn,
        .saved-btn,
        .vin-scan-btn,
        .photo-btn,
        .export-btn {
            position: relative;
            overflow: hidden;
        }

        .footer-btn::after,
        .saved-btn::after,
        .photo-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.4s ease;
        }

        .footer-btn:hover::after,
        .saved-btn:hover::after,
        .photo-btn:hover::after {
            left: 100%;
        }

        /* --- Form Input Polish --- */
        .general-info-grid input,
        .general-info-grid select,
        .toolbar-input {
            transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        }

        .general-info-grid input:focus,
        .general-info-grid select:focus {
            border-color: #4CD964;
            background: rgba(76, 217, 100, 0.08);
            box-shadow: 0 0 0 3px rgba(76, 217, 100, 0.12);
        }

        /* Auto-filled state enhancement */
        .auto-filled {
            border-color: #4CD964 !important;
            background: rgba(76, 217, 100, 0.12) !important;
            box-shadow: 0 0 12px rgba(76, 217, 100, 0.25);
            animation: auto-fill-glow 0.5s ease;
        }

        @keyframes auto-fill-glow {
            0% {
                box-shadow: 0 0 0 rgba(76, 217, 100, 0);
            }

            50% {
                box-shadow: 0 0 20px rgba(76, 217, 100, 0.5);
            }

            100% {
                box-shadow: 0 0 12px rgba(76, 217, 100, 0.25);
            }
        }

        /* --- VIN Scan Section Polish --- */
        .vin-scan-section {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .vin-scan-section:hover {
            border-color: rgba(76, 217, 100, 0.4);
            box-shadow: 0 0 30px rgba(76, 217, 100, 0.1);
        }

        .vin-scan-btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .vin-scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 217, 100, 0.5);
        }

        /* Result grid enhancement */
        .result-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .result-item.filled {
            animation: result-slide-in 0.3s ease forwards;
        }

        @keyframes result-slide-in {
            from {
                transform: translateX(-10px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* --- Saved Forms Bar Polish --- */
        .saved-forms-bar {
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .saved-forms-bar:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .saved-forms-select {
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .saved-forms-select:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.15);
        }

        /* --- Export Section Polish --- */
        .photo-mode-option {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .photo-mode-option:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .photo-mode-option.active {
            transform: scale(1.02);
            box-shadow: 0 2px 10px rgba(76, 217, 100, 0.25);
        }

        .export-btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .export-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
        }

        .export-btn:disabled {
            cursor: not-allowed;
            transform: none;
        }

        /* Loading state for export button */
        .export-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .export-btn.loading span {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* --- Checkbox Enhancements --- */
        .checklist-table input[type="checkbox"] {
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .checklist-table input[type="checkbox"]:hover {
            border-color: rgba(76, 217, 100, 0.5);
            box-shadow: 0 0 8px rgba(76, 217, 100, 0.2);
        }

        .checklist-table input[type="checkbox"]:checked {
            animation: checkbox-check 0.2s ease;
        }

        @keyframes checkbox-check {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- Toast Enhancements --- */
        .toast {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .toast.success {
            border-color: rgba(76, 217, 100, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 217, 100, 0.2);
        }

        .toast.error {
            border-color: rgba(255, 69, 58, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 69, 58, 0.2);
        }

        /* --- Scrollbar Polish (for non-hidden areas) --- */
        .panel-box::-webkit-scrollbar {
            width: 4px;
        }

        .panel-box::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-box::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
        }

        .panel-box::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* --- Estimate Bar Enhancement --- */
        .estimate-bar {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .estimate-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(255, 159, 10, 0.2);
        }

        .estimate-amount {
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- Grid Header Enhancement --- */
        .grid-header {
            transition: background 0.2s ease;
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.15) 0%, rgba(51, 51, 51, 0.8) 100%);
        }

        /* --- Photo Preview Enhancement --- */
        .photo-preview {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .photo-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .photo-preview .remove-photo {
            transition: transform 0.15s ease, background 0.2s ease;
        }

        .photo-preview:hover .remove-photo {
            transform: scale(1.1);
        }

        /* --- Brand Bar Polish --- */
        .brand-bar .logo img {
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .brand-bar .logo:hover img {
            transform: scale(1.05);
            filter: brightness(0) invert(1) drop-shadow(0 0 8px rgba(76, 217, 100, 0.4));
        }

        /* --- Help Link Polish --- */
        .help-link {
            transition: all 0.2s ease;
        }

        .help-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        /* --- UPD Toggle Enhancement --- */
        .upd-toggle {
            transition: all 0.2s ease;
        }

        .upd-toggle:hover {
            transform: translateX(2px);
        }

        .upd-toggle.active {
            box-shadow: 0 0 15px rgba(255, 149, 0, 0.25);
        }
    </style>

    <script>
        // CONFIGURATION
        const CONFIG = {
            photoFolderId: 'YOUR_FOLDER_ID_HERE'
        };

        // STATE
        let selectedPhotos = [];
        const SAVED_FORMS_KEY = 'dent_pro_saved_forms';

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            loadSavedFormsList();

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed', err));
            }
        });

        // =============================================
        // SAVED FORMS MANAGEMENT (localStorage)
        // =============================================

        function getSavedForms() {
            const saved = localStorage.getItem(SAVED_FORMS_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        function setSavedForms(forms) {
            localStorage.setItem(SAVED_FORMS_KEY, JSON.stringify(forms));
        }

        function loadSavedFormsList() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const forms = getSavedForms();

            // Clear existing options except the default
            dropdown.innerHTML = '<option value="">-- Select Saved Form --</option>';

            // Sort forms by timestamp (newest first)
            const sortedKeys = Object.keys(forms).sort((a, b) => {
                return (forms[b].savedAt || 0) - (forms[a].savedAt || 0);
            });

            sortedKeys.forEach(key => {
                const form = forms[key];
                const opt = document.createElement('option');
                opt.value = key;

                // Create display label: RO# - Year Make Model - Date
                const parts = [];
                if (form.roNumber) parts.push('RO: ' + form.roNumber);
                if (form.year || form.make || form.model) {
                    parts.push([form.year, form.make, form.model].filter(Boolean).join(' '));
                }
                if (form.savedAt) {
                    const date = new Date(form.savedAt);
                    parts.push(date.toLocaleDateString());
                }

                opt.text = parts.length > 0 ? parts.join(' ‚Ä¢ ') : key;
                dropdown.add(opt);
            });
        }

        function saveCurrentForm() {
            // Get RO number as the primary identifier
            const roNumber = document.getElementById('roNumber').value.trim();

            if (!roNumber) {
                showToast('Please enter an RO# to save the form', 'error');
                document.getElementById('roNumber').focus();
                return;
            }

            // Collect all form data
            const formData = collectFormData();
            formData.savedAt = Date.now();

            // Add photos to saved data
            formData.photos = selectedPhotos;

            // Get existing forms and add/update this one
            const forms = getSavedForms();
            const key = 'form_' + roNumber;

            const isUpdate = forms[key] !== undefined;
            forms[key] = formData;

            try {
                setSavedForms(forms);

                // Refresh dropdown and select this form
                loadSavedFormsList();
                document.getElementById('savedFormsDropdown').value = key;

                showToast(isUpdate ? '‚úÖ Form updated successfully!' : '‚úÖ Form saved successfully!', 'success');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ö†Ô∏è Storage full! Photos may be too large.', 'error');
                } else {
                    showToast('‚ùå Save failed: ' + e.message, 'error');
                }
            }
        }

        function collectFormData() {
            const data = {};

            // Collect header inputs (outside of form)
            data.roNumber = document.getElementById('roNumber').value;
            data.estimator = document.getElementById('estimator').value;

            // Collect all form inputs
            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                if (el.type === 'checkbox') {
                    data[el.name] = el.checked;
                } else if (el.type === 'radio') {
                    if (el.checked) data[el.name] = el.value;
                } else {
                    data[el.name] = el.value;
                }
            });

            // Also collect standalone IDs that might not have name attributes
            const standaloneIds = ['insuranceCompany', 'claimNumber', 'year', 'make', 'model',
                'odometer', 'location', 'vin', 'color', 'notes', 'status'];
            standaloneIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && !data[id]) {
                    data[id] = el.value;
                }
            });

            return data;
        }

        function loadSavedForm() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const key = dropdown.value;

            if (!key) return; // No selection

            const forms = getSavedForms();
            const formData = forms[key];

            if (!formData) {
                showToast('Form not found', 'error');
                return;
            }

            // Restore header inputs
            if (formData.roNumber) document.getElementById('roNumber').value = formData.roNumber;
            if (formData.estimator) document.getElementById('estimator').value = formData.estimator;

            // Restore form data
            Object.keys(formData).forEach(name => {
                if (name === 'savedAt' || name === 'roNumber' || name === 'estimator') return;

                // Try by name first
                const elsByName = document.getElementsByName(name);
                if (elsByName.length > 0) {
                    const el = elsByName[0];
                    if (el.type === 'checkbox') {
                        el.checked = formData[name];
                        // Handle "Done" toggles visual state
                        if (name.endsWith('_done')) {
                            const box = el.closest('.panel-box');
                            if (box) {
                                if (el.checked) box.classList.add('is-complete');
                                else box.classList.remove('is-complete');
                            }
                        }
                    } else if (el.type === 'radio') {
                        if (el.value === formData[name]) el.checked = true;
                    } else {
                        el.value = formData[name];
                        if (name.endsWith('_dc')) updateDentCount(name, 0);
                        if (name.endsWith('_os')) updateOsCount(name, 0);
                        if (name.endsWith('_coin')) updateCoinSize(name.replace('_coin', ''), formData[name]);
                    }
                } else {
                    // Try by ID
                    const elById = document.getElementById(name);
                    if (elById) {
                        elById.value = formData[name];
                    }
                }
            });

            // Restore photos
            if (formData.photos && Array.isArray(formData.photos)) {
                selectedPhotos = formData.photos;
                renderPreviews();
            } else {
                selectedPhotos = [];
                renderPreviews();
            }

            // Update VIN counter
            updateVinCounter();

            // Update summary stats
            updateSummary();

            // Also save to draft so auto-save continues
            saveDraft();

            showToast('üìÇ Form loaded successfully!', 'success');
        }

        function deleteSavedForm() {
            const dropdown = document.getElementById('savedFormsDropdown');
            const key = dropdown.value;

            if (!key) {
                showToast('Please select a form to delete', 'error');
                return;
            }

            const forms = getSavedForms();
            const formData = forms[key];
            const displayName = formData?.roNumber ? `RO: ${formData.roNumber}` : key;

            if (confirm(`Are you sure you want to delete "${displayName}"?\n\nThis cannot be undone.`)) {
                delete forms[key];
                setSavedForms(forms);
                loadSavedFormsList();
                showToast('üóëÔ∏è Form deleted', 'success');
            }
        }

        function startNewForm() {
            if (confirm('Start a new blank form?\n\nMake sure you\'ve saved your current work.')) {
                // Reset form
                document.getElementById('scopeForm').reset();
                document.getElementById('roNumber').value = '';
                document.getElementById('estimator').value = '';

                // Reset dropdown selection
                document.getElementById('savedFormsDropdown').value = '';

                // Reset photos
                selectedPhotos = [];
                renderPreviews();

                // Clear panel complete states
                document.querySelectorAll('.panel-box.is-complete').forEach(box => {
                    box.classList.remove('is-complete');
                });

                // Reset Steppers
                document.querySelectorAll('input[name$="_dc"]').forEach(el => updateDentCount(el.name, 0));
                document.querySelectorAll('input[name$="_os"]').forEach(el => updateOsCount(el.name, 0));
                document.querySelectorAll('input[name$="_coin"]').forEach(el => updateCoinSize(el.name.replace('_coin', ''), 'quarter'));

                // Update UI
                updateVinCounter();
                updateSummary();

                // Clear draft
                localStorage.removeItem(DRAFT_KEY);

                showToast('üìù New form started', 'success');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function loadDropdowns() {
            // Populate Year (back to 1960)
            const yearSelect = document.getElementById('year');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= 1960; i--) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                yearSelect.add(opt);
            }

            // Populate basic Makes (can expand later)
            const makes = ["Ford", "Chevy", "Dodge/Ram", "Toyota", "Honda", "Nissan", "Hyundai/Kia", "BMW", "Mercedes", "Audi", "VW", "Tesla", "Subaru", "Other"];
            const makeSelect = document.getElementById('make');
            makes.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.text = m;
                makeSelect.add(opt);
            });
            // Locations
            const locs = ["Progressive Cat Drive", "Shop", "Mobile", "Dealership", "Auction"];
            const locSelect = document.getElementById('location');
            locs.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.text = l;
                locSelect.add(opt);
            });

            // Insurance
            const ins = ["State Farm", "Geico", "Progressive", "Allstate", "Liberty Mutual", "Farmers", "Nationwide", "USAA", "Other"];
            const insSelect = document.getElementById('insuranceCompany');
            ins.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                insSelect.add(opt);
            });
        }

        // --- VIN LOGIC ---
        let lastDecodedVin = '';
        let vinDecodeTimeout = null;

        function updateVinCounter() {
            const vinInput = document.getElementById('vin');
            const vin = vinInput.value.toUpperCase();

            // Auto-uppercase while typing
            if (vinInput.value !== vin) {
                vinInput.value = vin;
            }

            // Update counter display
            const counter = document.getElementById('vinCounter');
            counter.textContent = `${vin.length}/17`;

            // Update counter styling
            if (vin.length === 17 && /^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                counter.classList.add('valid');
                counter.classList.remove('invalid');

                // Auto-decode if this is a new valid VIN
                if (vin !== lastDecodedVin) {
                    // Debounce to avoid rapid API calls while typing
                    clearTimeout(vinDecodeTimeout);
                    vinDecodeTimeout = setTimeout(() => {
                        lastDecodedVin = vin;
                        decodeVin(vin);
                    }, 500);
                }
            } else if (vin.length > 0) {
                counter.classList.remove('valid');
                counter.classList.add('invalid');
            } else {
                counter.classList.remove('valid', 'invalid');
            }
        }

        // --- PHOTO LOGIC ---
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        // --- INITIALIZATION ---
        // Convert DC to range buttons, OS to steppers, add UPD toggles
        // Stepper Steps (Active Matrix + Off Matrix)
        const DC_STEPS = ['', '1-5', '6-15', '16-30', '31-50', '51-75', '76-100', '101-150', '151-200', '201-300', '301-400', 'Off Matrix'];
        // Legacy support if needed
        const DC_RANGES = DC_STEPS.slice(1);

        function updateDentCount(name, direction) {
            const hiddenInput = document.querySelector(`input[name="${name}"]`);
            const display = document.getElementById(name + '_display');
            if (!hiddenInput || !display) return;

            let val = hiddenInput.value;
            // Treat '0' as empty
            if (val === '0') val = '';

            let index = DC_STEPS.indexOf(val);
            if (index === -1) index = 0;

            let newIndex = index + direction;

            // Wrapping Logic:
            // 0 -> Minus -> Off Matrix
            // Off Matrix -> Plus -> 0
            if (newIndex < 0) newIndex = DC_STEPS.length - 1;
            if (newIndex >= DC_STEPS.length) newIndex = 0;

            const newValue = DC_STEPS[newIndex];
            hiddenInput.value = newValue;

            // Update UI
            if (newValue === '') {
                display.textContent = '0';
                display.className = 'stepper-value placeholder';
            } else {
                display.textContent = newValue;
                display.className = 'stepper-value';

                // Specific styling for long text or special values
                if (newValue === 'Off Matrix') {
                    display.classList.add('is-off-matrix');
                }
            }

            // Pop animation for visual feedback
            if (direction !== 0) {
                display.classList.add('pop');
                setTimeout(() => display.classList.remove('pop'), 150);
            }

            toggleCoinVisibility(name, newValue === 'Off Matrix');

            // Toggle has-data class on parent panel for visual feedback
            const panelBox = hiddenInput.closest('.panel-box');
            if (panelBox) {
                if (newValue && newValue !== '') {
                    panelBox.classList.add('has-data');
                } else {
                    panelBox.classList.remove('has-data');
                }
            }

            // Trigger change for totals
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));

            if (typeof haptic === 'function') haptic('light');
        }

        function updateOsCount(name, direction) {
            const hiddenInput = document.querySelector(`input[name="${name}"]`);
            const display = document.getElementById(name + '_display');
            if (!hiddenInput || !display) return;

            let val = parseInt(hiddenInput.value) || 0;
            let newVal = val + direction;

            if (newVal < 0) newVal = 0; // OS cannot be negative

            hiddenInput.value = newVal;
            display.textContent = newVal;

            // Pop animation for visual feedback
            if (direction !== 0) {
                display.classList.add('pop');
                setTimeout(() => display.classList.remove('pop'), 150);
            }

            // Trigger change
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof haptic === 'function') haptic('light');
        }

        function updateCoinSize(panelKey, size) {
            const input = document.querySelector(`input[name="${panelKey}_coin"]`);
            if (!input) return;

            input.value = size;

            // Update UI
            const wrapper = document.getElementById(panelKey + '_coin_wrapper');
            if (wrapper) {
                wrapper.querySelectorAll('.coin-btn').forEach(btn => {
                    if (btn.dataset.size === size) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                });
            }

            // Trigger change
            input.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof haptic === 'function') haptic('light');
        }

        function toggleCoinVisibility(name, isOffMatrix) {
            // panelKey is name minus _dc
            const panelKey = name.replace('_dc', '');
            const coinWrapper = document.getElementById(panelKey + '_coin_wrapper');
            if (coinWrapper) {
                if (isOffMatrix || document.querySelector(`input[name="${name}"]`).value === '') {
                    coinWrapper.classList.add('disabled');
                } else {
                    coinWrapper.classList.remove('disabled');
                }
            }
        }

        const COIN_SIZES = ['dime', 'nickel', 'quarter', 'half'];
        const COIN_LABELS = { dime: 'Dime', nickel: 'Nickel', quarter: 'Quarter', half: 'Half $' };

        // ==================== DENT WIZARD MATRIX PRICING ====================
        // Prices by panel type, then by DC range, then by coin size
        // Format: PANEL_PRICES[panelType][dcRange][coinSize] = price
        const PANEL_PRICES = {
            hood: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 125, nickel: 150, quarter: 175, half: 240 },
                '16-30': { dime: 175, nickel: 200, quarter: 250, half: 300 },
                '31-50': { dime: 225, nickel: 275, quarter: 325, half: 400 },
                '51-75': { dime: 300, nickel: 350, quarter: 425, half: 500 },
                '76-100': { dime: 375, nickel: 450, quarter: 550, half: 650 },
                '101-150': { dime: 475, nickel: 550, quarter: 650, half: 800 },
                '151-200': { dime: 550, nickel: 650, quarter: 775, half: 950 },
                '201-300': { dime: 625, nickel: 750, quarter: 900, half: 1100 },
                '301-400': { dime: 700, nickel: 850, quarter: 1000, half: 1250 }
            },
            roof: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 175, nickel: 225, quarter: 295, half: 400 },
                '16-30': { dime: 225, nickel: 300, quarter: 375, half: 475 },
                '31-50': { dime: 300, nickel: 400, quarter: 475, half: 575 },
                '51-75': { dime: 375, nickel: 500, quarter: 600, half: 700 },
                '76-100': { dime: 475, nickel: 600, quarter: 725, half: 850 },
                '101-150': { dime: 600, nickel: 750, quarter: 900, half: 1050 },
                '151-200': { dime: 750, nickel: 950, quarter: 1100, half: 1300 },
                '201-300': { dime: 900, nickel: 1100, quarter: 1300, half: 1500 },
                '301-400': { dime: 1050, nickel: 1250, quarter: 1500, half: 1750 }
            },
            fender: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 175 },
                '6-15': { dime: 100, nickel: 125, quarter: 175, half: 225 },
                '16-30': { dime: 150, nickel: 200, quarter: 250, half: 325 },
                '31-50': { dime: 200, nickel: 275, quarter: 350, half: 425 },
                '51-75': { dime: 275, nickel: 350, quarter: 450, half: 550 },
                '76-100': { dime: 350, nickel: 450, quarter: 550, half: 675 },
                '101-150': { dime: 450, nickel: 575, quarter: 700, half: 850 },
                '151-200': { dime: 575, nickel: 725, quarter: 875, half: 1050 },
                '201-300': { dime: 700, nickel: 875, quarter: 1050, half: 1250 },
                '301-400': { dime: 825, nickel: 1025, quarter: 1225, half: 1450 }
            },
            door: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 150 },
                '6-15': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '16-30': { dime: 125, nickel: 175, quarter: 225, half: 275 },
                '31-50': { dime: 175, nickel: 225, quarter: 300, half: 375 },
                '51-75': { dime: 225, nickel: 300, quarter: 400, half: 475 },
                '76-100': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '101-150': { dime: 400, nickel: 500, quarter: 625, half: 750 },
                '151-200': { dime: 500, nickel: 625, quarter: 775, half: 925 },
                '201-300': { dime: 600, nickel: 750, quarter: 925, half: 1100 },
                '301-400': { dime: 700, nickel: 875, quarter: 1075, half: 1275 }
            },
            quarter: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 175 },
                '6-15': { dime: 125, nickel: 150, quarter: 175, half: 225 },
                '16-30': { dime: 175, nickel: 225, quarter: 275, half: 350 },
                '31-50': { dime: 225, nickel: 300, quarter: 375, half: 475 },
                '51-75': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '76-100': { dime: 400, nickel: 525, quarter: 650, half: 775 },
                '101-150': { dime: 525, nickel: 675, quarter: 825, half: 1000 },
                '151-200': { dime: 650, nickel: 825, quarter: 1000, half: 1200 },
                '201-300': { dime: 775, nickel: 975, quarter: 1175, half: 1400 },
                '301-400': { dime: 900, nickel: 1125, quarter: 1350, half: 1600 }
            },
            decklid: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 175 },
                '6-15': { dime: 100, nickel: 150, quarter: 200, half: 250 },
                '16-30': { dime: 175, nickel: 250, quarter: 325, half: 400 },
                '31-50': { dime: 250, nickel: 350, quarter: 450, half: 550 },
                '51-75': { dime: 325, nickel: 450, quarter: 575, half: 700 },
                '76-100': { dime: 400, nickel: 550, quarter: 700, half: 850 },
                '101-150': { dime: 500, nickel: 675, quarter: 850, half: 1025 },
                '151-200': { dime: 600, nickel: 800, quarter: 1000, half: 1200 },
                '201-300': { dime: 700, nickel: 925, quarter: 1150, half: 1375 },
                '301-400': { dime: 800, nickel: 1050, quarter: 1300, half: 1550 }
            },
            cab: {
                '1-5': { dime: 75, nickel: 100, quarter: 125, half: 150 },
                '6-15': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '16-30': { dime: 125, nickel: 175, quarter: 225, half: 275 },
                '31-50': { dime: 175, nickel: 225, quarter: 300, half: 375 },
                '51-75': { dime: 225, nickel: 300, quarter: 400, half: 475 },
                '76-100': { dime: 300, nickel: 400, quarter: 500, half: 600 },
                '101-150': { dime: 400, nickel: 500, quarter: 625, half: 750 },
                '151-200': { dime: 500, nickel: 625, quarter: 775, half: 925 },
                '201-300': { dime: 600, nickel: 750, quarter: 925, half: 1100 },
                '301-400': { dime: 700, nickel: 875, quarter: 1075, half: 1275 }
            },
            bedside: {
                '1-5': { dime: 100, nickel: 125, quarter: 150, half: 200 },
                '6-15': { dime: 125, nickel: 175, quarter: 225, half: 300 },
                '16-30': { dime: 200, nickel: 275, quarter: 350, half: 450 },
                '31-50': { dime: 275, nickel: 375, quarter: 475, half: 600 },
                '51-75': { dime: 375, nickel: 500, quarter: 625, half: 775 },
                '76-100': { dime: 475, nickel: 625, quarter: 775, half: 950 },
                '101-150': { dime: 600, nickel: 775, quarter: 975, half: 1175 },
                '151-200': { dime: 725, nickel: 925, quarter: 1150, half: 1400 },
                '201-300': { dime: 850, nickel: 1075, quarter: 1325, half: 1625 },
                '301-400': { dime: 975, nickel: 1225, quarter: 1500, half: 1850 }
            }
        };

        // Map panel names to pricing categories
        const PANEL_CATEGORY = {
            'l_fender': 'fender', 'r_fender': 'fender',
            'hood': 'hood',
            'roof': 'roof', 'cowl': 'roof',
            'l_front_door': 'door', 'r_front_door': 'door',
            'l_rear_door': 'door', 'r_rear_door': 'door',
            'l_quarter': 'quarter', 'r_quarter': 'quarter',
            'decklid': 'decklid', 'tailgate': 'decklid',
            'l_cab': 'cab', 'r_cab': 'cab',
            'l_bedside': 'bedside', 'r_bedside': 'bedside'
        };

        // Pricing constants
        const OS_PRICE = 50;  // Oversized dent
        const DOS_PRICE = 100; // Double oversized dent
        let showPricing = true;


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.panel-ratings input[type="text"]').forEach(input => {
                const name = input.name;
                const parentLabel = input.closest('label');
                if (!parentLabel) return;

                if (name.endsWith('_dc')) {
                    // Convert DC to range buttons + coin size selector
                    const panelKey = name.replace('_dc', '');
                    const wrapper = document.createElement('div');
                    wrapper.className = 'dc-range-ui';
                    wrapper.innerHTML = `
                        <span class="dc-range-label">Dent Count</span>
                        <div class="dc-range-buttons">
                            ${DC_RANGES.map(range => `
                                <button type="button" class="dc-range-btn" data-range="${range}" data-input="${name}">${range}</button>
                            `).join('')}
                        </div>
                        <input type="hidden" name="${name}" value="">
                        <span class="dc-range-label" style="margin-top: 8px;">Coin Size</span>
                        <div class="coin-size-buttons">
                            ${COIN_SIZES.map(size => `
                                <button type="button" class="coin-btn" data-size="${size}" data-panel="${panelKey}">${COIN_LABELS[size]}</button>
                            `).join('')}
                        </div>
                        <input type="hidden" name="${panelKey}_coin" value="">
                    `;

                    // Add click handlers for DC range
                    wrapper.querySelectorAll('.dc-range-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Deselect siblings
                            wrapper.querySelectorAll('.dc-range-btn').forEach(b => b.classList.remove('selected'));
                            // Select this one
                            btn.classList.add('selected');
                            // Update hidden input
                            wrapper.querySelector(`input[name="${name}"]`).value = btn.dataset.range;
                            // Trigger save and update
                            updateSummary();
                            calculateEstimate();
                            saveDraft();
                        });
                    });

                    // Add click handlers for Coin Size
                    wrapper.querySelectorAll('.coin-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Deselect siblings
                            wrapper.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('selected'));
                            // Select this one
                            btn.classList.add('selected');
                            // Update hidden input
                            wrapper.querySelector(`input[name="${panelKey}_coin"]`).value = btn.dataset.size;
                            // Trigger update
                            calculateEstimate();
                            saveDraft();
                        });
                    });

                    parentLabel.parentNode.insertBefore(wrapper, parentLabel);
                    parentLabel.remove();

                } else if (name.endsWith('_os')) {
                    // Keep OS as stepper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'stepper-ui';
                    wrapper.innerHTML = `
                        <span class="st-label">OS</span>
                        <button type="button" class="st-btn" onclick="adjustStepper('${name}', -1)">‚àí</button>
                    `;
                    input.classList.add('st-input');
                    wrapper.appendChild(input);

                    const plusBtn = document.createElement('button');
                    plusBtn.type = 'button';
                    plusBtn.className = 'st-btn';
                    plusBtn.innerHTML = '+';
                    plusBtn.onclick = function () { adjustStepper(name, 1); };
                    wrapper.appendChild(plusBtn);

                    parentLabel.parentNode.insertBefore(wrapper, parentLabel);
                    parentLabel.remove();
                }
            });

            // Camera handler
            document.getElementById('cameraInput').addEventListener('change', handlePhotoSelect);

            // Inject "Done" and "UPD" Toggles
            initPanelToggles();

            // Initialize Auto-Save
            initAutoSave();
        });

        function initPanelToggles() {
            document.querySelectorAll('.panel-box').forEach(box => {
                const header = box.querySelector('.panel-header');
                if (!header) return;

                // Derive a unique name for this panel
                const refInput = box.querySelector('input[name]');
                let baseName = "panel";
                if (refInput) {
                    const match = refInput.name.match(/^(.+?)_/);
                    if (match) baseName = match[1];
                }
                const doneName = baseName + "_done";
                const updName = baseName + "_upd";
                const updNotesName = baseName + "_upd_notes";

                // Create Done Toggle
                const doneLabel = document.createElement('label');
                doneLabel.className = 'panel-done-toggle';
                doneLabel.innerHTML = `<input type="checkbox" name="${doneName}" class="done-chk"> Done`;

                const doneChk = doneLabel.querySelector('input');
                doneChk.addEventListener('change', () => {
                    if (doneChk.checked) box.classList.add('is-complete');
                    else box.classList.remove('is-complete');
                    saveDraft();
                });
                header.appendChild(doneLabel);

                // Create UPD Toggle + Notes (at end of panel)
                const updContainer = document.createElement('div');
                updContainer.className = 'upd-container';
                updContainer.innerHTML = `
                    <label class="upd-toggle">
                        <input type="checkbox" name="${updName}">
                        <span>‚ö†Ô∏è UPD (Unrelated Prior Damage)</span>
                    </label>
                    <div class="upd-notes">
                        <textarea name="${updNotesName}" placeholder="Describe the unrelated prior damage..."></textarea>
                    </div>
                `;

                const updChk = updContainer.querySelector('input[type="checkbox"]');
                const updNotes = updContainer.querySelector('.upd-notes');
                const updToggle = updContainer.querySelector('.upd-toggle');

                updChk.addEventListener('change', () => {
                    if (updChk.checked) {
                        box.classList.add('has-upd');
                        updToggle.classList.add('active');
                        updNotes.classList.add('visible');
                    } else {
                        box.classList.remove('has-upd');
                        updToggle.classList.remove('active');
                        updNotes.classList.remove('visible');
                    }
                    saveDraft();
                });

                box.appendChild(updContainer);
            });
        }

        // --- AUTO-SAVE & SUMMARY ---
        const DRAFT_KEY = 'dent_pro_scope_draft';

        function initAutoSave() {
            // Restore if exists
            const saved = localStorage.getItem(DRAFT_KEY);
            if (saved) {
                try {
                    restoreDraft(JSON.parse(saved));
                    console.log('Draft restored');
                } catch (e) {
                    console.error('Error restoring draft', e);
                }
            }
            updateSummary();

            // Listeners for form inputs
            document.getElementById('scopeForm').addEventListener('input', () => {
                saveDraft();
                updateSummary();
            });
            document.getElementById('scopeForm').addEventListener('change', () => {
                saveDraft();
                updateSummary();
            });

            // Add explicit listeners to ALL checkboxes for real-time R&I/R&R updates
            document.querySelectorAll('#scopeForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSummary();
                    saveDraft();
                });
            });
        }

        function saveDraft() {
            const data = {};
            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                if (el.type === 'checkbox') data[el.name] = el.checked;
                else data[el.name] = el.value;
            });
            // Also save header inputs not in form
            const headerIds = ['roNumber', 'estimator', 'insuredName'];
            headerIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) data[id] = el.value;
            });
            localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
            // Show save status briefly
            const statusBox = document.getElementById('saveStatusBox');
            const statusEl = document.getElementById('saveStatus');
            if (statusBox && statusEl) {
                statusBox.style.display = 'flex';
                statusEl.textContent = '‚úì Saved';
                setTimeout(() => {
                    statusBox.style.display = 'none';
                }, 1500);
            }
        }

        function restoreDraft(data) {
            Object.keys(data).forEach(name => {
                const els = document.getElementsByName(name);
                if (els.length > 0) {
                    const el = els[0];
                    if (el.type === 'checkbox') {
                        el.checked = data[name];
                        // Handle Done toggle visual state
                        if (name.endsWith('_done')) {
                            const box = el.closest('.panel-box');
                            if (box && el.checked) box.classList.add('is-complete');
                        }
                        // Handle UPD toggle visual state
                        if (name.endsWith('_upd')) {
                            const box = el.closest('.panel-box');
                            const updToggle = el.closest('.upd-toggle');
                            const updNotes = box?.querySelector('.upd-notes');
                            if (el.checked) {
                                box?.classList.add('has-upd');
                                updToggle?.classList.add('active');
                                updNotes?.classList.add('visible');
                            }
                        }
                    } else if (el.type === 'hidden' && name.endsWith('_dc')) {
                        // Restore range button selection
                        el.value = data[name];
                        const wrapper = el.closest('.dc-range-ui');
                        if (wrapper && data[name]) {
                            const btn = wrapper.querySelector(`[data-range="${data[name]}"]`);
                            if (btn) btn.classList.add('selected');
                        }
                    } else {
                        el.value = data[name];
                    }
                }
                // Restore header inputs by ID
                const elById = document.getElementById(name);
                if (elById && !els.length) {
                    elById.value = data[name];
                }
            });
        }


        function updateSummary() {
            let panelsWithDamage = 0;
            let totalOs = 0;
            let totalRi = 0;
            let totalRr = 0;

            document.querySelectorAll('#scopeForm [name]').forEach(el => {
                const name = el.name;

                // Count R&I checkboxes
                if (el.type === 'checkbox' && name.includes('_ri_') && el.checked) {
                    totalRi++;
                    return;
                }

                // Count R&R checkboxes
                if (el.type === 'checkbox' && name.includes('_rr_') && el.checked) {
                    totalRr++;
                    return;
                }

                // Count panels with DC range selected
                if (el.type === 'hidden' && name.endsWith('_dc') && el.value) {
                    panelsWithDamage++;
                }

                // Sum Oversized values
                if (name.endsWith('_os') && el.value) {
                    totalOs += parseInt(el.value) || 0;
                }
            });

            // Update UI - use panelsWithDamage as the "Dent Count" display showing # of panels
            const dentEl = document.getElementById('liveDentCount');
            const osEl = document.getElementById('liveOsCount');
            const riEl = document.getElementById('liveRiCount');
            const rrEl = document.getElementById('liveRrCount');

            // Helper to animate stat changes
            function animateStat(el, newValue) {
                if (el && el.textContent !== String(newValue)) {
                    el.textContent = newValue;
                    el.classList.add('updated');
                    setTimeout(() => el.classList.remove('updated'), 300);
                }
            }

            animateStat(dentEl, panelsWithDamage);
            animateStat(osEl, totalOs);
            animateStat(riEl, totalRi);
            animateStat(rrEl, totalRr);
        }

        // ==================== PRICING CALCULATOR ====================
        function calculateEstimate() {
            let totalEstimate = 0;

            // Get all panels with DC selected
            document.querySelectorAll('#scopeForm input[type="hidden"][name$="_dc"]').forEach(dcInput => {
                const dcRange = dcInput.value;
                if (!dcRange) return;

                // Get panel name and coin size
                const panelKey = dcInput.name.replace('_dc', '');
                const coinInput = document.querySelector(`input[name="${panelKey}_coin"]`);
                const coinSize = coinInput?.value || 'quarter'; // Default to quarter if not selected

                // Get OS count
                const osInput = document.querySelector(`input[name="${panelKey}_os"]`);
                const osCount = parseInt(osInput?.value) || 0;

                // Look up base price
                const category = PANEL_CATEGORY[panelKey] || 'door';
                const priceTable = PANEL_PRICES[category];

                if (priceTable && priceTable[dcRange] && priceTable[dcRange][coinSize]) {
                    const basePrice = priceTable[dcRange][coinSize];
                    totalEstimate += basePrice;
                }

                // Add OS pricing
                totalEstimate += osCount * OS_PRICE;
            });

            // Update display
            const estimateEl = document.getElementById('estimateTotal');
            if (estimateEl) {
                estimateEl.textContent = '$' + totalEstimate.toLocaleString();
            }
        }

        function toggleEstimate() {
            const bar = document.getElementById('estimateBar');
            const btn = bar.querySelector('.estimate-toggle');

            if (bar.classList.contains('hidden')) {
                bar.classList.remove('hidden');
                btn.textContent = 'üëÅÔ∏è Hide';
            } else {
                bar.classList.add('hidden');
                btn.textContent = 'üëÅÔ∏è Show';
            }
        }

        // NOTE: PRICING moved to DENT WIZARD MATRIX approach (see PANEL_PRICES above)

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            document.getElementById('scopeForm').reset();
            updateSummary();
            // Reset steppers visual? They read input value, so reset() works?
            // Yes, input value becomes "" or default.
            // But we might need to manually set steppers to 0 if reset doesn't trigger 'input' event?
            // Steppers read `input.value`. If `reset()` clears it, the `adjustStepper` reads it next time.
            // But the Visual `input` needs to update? Browser handles reset of inputs. Smart.
        }

        function adjustStepper(name, delta) {
            const input = document.querySelector(`input[name="${name}"]`);
            if (input) {
                let val = parseInt(input.value) || 0;
                val += delta;
                if (val < 0) val = 0;
                input.value = val;

                // Trigger real-time update of stats
                updateSummary();
                calculateEstimate();
                saveDraft();
            }
        }

        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            files.forEach(file => {
                compressImage(file, (compressedBase64, mimeType) => {
                    selectedPhotos.push({
                        base64Data: compressedBase64,
                        mimeType: mimeType,
                        name: file.name
                    });
                    renderPreviews();
                });
            });
            event.target.value = ''; // Reset input
        }

        function renderPreviews() {
            const container = document.getElementById('photoPreviews');
            container.innerHTML = '';
            selectedPhotos.forEach((photo, idx) => {
                const div = document.createElement('div');
                div.className = 'photo-preview';
                div.style.cssText = `
                    width: 80px; height: 100px; position: relative; border-radius: 6px; overflow: hidden; border: 1px solid #444; background: #000;
                    display: inline-block; margin-right: 8px; margin-bottom: 8px;
                `;
                const displayName = photo.label || '';
                div.innerHTML = `
                    <img src="data:${photo.mimeType};base64,${photo.base64Data}" style="width:100%; height:80px; object-fit:cover;">
                    <button onclick="removePhoto(${idx})" style="
                        position: absolute; top: 2px; right: 2px; background: rgba(255,69,58,0.9); color: #fff; border: none; width: 18px; height: 18px; cursor: pointer; font-size: 12px; line-height: 1; border-radius: 50%;
                    ">√ó</button>
                    <input type="text" class="photo-name-input" placeholder="Add label..." value="${displayName}" onchange="updatePhotoName(${idx}, this.value)" onclick="event.stopPropagation()">
                `;
                container.appendChild(div);
            });

            // Update photo count display
            const photoCountEl = document.getElementById('photoCount');
            if (photoCountEl) {
                if (selectedPhotos.length > 0) {
                    photoCountEl.style.display = 'block';
                    photoCountEl.textContent = `üì∏ ${selectedPhotos.length} photo${selectedPhotos.length === 1 ? '' : 's'} ready for upload`;
                } else {
                    photoCountEl.style.display = 'none';
                }
            }

            saveDraft();
        }

        // Update photo upload progress UI
        function updatePhotoUploadProgress(percent, statusText) {
            const statusEl = document.getElementById('photoUploadStatus');
            const progressFill = document.getElementById('photoProgressFill');
            const statusTextEl = document.getElementById('photoStatusText');

            if (statusEl && progressFill && statusTextEl) {
                statusEl.style.display = 'block';
                progressFill.style.width = `${percent}%`;
                statusTextEl.textContent = statusText;
            }
        }

        function hidePhotoUploadProgress() {
            const statusEl = document.getElementById('photoUploadStatus');
            if (statusEl) {
                statusEl.style.display = 'none';
            }
        }

        function updatePhotoName(index, name) {
            if (selectedPhotos[index]) {
                selectedPhotos[index].label = name;
                saveDraft();
            }
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            renderPreviews();
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_SIZE = 1200;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl.split(',')[1], 'image/jpeg');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- UI HELPER FUNCTIONS ---
        function scrollToPanel(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a flash effect
                el.style.transition = 'box-shadow 0.3s ease';
                el.style.boxShadow = '0 0 20px #4CD964';
                setTimeout(() => {
                    el.style.boxShadow = '';
                }, 1000);
            }
        }

        // --- SUBMISSION LOGIC ---
        function submitForm() {
            const submitBtn = document.getElementById('submitBtn');

            // Clear previous validation errors
            clearValidationErrors();

            // Validate RO Number
            const roNumber = document.getElementById('roNumber').value.trim();
            if (!roNumber) {
                showValidationError('roNumber', 'RO Number is required');
                showToast('‚ö†Ô∏è RO Number is required', 'error');
                return;
            }

            // Validate Email or Phone (required for GHL)
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();

            if (!email && !phone) {
                showValidationError('customerEmail', 'Email or phone required');
                showValidationError('customerPhone', 'Email or phone required');
                document.getElementById('emailHint').classList.add('show');
                document.getElementById('phoneHint').classList.add('show');
                showToast('‚ö†Ô∏è Email or Phone is required for GHL submission', 'error');
                // Scroll to the fields
                document.getElementById('customerEmail').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // All validation passed - proceed with submission
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;

            // Photos - skip Google Apps Script if not available (standalone PWA mode)
            if (selectedPhotos.length > 0 && typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler((photoUrls) => {
                        submitData(photoUrls);
                    })
                    .withFailureHandler(err => {
                        showToast('‚ö†Ô∏è Photo upload failed: ' + err, 'error');
                        submitBtn.textContent = 'Submit Scope'; submitBtn.disabled = false;
                    })
                    .uploadMultiplePhotos(selectedPhotos, roNumber);
            } else {
                // PWA mode or no photos - submit without photo upload
                submitData([]);
            }
        }

        // Validation helper functions
        function showValidationError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('validation-error');
                // Also highlight the label
                const label = field.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    label.classList.add('validation-error-label');
                }
            }
        }

        function clearValidationErrors() {
            // Remove all validation error classes
            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('validation-error');
            });
            document.querySelectorAll('.validation-error-label').forEach(el => {
                el.classList.remove('validation-error-label');
            });
            document.querySelectorAll('.validation-hint').forEach(el => {
                el.classList.remove('show');
            });
        }

        // Clear validation when user starts typing in error fields
        document.addEventListener('DOMContentLoaded', function () {
            ['customerEmail', 'customerPhone', 'roNumber'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', function () {
                        this.classList.remove('validation-error');
                        const label = this.previousElementSibling;
                        if (label && label.tagName === 'LABEL') {
                            label.classList.remove('validation-error-label');
                        }
                        // Hide hints when user starts typing
                        const hint = this.nextElementSibling;
                        if (hint && hint.classList.contains('validation-hint')) {
                            hint.classList.remove('show');
                        }
                    });
                }
            });
        });

        // ==================== iOS NATIVE FEATURES ====================

        // Haptic feedback (iOS Safari)
        function haptic(style = 'light') {
            if ('vibrate' in navigator) {
                navigator.vibrate(style === 'heavy' ? 50 : 10);
            }
        }

        // Copy VIN to clipboard
        async function copyVin() {
            const vin = document.getElementById('vin').value.trim().toUpperCase();
            if (!vin) {
                showToast('Enter a VIN first', 'error');
                return;
            }
            try {
                await navigator.clipboard.writeText(vin);
                haptic();
                showToast('VIN copied: ' + vin, 'success');
            } catch (e) {
                // Fallback for older iOS
                const input = document.getElementById('vin');
                input.select();
                document.execCommand('copy');
                showToast('VIN copied!', 'success');
            }
        }

        // ==================== EXPORT TO CSV ====================
        function exportToCSV() {
            haptic();

            const formData = collectFormData();
            const vin = formData.vin || 'Unknown';
            const roNum = formData.roNumber || 'Unknown';
            const vehicle = `${formData.year || ''} ${formData.make || ''} ${formData.model || ''}`.trim() || 'Unknown';

            // CSV Headers
            let csv = 'Panel,Dent Count,Coin Size,Oversized,R&I Parts,R&R Parts,Price,UPD,Notes\n';

            // Panel mapping for display names
            const PANEL_NAMES = {
                'l_fender': 'Left Fender', 'r_fender': 'Right Fender',
                'hood': 'Hood', 'roof': 'Roof', 'cowl': 'Cowl',
                'l_front_door': 'Left Front Door', 'r_front_door': 'Right Front Door',
                'l_rear_door': 'Left Rear Door', 'r_rear_door': 'Right Rear Door',
                'l_quarter': 'Left Quarter', 'r_quarter': 'Right Quarter',
                'decklid': 'Decklid', 'tailgate': 'Tailgate',
                'l_cab': 'Left Cab Corner', 'r_cab': 'Right Cab Corner',
                'l_bedside': 'Left Bedside', 'r_bedside': 'Right Bedside'
            };

            let totalEstimate = 0;

            // Collect panel data
            document.querySelectorAll('#scopeForm input[type="hidden"][name$="_dc"]').forEach(dcInput => {
                const dcRange = dcInput.value;
                if (!dcRange) return;

                const panelKey = dcInput.name.replace('_dc', '');
                const panelName = PANEL_NAMES[panelKey] || panelKey;

                // Get coin size
                const coinInput = document.querySelector(`input[name="${panelKey}_coin"]`);
                const coinSize = coinInput?.value || 'quarter';
                const coinLabel = COIN_LABELS[coinSize] || coinSize;

                // Get OS count
                const osInput = document.querySelector(`input[name="${panelKey}_os"]`);
                const osCount = parseInt(osInput?.value) || 0;

                // Count R&I parts for this panel
                let riCount = 0;
                document.querySelectorAll(`input[name*="${panelKey}_ri_"]`).forEach(cb => {
                    if (cb.checked) riCount++;
                });

                // Count R&R parts for this panel
                let rrCount = 0;
                document.querySelectorAll(`input[name*="${panelKey}_rr_"]`).forEach(cb => {
                    if (cb.checked) rrCount++;
                });

                // Get UPD status
                const updInput = document.querySelector(`input[name="${panelKey}_upd"]`);
                const hasUpd = updInput?.checked ? 'Yes' : 'No';

                // Get UPD notes
                const notesInput = document.querySelector(`textarea[name="${panelKey}_upd_notes"]`);
                const notes = (notesInput?.value || '').replace(/"/g, '""').replace(/\n/g, ' ');

                // Calculate price
                const category = PANEL_CATEGORY[panelKey] || 'door';
                const priceTable = PANEL_PRICES[category];
                let price = 0;
                if (priceTable && priceTable[dcRange] && priceTable[dcRange][coinSize]) {
                    price = priceTable[dcRange][coinSize];
                }
                price += osCount * OS_PRICE;
                totalEstimate += price;

                // Add CSV row
                csv += `"${panelName}","${dcRange}","${coinLabel}",${osCount},${riCount},${rrCount},$${price},"${hasUpd}","${notes}"\n`;
            });

            // Add summary row
            csv += `\n"TOTAL ESTIMATE",,,,,,"$${totalEstimate.toLocaleString()}",,\n`;
            csv += `\n"Vehicle Info:","${vehicle}"\n`;
            csv += `"VIN:","${vin}"\n`;
            csv += `"RO#:","${roNum}"\n`;
            csv += `"Date:","${new Date().toLocaleDateString()}"\n`;

            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `PDR_Scope_${roNum}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast('üìä CSV exported!', 'success');
        }

        // Native iOS Share Sheet
        async function nativeShare() {
            haptic('heavy');

            const formData = collectFormData();
            const roNum = formData.roNumber || 'Unknown';
            const vehicle = [formData.year, formData.make, formData.model].filter(Boolean).join(' ') || 'Vehicle';

            // Build text summary
            let summary = `üöó PDR Scope - RO# ${roNum}\n`;
            summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            summary += `üìã ${vehicle}\n`;
            summary += `VIN: ${formData.vin || 'N/A'}\n`;
            summary += `Carrier: ${formData.insuranceCompany || 'N/A'}\n`;
            summary += `Claim: ${formData.claimNumber || 'N/A'}\n`;
            summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;

            // Add panel damage summary
            let panelCount = 0;
            let totalOS = 0;
            document.querySelectorAll('.panel-box').forEach(box => {
                const dcInput = box.querySelector('input[name$="_dc"]');
                const osInput = box.querySelector('input[name$="_os"]');
                const dcVal = dcInput ? dcInput.value : '';
                const osVal = osInput ? parseInt(osInput.value) || 0 : 0;
                if (dcVal) {
                    const panelName = box.querySelector('.panel-header')?.textContent?.trim() || 'Panel';
                    summary += `‚Ä¢ ${panelName}: ${dcVal} dents`;
                    if (osVal > 0) summary += ` (${osVal} OS)`;
                    summary += '\n';
                    panelCount++;
                    totalOS += osVal;
                }
            });

            if (panelCount > 0) {
                summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                summary += `üìä ${panelCount} panels with damage\n`;
                if (totalOS > 0) summary += `‚ö†Ô∏è ${totalOS} oversized dents\n`;
            }

            // Add notes if any
            const notes = document.getElementById('notes')?.value?.trim();
            if (notes) {
                summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                summary += `üìù Notes: ${notes}\n`;
            }

            // Check if Web Share API is available
            if (navigator.share) {
                try {
                    // Try to share with files (photos) - iOS 15+
                    const shareData = {
                        title: `PDR Scope - RO# ${roNum}`,
                        text: summary
                    };

                    // Add photos if available and supported
                    if (selectedPhotos.length > 0 && navigator.canShare) {
                        const files = [];
                        for (let i = 0; i < selectedPhotos.length; i++) {
                            const photo = selectedPhotos[i];
                            const blob = base64ToBlob(photo.base64Data, photo.mimeType);
                            const fileName = photo.label || `photo_${i + 1}`;
                            files.push(new File([blob], `${fileName}.jpg`, { type: photo.mimeType }));
                        }

                        if (navigator.canShare({ files })) {
                            shareData.files = files;
                        }
                    }

                    await navigator.share(shareData);
                    showToast('Shared successfully!', 'success');
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        // User didn't cancel, show fallback
                        fallbackShare(summary);
                    }
                }
            } else {
                // Fallback for older browsers
                fallbackShare(summary);
            }
        }

        // Fallback: Copy to clipboard
        function fallbackShare(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Scope copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Could not share', 'error');
            });
        }

        // Helper: Convert base64 to Blob
        function base64ToBlob(base64, mimeType) {
            const byteChars = atob(base64);
            const byteNumbers = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) {
                byteNumbers[i] = byteChars.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // =============================================
        // PDF EXPORT FUNCTIONALITY
        // =============================================

        // Global config for PDF export
        let pdfPhotoMode = 'attached'; // 'thumbnails' or 'attached'

        // Toggle export checkbox visual state
        function toggleExportCheckbox(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        // Select photo mode
        function selectPhotoMode(mode) {
            pdfPhotoMode = mode;
            document.querySelectorAll('.photo-mode-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.mode === mode);
            });
        }

        // =============================================
        // PHOTO PAGES FOR PDF (2x2 grid with labels)
        // =============================================

        async function addPhotoPages(pdf, photos) {
            const photosPerPage = 4;
            const pageWidth = 612;  // letter size in points
            const pageHeight = 792;
            const margin = 10;
            const photoWidth = (pageWidth - margin * 3) / 2;
            const photoHeight = (pageHeight - margin * 3) / 2;

            for (let i = 0; i < photos.length; i++) {
                // Add new page for every 4 photos
                if (i % photosPerPage === 0) {
                    pdf.addPage();
                    // Set dark background for photo pages
                    pdf.setFillColor(26, 26, 26); // #1a1a1a
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                }

                const photo = photos[i];
                const posInGrid = i % photosPerPage;
                const col = posInGrid % 2;
                const row = Math.floor(posInGrid / 2);

                const x = margin + col * (photoWidth + margin);
                const y = margin + row * (photoHeight + margin);

                // Add photo with label
                await addPhotoWithLabel(pdf, photo, x, y, photoWidth, photoHeight);
            }
        }

        async function addPhotoWithLabel(pdf, photo, x, y, width, height) {
            try {
                // Create image from base64
                const imgData = `data:${photo.mimeType};base64,${photo.base64Data}`;

                // Add image to PDF
                pdf.addImage(imgData, 'JPEG', x, y, width, height - 25, undefined, 'FAST');

                // Add dark banner for label at bottom
                const labelHeight = 25;
                pdf.setFillColor(0, 0, 0);
                pdf.rect(x, y + height - labelHeight, width, labelHeight, 'F');

                // Add green accent line at top of label
                pdf.setDrawColor(76, 217, 100); // #4CD964
                pdf.setLineWidth(2);
                pdf.line(x, y + height - labelHeight, x + width, y + height - labelHeight);

                // Add label text
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                const label = photo.label || 'Unlabeled Photo';
                pdf.text(label, x + 8, y + height - 8);
            } catch (err) {
                console.error('Error adding photo to PDF:', err);
            }
        }

        // =============================================
        // AIRTABLE INTEGRATION
        // =============================================

        const AIRTABLE_QUEUE_KEY = 'airtable_upload_queue';
        let airtableConfig = null;
        let fullConfig = null;

        // Load full config (Airtable + Google Drive)
        async function loadFullConfig() {
            if (fullConfig) return fullConfig;
            try {
                const response = await fetch('config.json?t=' + Date.now());
                fullConfig = await response.json();
                airtableConfig = fullConfig.airtable;
                return fullConfig;
            } catch (err) {
                console.error('Failed to load config:', err);
                return null;
            }
        }

        // Load Airtable config
        async function loadAirtableConfig() {
            if (airtableConfig) return airtableConfig;
            const config = await loadFullConfig();
            return config?.airtable || null;
        }

        // =============================================
        // AIRTABLE FIELD MANAGEMENT
        // =============================================

        // Cache to track which fields we've already checked/created
        let airtableFieldsChecked = false;

        /**
         * Ensure required fields exist in Airtable table
         * Creates "Photo Package" (attachment) and "Photo Count" (number) fields if missing
         */
        async function ensureAirtableFields(config) {
            // Only check once per session
            if (airtableFieldsChecked) {
                console.log('‚ÑπÔ∏è Airtable fields already verified this session');
                return true;
            }

            try {
                console.log('üîç Checking Airtable table schema...');

                // First, get current table schema to see what fields exist
                const tableId = config.tableId;
                const baseId = config.baseId;

                if (!tableId) {
                    console.warn('‚ö†Ô∏è No tableId in config - cannot auto-create fields');
                    console.log('Add "tableId": "tblXXXXXX" to your config.json');
                    return false;
                }

                // Get table schema (list fields)
                const schemaUrl = `https://api.airtable.com/v0/meta/bases/${baseId}/tables`;
                const schemaRes = await fetch(schemaUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`
                    }
                });

                if (!schemaRes.ok) {
                    const errText = await schemaRes.text();
                    console.warn('‚ö†Ô∏è Cannot read schema (may need schema.bases:read scope):', errText);
                    // Continue anyway - field creation will fail if fields don't exist
                    airtableFieldsChecked = true;
                    return true;
                }

                const schemaData = await schemaRes.json();
                const table = schemaData.tables?.find(t => t.id === tableId || t.name === config.tableName);

                if (!table) {
                    console.warn('‚ö†Ô∏è Table not found in schema');
                    return false;
                }

                const existingFields = table.fields?.map(f => f.name) || [];
                console.log('üìã Existing fields:', existingFields.join(', '));

                // Fields we need
                const requiredFields = [
                    { name: 'Photo Package', type: 'multipleAttachments' },
                    { name: 'Photo Count', type: 'number', options: { precision: 0 } }
                ];

                // Create missing fields
                for (const field of requiredFields) {
                    if (!existingFields.includes(field.name)) {
                        console.log(`‚ûï Creating missing field: ${field.name}`);

                        const createUrl = `https://api.airtable.com/v0/meta/bases/${baseId}/tables/${tableId}/fields`;
                        const fieldBody = {
                            name: field.name,
                            type: field.type
                        };
                        if (field.options) {
                            fieldBody.options = field.options;
                        }

                        const createRes = await fetch(createUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${config.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(fieldBody)
                        });

                        if (createRes.ok) {
                            const created = await createRes.json();
                            console.log(`‚úÖ Created field: ${created.name} (${created.type})`);
                        } else {
                            const errText = await createRes.text();
                            console.warn(`‚ö†Ô∏è Failed to create ${field.name}:`, errText);
                            // If it's a permission error, the API key may not have schema.bases:write
                            if (errText.includes('NOT_AUTHORIZED') || errText.includes('FORBIDDEN')) {
                                console.log('üí° Tip: Your API token needs "schema.bases:write" scope');
                                console.log('   Create a new token at https://airtable.com/create/tokens');
                            }
                        }
                    } else {
                        console.log(`‚úì Field exists: ${field.name}`);
                    }
                }

                airtableFieldsChecked = true;
                return true;

            } catch (err) {
                console.error('Field check error:', err);
                // Don't block upload on field check errors
                return true;
            }
        }

        // =============================================
        // PHOTO ZIP & UPLOAD FUNCTIONS
        // =============================================

        /**
         * Compress all selected photos into a ZIP file
         * @returns {Promise<Blob>} ZIP file blob
         */
        async function createPhotosZip(roNumber) {
            if (typeof JSZip === 'undefined') {
                throw new Error('JSZip library not loaded');
            }
            if (selectedPhotos.length === 0) {
                return null;
            }

            const zip = new JSZip();
            const timestamp = new Date().toISOString().slice(0, 10);
            const folderName = `photos_${roNumber || 'draft'}_${timestamp}`;
            const folder = zip.folder(folderName);

            // Add each photo to the zip
            for (let i = 0; i < selectedPhotos.length; i++) {
                const photo = selectedPhotos[i];
                const label = photo.label || `photo_${i + 1}`;
                // Clean filename (remove special chars)
                const safeLabel = label.replace(/[^a-zA-Z0-9_-]/g, '_');
                const filename = `${String(i + 1).padStart(2, '0')}_${safeLabel}.jpg`;

                // Convert base64 to binary
                const binaryData = atob(photo.base64Data);
                const bytes = new Uint8Array(binaryData.length);
                for (let j = 0; j < binaryData.length; j++) {
                    bytes[j] = binaryData.charCodeAt(j);
                }

                folder.file(filename, bytes, { binary: true });
            }

            // Generate ZIP blob
            const zipBlob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });

            console.log(`üì¶ Created ZIP: ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB with ${selectedPhotos.length} photos`);
            return zipBlob;
        }

        /**
         * Upload ZIP file to a temporary hosting service
         * Returns a public URL that Airtable can access
         * Note: tmpfiles.org is primary (0x0.st has CORS issues from localhost)
         */
        async function uploadZipToHost(zipBlob, filename) {
            // Service 1: tmpfiles.org (reliable, good CORS)
            try {
                console.log('üì§ Uploading ZIP to tmpfiles.org...');
                const fd = new FormData();
                fd.append('file', zipBlob, filename);

                const res = await fetch('https://tmpfiles.org/api/v1/upload', {
                    method: 'POST',
                    body: fd
                });

                if (res.ok) {
                    const json = await res.json();
                    if (json.status === 'success' && json.data?.url) {
                        const url = json.data.url.replace('tmpfiles.org/', 'tmpfiles.org/dl/');
                        console.log('‚úÖ ZIP uploaded to tmpfiles.org:', url);
                        return url;
                    }
                }
            } catch (e) {
                console.warn('tmpfiles.org failed:', e.message);
            }

            // Service 2: file.io fallback (1 download limit but reliable)
            try {
                console.log('üì§ Trying file.io fallback...');
                const fd = new FormData();
                fd.append('file', zipBlob, filename);

                const res = await fetch('https://file.io', {
                    method: 'POST',
                    body: fd
                });

                if (res.ok) {
                    const json = await res.json();
                    if (json.success && json.link) {
                        console.log('‚úÖ ZIP uploaded to file.io:', json.link);
                        return json.link;
                    }
                }
            } catch (e) {
                console.warn('file.io failed:', e.message);
            }

            console.error('‚ùå All upload services failed');
            return null;
        }

        /**
         * Photo ZIP Upload - Uses tmpfiles.org as transfer service
         * Airtable downloads and stores files permanently on their servers
         * No login required!
         */

        // Stub functions (Google Drive disabled - using direct upload instead)
        function initGoogleAuth() { }
        function handleAuthClick() { }

        /**
         * Skip Google Drive - go straight to tmpfiles.org upload
         * Airtable will download and permanently store the file
         */
        async function uploadToGoogleDrive(zipBlob, filename) {
            // Not using Google Drive - Airtable stores files permanently after downloading from tmpfiles.org
            console.log('‚ÑπÔ∏è Using direct upload (tmpfiles.org ‚Üí Airtable permanent storage)');
            return null;
        }



        // Upload to Airtable with PDF attachment (Hybrid: Drive or file.io)
        async function uploadToAirtable() {
            try {
                haptic('medium');
                showToast('üìÑ Generating PDF...', 'info');

                const config = await loadAirtableConfig();
                if (!config) {
                    throw new Error('Airtable config not found. Check config.json');
                }

                // Ensure required fields exist before uploading
                await ensureAirtableFields(config);

                const formData = collectFormData();

                // Step 1: Generate PDF
                let pdfUrl = null;
                let pdfBase64 = null; // For GAS
                let pdfBlob = null;   // For file.io

                try {
                    if (typeof window.jspdf !== 'undefined') {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

                        // -- PDF GENERATION LOGIC --
                        // Summary Page
                        pdf.setFillColor(30, 30, 30);
                        pdf.rect(0, 0, 612, 792, 'F');
                        pdf.setFontSize(24);
                        pdf.setTextColor(76, 217, 100);
                        pdf.text('DENT EXPERTS', 40, 50);
                        pdf.setFontSize(12);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text('PDR Damage Assessment Report', 40, 70);

                        // Fields
                        pdf.setFontSize(14);
                        let y = 120;
                        const fields = [
                            ['RO Number', formData.roNumber || 'N/A'],
                            ['VIN', formData.vin || 'N/A'],
                            ['Vehicle', `${formData.year || ''} ${formData.make || ''} ${formData.model || ''}`],
                            ['Color', formData.color || 'N/A'],
                            ['Odometer', formData.odometer || 'N/A'],
                            ['Customer', formData.insuredName || 'N/A'],
                            ['Insurance', formData.insuranceCompany || 'N/A'],
                            ['Claim #', formData.claimNumber || 'N/A'],
                            ['Location', formData.location || 'N/A'],
                            ['Estimator', formData.estimator || 'N/A'],
                            ['Photos', `${selectedPhotos.length} attached`]
                        ];
                        fields.forEach(([label, value]) => {
                            pdf.setTextColor(100, 100, 100);
                            pdf.text(label + ':', 40, y);
                            pdf.setTextColor(255, 255, 255);
                            pdf.text(String(value), 180, y);
                            y += 26;
                        });

                        // Notes
                        if (formData.notes) {
                            y += 20;
                            pdf.setTextColor(100, 100, 100);
                            pdf.text('Notes:', 40, y);
                            y += 20;
                            pdf.setTextColor(200, 200, 200);
                            pdf.setFontSize(11);
                            pdf.text(pdf.splitTextToSize(formData.notes, 520), 40, y);
                        }

                        // Footer
                        pdf.setFontSize(10);
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(`Generated: ${new Date().toLocaleString()}`, 40, 760);

                        // Photos (2x2)
                        if (selectedPhotos.length > 0) {
                            const pageWidth = 612, pageHeight = 792, margin = 15;
                            const photoWidth = (pageWidth - margin * 3) / 2;
                            const photoHeight = (pageHeight - margin * 3) / 2;

                            for (let i = 0; i < selectedPhotos.length; i++) {
                                if (i % 4 === 0) {
                                    pdf.addPage();
                                    pdf.setFillColor(26, 26, 26);
                                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                                }
                                const photo = selectedPhotos[i];
                                const pos = i % 4, col = pos % 2, row = Math.floor(pos / 2);
                                const x = margin + col * (photoWidth + margin);
                                const py = margin + row * (photoHeight + margin);

                                try {
                                    const imgData = `data:${photo.mimeType};base64,${photo.base64Data}`;
                                    pdf.addImage(imgData, 'JPEG', x, py, photoWidth, photoHeight - 25, undefined, 'FAST');
                                    pdf.setFillColor(0, 0, 0);
                                    pdf.rect(x, py + photoHeight - 25, photoWidth, 25, 'F');
                                    pdf.setDrawColor(76, 217, 100);
                                    pdf.setLineWidth(2);
                                    pdf.line(x, py + photoHeight - 25, x + photoWidth, py + photoHeight - 25);
                                    pdf.setTextColor(255, 255, 255);
                                    pdf.setFontSize(10);
                                    pdf.text(photo.label || 'Photo ' + (i + 1), x + 8, py + photoHeight - 8);
                                } catch (e) {
                                    console.error('Photo error:', e);
                                }
                            }
                        }

                        // Generate Outputs
                        pdfBlob = pdf.output('blob');
                        // For GAS we need base64 string without data uri prefix
                        const dataUri = pdf.output('datauristring');
                        pdfBase64 = dataUri.split(',')[1];
                    }
                } catch (pdfErr) {
                    console.error('PDF generation error:', pdfErr);
                    showToast('‚ö†Ô∏è PDF creation failed', 'warning');
                }

                // Step 2: Upload Strategy (Hybrid)
                if (pdfBase64 && typeof google !== 'undefined' && google.script && google.script.run) {
                    // --- STRATEGY A: Google Drive (Persistent) ---
                    showToast('üíæ Saving to Google Drive...', 'info');
                    try {
                        const driveResult = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .uploadPDFToDrive({
                                    base64: pdfBase64,
                                    filename: `${formData.roNumber || 'Scope'}_Assessment.pdf`
                                });
                        });

                        if (driveResult && driveResult.success) {
                            pdfUrl = driveResult.url;
                            console.log('Uploaded to Drive:', pdfUrl);
                            showToast('‚úÖ Saved to Drive', 'success');
                        } else {
                            throw new Error(driveResult.error || 'Drive upload failed');
                        }
                    } catch (driveErr) {
                        console.error('Drive upload error:', driveErr);
                        showToast('‚ö†Ô∏è Drive save failed, trying fallback...', 'warning');
                        // Fallback to file.io logic below if Drive fails?
                        // If blob exists, we can fall through.
                    }
                }


                // Step 2: Upload Strategy (Hybrid)
                if (pdfBase64 && typeof google !== 'undefined' && google.script && google.script.run) {
                    // ... (Drive logic unchanged) ...
                }

                // --- PDF Transport (tmpfiles.org - reliable with good CORS) ---
                if (!pdfUrl && pdfBlob) {
                    showToast('üöö Transporting PDF...', 'info');

                    const filename = `${formData.roNumber || 'Scope'}_Assessment.pdf`;

                    try {
                        console.log('üì§ Uploading PDF to tmpfiles.org...');
                        const fd = new FormData();
                        fd.append('file', pdfBlob, filename);

                        const res = await fetch('https://tmpfiles.org/api/v1/upload', {
                            method: 'POST',
                            body: fd
                        });

                        if (res.ok) {
                            const json = await res.json();
                            if (json.status === 'success' && json.data?.url) {
                                // Convert view URL to direct download URL
                                pdfUrl = json.data.url.replace('tmpfiles.org/', 'tmpfiles.org/dl/');
                                console.log('‚úÖ PDF uploaded to tmpfiles.org:', pdfUrl);
                            }
                        }
                    } catch (e) {
                        console.warn('tmpfiles.org failed:', e.message);
                    }
                }

                // Verify URL before sending
                if (!pdfUrl) {
                    console.warn('‚ùå NO PDF URL GENERATED - Airtable will not have attachment');
                    showToast('‚ö†Ô∏è PDF upload failed, sending data only', 'warning');
                } else {
                    console.log('‚úÖ Attaching PDF URL to Airtable:', pdfUrl);
                }

                // =============================================
                // Step 2.5: CREATE AND UPLOAD PHOTO ZIP
                // =============================================
                let photoZipUrl = null;

                if (selectedPhotos.length > 0) {
                    try {
                        // Show progress UI
                        updatePhotoUploadProgress(10, `üì¶ Compressing ${selectedPhotos.length} photos...`);
                        showToast(`üì¶ Compressing ${selectedPhotos.length} photos...`, 'info');

                        const zipBlob = await createPhotosZip(formData.roNumber);

                        if (zipBlob) {
                            const zipSizeMB = (zipBlob.size / 1024 / 1024).toFixed(2);
                            console.log(`üì¶ ZIP created: ${zipSizeMB} MB`);

                            updatePhotoUploadProgress(40, `üì§ Uploading ${zipSizeMB}MB photo package...`);
                            showToast(`üì§ Uploading ${zipSizeMB}MB photo package...`, 'info');

                            const timestamp = new Date().toISOString().slice(0, 10);
                            const zipFilename = `photos_${formData.roNumber || 'scope'}_${timestamp}.zip`;

                            // Try Google Drive first if configured
                            updatePhotoUploadProgress(50, 'üîó Connecting to upload service...');
                            photoZipUrl = await uploadToGoogleDrive(zipBlob, zipFilename);

                            // Fallback to temporary hosting services
                            if (!photoZipUrl) {
                                updatePhotoUploadProgress(60, 'üì§ Uploading to backup service...');
                                photoZipUrl = await uploadZipToHost(zipBlob, zipFilename);
                            }

                            if (photoZipUrl) {
                                updatePhotoUploadProgress(100, '‚úÖ Photos uploaded successfully!');
                                console.log('‚úÖ Photo ZIP uploaded:', photoZipUrl);
                                showToast('‚úÖ Photos uploaded!', 'success');
                            } else {
                                updatePhotoUploadProgress(0, '‚ùå Upload failed');
                                console.warn('‚ö†Ô∏è Photo ZIP upload failed');
                                showToast('‚ö†Ô∏è Photo upload failed, continuing...', 'warning');
                            }
                        }
                    } catch (zipErr) {
                        console.error('Photo ZIP error:', zipErr);
                        updatePhotoUploadProgress(0, '‚ùå Compression failed');
                        showToast('‚ö†Ô∏è Photo compression failed', 'warning');
                    }
                }

                // Step 3: Airtable Data
                showToast('‚òÅÔ∏è Sending to Airtable...', 'info');
                // ... (Panel Data logic) ...
                const panelData = {};
                // ... (Reconstruct panelData logic to be safe)
                const panels = ['hood', 'l_fender', 'r_fender', 'l_front_door', 'r_front_door',
                    'l_rear_door', 'r_rear_door', 'l_quarter', 'r_quarter', 'roof',
                    'cowl', 'decklid', 'l_cab', 'r_cab', 'l_bedside', 'r_bedside'];
                panels.forEach(panel => {
                    panelData[panel] = {
                        dc: formData[`${panel}_dc`] || '',
                        os: formData[`${panel}_os`] || '0',
                        coin: formData[`${panel}_coin`] || '',
                        done: formData[`${panel}_done`] || false
                    };
                });

                const record = {
                    fields: {
                        'RO Number': formData.roNumber || '',
                        'VIN': formData.vin || '',
                        'Year': formData.year || '',
                        'Make': formData.make || '',
                        'Model': formData.model || '',
                        'Customer Name': formData.insuredName || '',
                        'Insurance Company': formData.insuranceCompany || '',
                        // ... Basic fields ...
                        'Estimator': formData.estimator || '',
                        'Color': formData.color || '',
                        'Odometer': formData.odometer || '',
                        'Claim Number': formData.claimNumber || '',
                        'Location': formData.location || '',
                        'Notes': formData.notes || '',
                        'Status': 'Submitted',
                        'Submitted At': new Date().toISOString(),
                        'Panel Data': JSON.stringify(panelData, null, 2)
                    }
                };

                // Attach PDF Link
                if (pdfUrl) {
                    // Airtable Attachment Format
                    // record.fields['PDF Report'] = [
                    //     { url: pdfUrl }
                    // ];
                }

                // Attach Photo Package ZIP
                if (photoZipUrl) {
                    record.fields['Photo Package'] = [
                        { url: photoZipUrl }
                    ];
                    record.fields['Photo Count'] = selectedPhotos.length;
                }

                console.log('Sending Record:', JSON.stringify(record, null, 2));

                const endpoint = `https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.tableName)}`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(record)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Airtable Error Response:', errorText);
                    throw new Error('Airtable Error: ' + errorText);
                }

                const result = await response.json();
                console.log('Airtable Success:', result);
                showToast('‚úÖ Uploaded to Airtable!', 'success');
                haptic('success');
                return result;

            } catch (err) {
                console.error('Airtable upload error:', err);
                showToast('‚ùå Upload failed: ' + err.message, 'error');
                if (!navigator.onLine) queueAirtableUpload(collectFormData());
                return null;
            }
        }

        // Queue upload for offline
        function queueAirtableUpload(formData) {
            const queue = JSON.parse(localStorage.getItem(AIRTABLE_QUEUE_KEY) || '[]');
            queue.push({
                id: Date.now(),
                formData,
                photos: selectedPhotos.map(p => ({ label: p.label, name: p.name })), // Just metadata, not full base64
                timestamp: new Date().toISOString(),
                status: 'pending'
            });
            localStorage.setItem(AIRTABLE_QUEUE_KEY, JSON.stringify(queue));
        }

        // Process queue when online
        async function processAirtableQueue() {
            if (!navigator.onLine) return;

            const queue = JSON.parse(localStorage.getItem(AIRTABLE_QUEUE_KEY) || '[]');
            const pending = queue.filter(i => i.status === 'pending');

            if (pending.length === 0) return;

            showToast(`‚òÅÔ∏è Syncing ${pending.length} queued uploads...`, 'info');

            for (const item of pending) {
                try {
                    // Note: This would need to restore photos from IndexedDB for full upload
                    await uploadToAirtable(); // Simplified - uses current form data
                    item.status = 'completed';
                } catch (err) {
                    item.status = 'failed';
                    item.error = err.message;
                }
            }

            localStorage.setItem(AIRTABLE_QUEUE_KEY, JSON.stringify(queue));
        }

        // Listen for online event to sync
        window.addEventListener('online', () => {
            showToast('üì∂ Back online!', 'success');
            processAirtableQueue();
        });

        window.addEventListener('offline', () => {
            showToast('üì¥ You are offline. Data will sync when connected.', 'info');
        });

        // Main PDF generation function
        async function generatePDF() {
            try {
                haptic('medium');

                // Disable button and show loading
                const exportBtn = document.querySelector('.export-btn');
                const originalHTML = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span class="spinner"></span> Generating PDF...';

                // Collect form data
                const formData = collectFormData();

                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('PDF library not loaded. Please refresh the page.');
                }

                // Populate the hidden template
                populatePDFTemplate(formData);

                // Wait a bit for DOM to update
                await new Promise(resolve => setTimeout(resolve, 100));

                // Render template to canvas
                const template = document.getElementById('pdfTemplate');
                const canvas = await html2canvas(template, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: 612,
                    height: 792
                });

                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'letter'
                });

                // Add rendered image to PDF
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, 612, 792);

                // === ADD PHOTO PAGES (4 photos per page, 2x2 grid) ===
                if (selectedPhotos.length > 0) {
                    await addPhotoPages(pdf, selectedPhotos);
                }

                // Share or download PDF
                await sharePDF(pdf, formData);

                // Reset button
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalHTML;

            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('‚ùå PDF generation failed: ' + error.message, 'error');

                // Reset button
                const exportBtn = document.querySelector('.export-btn');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span>üìÑ</span> Export as PDF';
            }
        }

        // Populate PDF template with form data
        function populatePDFTemplate(formData) {
            // Header info
            document.getElementById('pdf-ro').textContent = formData.roNumber || 'N/A';
            document.getElementById('pdf-estimator').textContent = formData.estimator || 'N/A';
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();

            // Vehicle info
            document.getElementById('pdf-vin').textContent = formData.vin || '';
            document.getElementById('pdf-year').textContent = formData.year || '';
            document.getElementById('pdf-make').textContent = formData.make || '';
            document.getElementById('pdf-model').textContent = formData.model || '';
            document.getElementById('pdf-color').textContent = formData.color || '';
            document.getElementById('pdf-trim').textContent = formData.trim || '';
            document.getElementById('pdf-insured').textContent = formData.insuredName || '';
            document.getElementById('pdf-carrier').textContent = formData.insuranceCompany || '';
            document.getElementById('pdf-claim').textContent = formData.claimNumber || '';
            document.getElementById('pdf-odometer').textContent = formData.odometer || '';

            // Damage assessment table
            const includeTable = document.getElementById('includeTextVersion').checked;
            const damageSection = document.getElementById('pdf-damage-section');

            if (includeTable) {
                damageSection.style.display = 'block';
                const tbody = document.getElementById('pdf-panel-rows');
                tbody.innerHTML = '';

                // Get all panels with damage
                const panels = [];
                document.querySelectorAll('.panel-box').forEach(box => {
                    const panelName = box.querySelector('.panel-header')?.textContent?.trim() || '';
                    const dcInput = box.querySelector('input[name$="_dc"]');
                    const osInput = box.querySelector('input[name$="_os"]');
                    const dcVal = dcInput ? dcInput.value : '';
                    const osVal = osInput ? osInput.value : '';

                    // Get R&I items
                    const riItems = [];
                    box.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                        const label = cb.closest('.checkbox-item')?.querySelector('span')?.textContent?.trim();
                        if (label && !label.includes('R&R')) {
                            riItems.push(label);
                        }
                    });

                    // Get R&R status
                    const rrCheckbox = box.querySelector('input[name$="_rr"]');
                    const rrChecked = rrCheckbox ? rrCheckbox.checked : false;

                    // Only add panels with some damage
                    if (dcVal || osVal || riItems.length > 0 || rrChecked) {
                        panels.push({
                            name: panelName,
                            dc: dcVal || '-',
                            os: osVal || '-',
                            ri: riItems.join(', ') || '-',
                            rr: rrChecked ? '‚úì' : ''
                        });
                    }
                });

                // Add rows to table
                panels.forEach(panel => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${panel.name}</td>
                        <td style="text-align: center;">${panel.dc}</td>
                        <td style="text-align: center;">${panel.os}</td>
                        <td>${panel.ri}</td>
                        <td style="text-align: center;">${panel.rr}</td>
                    `;
                    tbody.appendChild(row);
                });

                // If no panels, add a note
                if (panels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No damage recorded</td></tr>';
                }
            } else {
                damageSection.style.display = 'none';
            }

            // Photos section
            const photosSection = document.getElementById('pdf-photos-section');
            const photoGrid = document.getElementById('pdf-photo-grid');

            if (pdfPhotoMode === 'thumbnails' && selectedPhotos.length > 0) {
                photosSection.style.display = 'block';
                photoGrid.innerHTML = '';

                // Add up to 6 photos as thumbnails
                const photosToShow = selectedPhotos.slice(0, 6);
                photosToShow.forEach(photo => {
                    const img = document.createElement('img');
                    img.src = photo.data;
                    img.style.width = '100%';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    photoGrid.appendChild(img);
                });
            } else if (selectedPhotos.length > 0) {
                photosSection.style.display = 'block';
                photoGrid.innerHTML = `<p style="font-size: 8pt; color: #666; margin: 0;">${selectedPhotos.length} photo(s) attached separately</p>`;
            } else {
                photosSection.style.display = 'none';
            }

            // Notes
            const notesSection = document.getElementById('pdf-notes-section');
            const notesText = document.getElementById('pdf-notes-text');
            const notes = document.getElementById('notes')?.value?.trim() || '';

            if (notes) {
                notesSection.style.display = 'block';
                notesText.textContent = notes;
            } else {
                notesSection.style.display = 'none';
            }

            // Timestamp
            document.getElementById('pdf-timestamp').textContent = new Date().toLocaleString();
        }

        // Share PDF using iOS Share Sheet or download
        async function sharePDF(pdf, formData) {
            // Create filename
            const timestamp = new Date().toISOString().slice(0, 10);
            const roNum = formData.roNumber || 'draft';
            const fileName = `DentScope_${roNum}_${timestamp}.pdf`;

            // Convert PDF to Blob
            const pdfBlob = pdf.output('blob');
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            // Check if Web Share API is supported
            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                try {
                    const filesToShare = [pdfFile];

                    // If photos attached mode, add photo files
                    if (pdfPhotoMode === 'attached' && selectedPhotos.length > 0) {
                        for (let i = 0; i < selectedPhotos.length; i++) {
                            const photo = selectedPhotos[i];
                            // Convert base64 to File
                            const photoFile = base64ToFile(
                                photo.data,
                                photo.name || `Photo_${i + 1}.jpg`,
                                'image/jpeg'
                            );
                            filesToShare.push(photoFile);
                        }
                    }

                    // Open iOS Share Sheet
                    await navigator.share({
                        title: `Dent Scope - ${roNum}`,
                        text: `PDR Scope for ${formData.insuredName || 'Customer'}`,
                        files: filesToShare
                    });

                    showToast('‚úÖ PDF shared successfully!', 'success');
                    haptic('success');

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Share failed:', error);
                        // Fallback to download
                        fallbackDownloadPDF(pdf, fileName);
                    }
                    // If AbortError, user cancelled - do nothing
                }
            } else {
                // Fallback for non-supporting browsers
                fallbackDownloadPDF(pdf, fileName);
            }
        }

        // Fallback: Download PDF
        function fallbackDownloadPDF(pdf, fileName) {
            pdf.save(fileName);
            showToast('üì• PDF downloaded', 'success');
            haptic('success');
        }

        // Helper: Convert base64 to File object
        function base64ToFile(base64Data, filename, mimeType) {
            // Remove data URL prefix if present
            const base64 = base64Data.includes(',') ? base64Data.split(',')[1] : base64Data;

            // Decode base64
            const byteString = atob(base64);
            const arrayBuffer = new ArrayBuffer(byteString.length);
            const uint8Array = new Uint8Array(arrayBuffer);

            for (let i = 0; i < byteString.length; i++) {
                uint8Array[i] = byteString.charCodeAt(i);
            }

            // Create File
            return new File([uint8Array], filename, { type: mimeType });
        }


        // 2. Submit Data Function
        // ==================== GHL API CONFIGURATION ====================
        const GHL_CONFIG = {
            accessToken: 'pit-a8576171-f084-46c5-8b31-e8bd0d05da79',
            locationId: 'AAzBZNLXS4rdwhG76MLi',
            baseUrl: 'https://services.leadconnectorhq.com',
            pipelines: {
                production: {
                    id: 'JptjUQHom2aW3y3MGc2g',
                    startStage: 'abf22448-51ea-474f-bac1-e4edd981f8e3'
                },
                expert_path: {
                    id: 'zLqAUFVD2Bfub4EP54lL',
                    startStage: 'f62deed6-d81c-4e31-98aa-af54d5646596'
                }
            },
            customFields: {
                vin: 'qKQntVqCwKdmmPaHLnr6',
                year_make_model: 'IEQTtksAvzxZMTR2EeHJ',
                insurance_company: 'wcjFn8HG8fhssQWn0TFM',
                claim_number: 'Y8BZnpg3SgTCaF6eNcwt',
                technician_name: 'XOdGZsGCmyjFmZO1eHsw',
                ro_number: 'cHqj3TzHR1qipS5zXv4L'
            }
        };

        // ==================== GHL API FUNCTIONS ====================
        async function submitToGHL(formData, pipelineKey = 'production') {
            try {
                // Step 1: Create or find contact
                const contact = await upsertGHLContact(formData);
                if (!contact.success) {
                    throw new Error(contact.error || 'Failed to create contact');
                }

                // Step 2: Create opportunity
                const opportunity = await createGHLOpportunity(formData, contact.contactId, pipelineKey);

                return {
                    success: true,
                    contactId: contact.contactId,
                    opportunityId: opportunity.opportunityId
                };
            } catch (error) {
                console.error('GHL Error:', error);
                return { success: false, error: error.message };
            }
        }



        function getGHLCustomFields(formData) {
            const customFields = [];
            if (formData.vin) customFields.push({ id: GHL_CONFIG.customFields.vin, value: formData.vin });

            // Combined Year Make Model
            const ymm = [formData.year, formData.make, formData.model].filter(Boolean).join(' ');
            if (ymm) customFields.push({ id: GHL_CONFIG.customFields.year_make_model, value: ymm });

            if (formData.insurance) customFields.push({ id: GHL_CONFIG.customFields.insurance_company, value: formData.insurance });
            if (formData.claimNumber) customFields.push({ id: GHL_CONFIG.customFields.claim_number, value: formData.claimNumber });
            if (formData.estimator) customFields.push({ id: GHL_CONFIG.customFields.technician_name, value: formData.estimator });
            if (formData.roNumber) customFields.push({ id: GHL_CONFIG.customFields.ro_number, value: formData.roNumber });

            return customFields;
        }

        async function upsertGHLContact(formData) {
            const email = formData.customerEmail;
            const phone = formData.customerPhone;

            if (!email && !phone) {
                return { success: false, error: 'Email or phone required' };
            }

            const nameParts = (formData.insuredName || '').split(' ');
            const firstName = nameParts[0] || 'Customer';
            const lastName = nameParts.slice(1).join(' ') || '';
            const customFields = getGHLCustomFields(formData);

            const contactPayload = {
                locationId: GHL_CONFIG.locationId,
                firstName: firstName,
                lastName: lastName,
                email: email || undefined,
                phone: phone || undefined,
                source: 'Dent Experts Form',
                customFields: customFields
            };

            // Search for existing contact
            const searchQuery = email || phone;
            try {
                const searchResponse = await fetch(
                    `${GHL_CONFIG.baseUrl}/contacts/search?locationId=${GHL_CONFIG.locationId}&query=${encodeURIComponent(searchQuery)}`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${GHL_CONFIG.accessToken}`,
                            'Version': '2021-07-28'
                        }
                    }
                );

                const searchResult = await searchResponse.json();

                if (searchResult.contacts && searchResult.contacts.length > 0) {
                    const existingId = searchResult.contacts[0].id;
                    console.log('Found existing contact, updating:', existingId);

                    // UPDATE existing contact
                    const updateResponse = await fetch(`${GHL_CONFIG.baseUrl}/contacts/${existingId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${GHL_CONFIG.accessToken}`,
                            'Version': '2021-07-28',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(contactPayload)
                    });
                    const updateResult = await updateResponse.json();
                    console.log('Contact Update Response:', updateResult);

                    return { success: true, contactId: existingId };
                }
            } catch (e) {
                console.error('Search/Update failed, creating new contact', e);
            }

            // Create new contact
            const createResponse = await fetch(`${GHL_CONFIG.baseUrl}/contacts/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GHL_CONFIG.accessToken}`,
                    'Version': '2021-07-28',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contactPayload)
            });

            const createResult = await createResponse.json();
            console.log('Contact Create Response:', createResult);

            if (createResult.contact && createResult.contact.id) {
                console.log('Created contact:', createResult.contact.id);
                return { success: true, contactId: createResult.contact.id };
            }

            return { success: false, error: 'Failed to create contact in GHL' };
        }

        async function createGHLOpportunity(formData, contactId, pipelineKey = 'production') {
            const pipeline = GHL_CONFIG.pipelines[pipelineKey] || GHL_CONFIG.pipelines.production;
            const title = `Repair: ${formData.year || ''} ${formData.make || ''} ${formData.model || ''}`.trim() || 'New Repair';

            const customFields = getGHLCustomFields(formData);

            // Note: GHL Opportunities API does not accept a "notes" field directly
            // Custom fields are used for additional data instead

            const response = await fetch(`${GHL_CONFIG.baseUrl}/opportunities/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GHL_CONFIG.accessToken}`,
                    'Version': '2021-07-28',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pipelineId: pipeline.id,
                    pipelineStageId: pipeline.startStage,
                    locationId: GHL_CONFIG.locationId,
                    name: title,
                    contactId: contactId,
                    status: 'open',
                    customFields: customFields
                })
            });

            const result = await response.json();
            console.log('Opportunity Create Response:', result);
            console.log('Custom Fields Sent:', customFields);

            if (result.opportunity && result.opportunity.id) {
                console.log('Created opportunity:', result.opportunity.id);
                return { success: true, opportunityId: result.opportunity.id };
            }

            return { success: false, error: 'Failed to create opportunity' };
        }

        // ==================== FORM SUBMISSION ====================
        async function submitData(photoUrls) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '‚è≥ Submitting to GHL...';
            submitBtn.disabled = true;

            // Base Data
            const rawData = {
                roNumber: document.getElementById('roNumber').value,
                insuredName: document.getElementById('insuredName').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerPhone: document.getElementById('customerPhone').value,
                vin: document.getElementById('vin').value.toUpperCase(),
                year: document.getElementById('year').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                color: document.getElementById('color').value,
                insurance: document.getElementById('insuranceCompany').value,
                claimNumber: document.getElementById('claimNumber').value,
                location: document.getElementById('location').value,
                estimator: document.getElementById('estimator').value,
                notes: document.getElementById('notes').value,
                status: document.getElementById('status').value,
                photoUrls: photoUrls
            };

            // Collect and Bundle Panel Data
            const checklistBundles = {};

            document.querySelectorAll('#scopeForm [name]').forEach(input => {
                const name = input.name;
                let value = input.value;

                if (input.type === 'checkbox') {
                    if (!input.checked) return;
                    value = 'Yes';

                    const match = name.match(/^(.+)_(ri|rr)_(.+)$/);
                    if (match) {
                        const panel = match[1];
                        const type = match[2];
                        const part = match[3];
                        const bundleKey = `${panel}_${type}`;

                        if (!checklistBundles[bundleKey]) checklistBundles[bundleKey] = [];
                        checklistBundles[bundleKey].push(part.charAt(0).toUpperCase() + part.slice(1));
                        return;
                    }

                    rawData[name] = 'Yes';
                } else if (input.type === 'radio') {
                    if (input.checked) rawData[name] = value;
                } else {
                    rawData[name] = value;
                }
            });

            Object.keys(checklistBundles).forEach(key => {
                rawData[key] = checklistBundles[key].join(', ');
            });

            // Submit to GHL
            try {
                const pipelineKey = document.getElementById('pipelineSelect')?.value || 'production';
                const ghlResult = await submitToGHL(rawData, pipelineKey);

                if (ghlResult.success) {
                    showToast(`‚úÖ Sent to GHL! Contact: ${ghlResult.contactId}`, 'success');
                    console.log('GHL Success:', ghlResult);

                    // Show success modal
                    document.getElementById('successModal').style.display = 'flex';
                    clearDraft();
                } else {
                    showToast(`‚ö†Ô∏è GHL Error: ${ghlResult.error}`, 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Scope';
        }

        function resetForm() {
            document.getElementById('scopeForm').reset();
            selectedPhotos = [];
            renderPreviews();
            document.getElementById('successModal').style.display = 'none';
        }

        // ==================== VIN BARCODE SCANNER ====================
        let scannerActive = false;

        function startScanner() {
            const modal = document.getElementById('scannerModal');
            const status = document.getElementById('scannerStatus');
            modal.style.display = 'flex';
            scannerActive = true;
            status.textContent = 'Initializing camera...';
            status.className = 'scanner-status';

            // Check if Quagga is available
            if (typeof Quagga === 'undefined') {
                status.textContent = 'Scanner library not loaded. Using manual entry.';
                status.className = 'scanner-status error';
                return;
            }

            Quagga.init({
                inputStream: {
                    name: 'Live',
                    type: 'LiveStream',
                    target: document.getElementById('scannerCamera'),
                    constraints: {
                        facingMode: 'environment',
                        width: { min: 640, ideal: 1920, max: 1920 },
                        height: { min: 480, ideal: 1080, max: 1080 },
                        aspectRatio: { min: 1, max: 2 }
                    },
                    area: {
                        top: "20%",
                        right: "10%",
                        left: "10%",
                        bottom: "20%"
                    }
                },
                frequency: 10, // Scan 10 times per second
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: {
                    readers: [
                        'code_39_reader',
                        'code_128_reader',
                        'code_39_vin_reader',
                        'ean_reader',
                        'ean_8_reader',
                        'i2of5_reader'
                    ],
                    multiple: false
                },
                locate: true,
                locator: {
                    halfSample: false,
                    patchSize: 'large'
                }
            }, function (err) {
                if (err) {
                    console.error('[Scanner] Init error:', err);
                    status.textContent = 'Camera error: ' + (err.message || err.name || 'Unknown');
                    status.className = 'scanner-status error';
                    return;
                }
                // console.log('[Scanner] Quagga initialized successfully');
                status.textContent = 'üì° Scanning... Point at VIN barcode';
                Quagga.start();
            });

            Quagga.onDetected(onBarcodeDetected);
        }

        function onBarcodeDetected(result) {
            const code = result.codeResult.code;
            // console.log('[Scanner] Detected:', code);

            // VINs are 17 characters, alphanumeric
            if (code && code.length >= 17) {
                const vin = code.substring(0, 17).toUpperCase();
                // Validate VIN format (no I, O, Q)
                if (/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                    haptic('heavy');
                    closeScanner();
                    document.getElementById('vin').value = vin;
                    updateVinCounter();
                    decodeVin(vin);
                    return;
                }
            }

            // Check if it's a partial match
            if (code && code.length >= 10) {
                document.getElementById('scannerStatus').textContent = 'Partial read: ' + code + ' (need 17 chars)';
            }
        }

        function closeScanner() {
            const modal = document.getElementById('scannerModal');
            modal.style.display = 'none';
            scannerActive = false;

            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.offDetected(onBarcodeDetected);
                    Quagga.stop();
                } catch (e) {
                    // console.log('[Scanner] Stop error:', e);
                }
            }

            // Reset OCR view
            resetOcrView();
        }

        function resetOcrView() {
            const preview = document.getElementById('ocrPreview');
            preview.innerHTML = `
                <div class="ocr-placeholder">
                    <span class="ocr-icon">üì∏</span>
                    <p>Take a photo of the VIN sticker</p>
                    <small>Works with text - no barcode needed!</small>
                </div>
            `;
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('ocrProgressFill').style.width = '0%';
        }

        function switchScannerTab(tab) {
            const barcodeTab = document.getElementById('tabBarcode');
            const photoTab = document.getElementById('tabPhoto');
            const barcodeView = document.getElementById('barcodeView');
            const photoView = document.getElementById('photoView');
            const status = document.getElementById('scannerStatus');

            if (tab === 'barcode') {
                barcodeTab.classList.add('active');
                photoTab.classList.remove('active');
                barcodeView.classList.add('active');
                barcodeView.style.display = 'block';
                photoView.classList.remove('active');
                photoView.style.display = 'none';
                status.textContent = 'Point camera at VIN barcode';

                // Restart barcode scanner
                if (!scannerActive) {
                    startScanner();
                }
            } else {
                barcodeTab.classList.remove('active');
                photoTab.classList.add('active');
                barcodeView.classList.remove('active');
                barcodeView.style.display = 'none';
                photoView.classList.add('active');
                photoView.style.display = 'block';
                status.textContent = 'Take a photo of VIN text';

                // Stop barcode scanner
                if (typeof Quagga !== 'undefined') {
                    try {
                        Quagga.stop();
                    } catch (e) { }
                }
            }
        }

        // ==================== VIN SCAN FLOW (Google Vision API) ====================

        const GOOGLE_VISION_API_KEY = 'AIzaSyDg4XBVSyqv2zhYCiWDX5ewPULx_NCrTRg';

        function skipVinScan() {
            // Hide VIN scan section and show form
            document.querySelector('.vin-scan-section').style.display = 'none';
            showToast('üí° Enter VIN manually - auto-lookup will find Year/Make/Model', 'info');
            document.getElementById('vin').focus();
        }

        function continueToForm() {
            // Hide VIN scan section
            document.querySelector('.vin-scan-section').style.display = 'none';
            haptic('light');
        }

        function showVinResult(vinData) {
            const section = document.querySelector('.vin-scan-section');
            const content = document.querySelector('.vin-scan-content');
            const progress = document.getElementById('vinScanProgress');
            const result = document.getElementById('vinScanResult');
            const resultGrid = document.getElementById('resultGrid');

            // Hide content and progress, show result
            content.style.display = 'none';
            progress.style.display = 'none';
            result.style.display = 'block';

            // Build result items
            const fields = [
                { label: 'VIN', value: vinData.vin, id: 'vin' },
                { label: 'Year', value: vinData.year, id: 'year' },
                { label: 'Make', value: vinData.make, id: 'make' },
                { label: 'Model', value: vinData.model, id: 'model' },
            ];

            let html = fields.map(field => {
                const isFilled = field.value && field.value.trim() !== '';
                return `
                    <div class="result-item ${isFilled ? 'filled' : 'missing'}">
                        <div class="label">${isFilled ? '‚úÖ' : '‚ö†Ô∏è'} ${field.label}</div>
                        <div class="value">${isFilled ? field.value : 'Enter manually'}</div>
                    </div>
                `;
            }).join('');

            resultGrid.innerHTML = html;

            haptic('success');
        }

        async function handleVinScan(event) {
            const file = event.target.files[0];
            if (!file) return;

            const content = document.querySelector('.vin-scan-content');
            const progress = document.getElementById('vinScanProgress');
            const progressFill = document.getElementById('vinProgressFill');
            const progressText = document.getElementById('vinProgressText');

            // Check for API key
            if (!GOOGLE_VISION_API_KEY) {
                showToast('‚ö†Ô∏è Google Vision API key not configured', 'error');
                return;
            }

            // Show progress
            content.style.display = 'none';
            progress.style.display = 'block';
            progressFill.style.width = '10%';
            progressText.textContent = 'üì∑ Processing image...';

            const reader = new FileReader();
            reader.onload = async function (e) {
                const base64Image = e.target.result.split(',')[1];

                progressFill.style.width = '20%';
                progressText.textContent = 'üîÑ Sending to Google Vision...';

                try {
                    // console.log('[VIN Scan] Sending to Google Vision...');

                    // Call Google Vision API
                    const response = await fetch(
                        `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                requests: [{
                                    image: { content: base64Image },
                                    features: [{ type: 'TEXT_DETECTION', maxResults: 10 }]
                                }]
                            })
                        }
                    );

                    progressFill.style.width = '50%';
                    progressText.textContent = 'üîç Extracting VIN...';

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API error');
                    }

                    const data = await response.json();
                    const annotations = data.responses?.[0]?.textAnnotations;

                    if (!annotations || annotations.length === 0) {
                        throw new Error('No text found in image');
                    }

                    const fullText = annotations[0].description;
                    // console.log('[VIN Scan] Detected text:', fullText);

                    progressFill.style.width = '70%';
                    progressText.textContent = 'üîç Searching for VIN...';

                    // VIN check digit validation function
                    function validateVinCheckDigit(vin) {
                        const transliteration = {
                            'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7, 'H': 8,
                            'J': 1, 'K': 2, 'L': 3, 'M': 4, 'N': 5, 'P': 7, 'R': 9,
                            'S': 2, 'T': 3, 'U': 4, 'V': 5, 'W': 6, 'X': 7, 'Y': 8, 'Z': 9,
                            '0': 0, '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9
                        };
                        const weights = [8, 7, 6, 5, 4, 3, 2, 10, 0, 9, 8, 7, 6, 5, 4, 3, 2];

                        let sum = 0;
                        for (let i = 0; i < 17; i++) {
                            const char = vin[i];
                            const value = transliteration[char];
                            if (value === undefined) return false;
                            sum += value * weights[i];
                        }

                        const remainder = sum % 11;
                        const checkDigit = remainder === 10 ? 'X' : String(remainder);
                        return vin[8] === checkDigit;
                    }

                    // Correct a potential VIN (only apply O‚Üí0, I‚Üí1 to actual VIN candidates)
                    function correctVin(text) {
                        return text.toUpperCase()
                            .replace(/O/g, '0')
                            .replace(/I/g, '1')
                            .replace(/Q/g, '0');
                    }

                    let allMatches = [];
                    let vin = '';

                    // STRATEGY 1: Look at individual word annotations (skip first - it's full text)
                    // Each annotation after the first is a single word/segment
                    const wordAnnotations = annotations.slice(1).map(a => a.description);
                    // console.log('[VIN Scan] Word count:', wordAnnotations.length);

                    // Look for exactly 17-character alphanumeric words
                    for (const word of wordAnnotations) {
                        const clean = word.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                        if (clean.length === 17) {
                            const corrected = correctVin(clean);
                            if (!allMatches.includes(corrected)) {
                                allMatches.push(corrected);
                            }
                        }
                    }

                    // STRATEGY 2: Look for VIN after "VIN" label in text
                    const vinLabelMatch = fullText.match(/VIN[:\s#]*([A-Za-z0-9]{17})/i);
                    if (vinLabelMatch) {
                        const candidate = correctVin(vinLabelMatch[1]);
                        if (!allMatches.includes(candidate)) {
                            allMatches.unshift(candidate); // Priority - put at front
                        }
                    }

                    // STRATEGY 3: Lines that look like VINs (17 chars, starts with valid WMI)
                    const lines = fullText.split(/[\n\r]+/);
                    for (const line of lines) {
                        const clean = line.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                        if (clean.length >= 17 && clean.length <= 20) {
                            // Check if it starts with common VIN patterns
                            // WMI codes: starts with 1-5 (US), J (Japan), K (Korea), S (UK), W (Germany), etc.
                            if (/^[1-5JKLMNSTUVWXYZ]/.test(clean)) {
                                const candidate = correctVin(clean.substring(0, 17));
                                if (!allMatches.includes(candidate)) {
                                    allMatches.push(candidate);
                                }
                            }
                        }
                    }

                    // console.log('[VIN Scan] Candidates found:', allMatches);

                    // First try check digit validation
                    for (const candidate of allMatches) {
                        if (validateVinCheckDigit(candidate)) {
                            vin = candidate;
                            // console.log('[VIN Scan] ‚úÖ Validated VIN (checksum):', vin);
                            break;
                        }
                    }

                    // If no validated VIN, try NHTSA
                    if (!vin && allMatches.length > 0) {
                        progressText.textContent = 'üîç Verifying with NHTSA...';

                        for (const candidate of allMatches.slice(0, 5)) {
                            try {
                                const checkResponse = await fetch(
                                    `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${candidate}?format=json`
                                );
                                const checkData = await checkResponse.json();

                                if (checkData.Results?.[0]) {
                                    const result = checkData.Results[0];
                                    if (result.Make && result.Model && result.ModelYear &&
                                        result.ErrorCode !== '1') {
                                        vin = candidate;
                                        // console.log('[VIN Scan] ‚úÖ NHTSA validated VIN:', vin);
                                        break;
                                    }
                                }
                            } catch (e) {
                                console.log('[VIN Scan] Check failed for:', candidate);
                            }
                        }
                    }

                    // Fallback: use first candidate
                    if (!vin && allMatches.length > 0) {
                        vin = allMatches[0];
                        // console.log('[VIN Scan] Using first candidate:', vin);
                    }

                    if (!vin) {
                        throw new Error('Could not find VIN in image');
                    }

                    // console.log('[VIN Scan] Final VIN:', vin);

                    // Fill VIN field
                    // Fill VIN field
                    const vinEl = document.getElementById('vin');
                    vinEl.value = vin;
                    vinEl.classList.add('auto-filled');
                    updateVinCounter();

                    // Decode with NHTSA
                    progressFill.style.width = '85%';

                    const nhtsaResponse = await fetch(
                        `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`
                    );
                    const nhtsaData = await nhtsaResponse.json();

                    progressFill.style.width = '100%';
                    progressText.textContent = '‚úÖ Complete!';

                    let year = '', make = '', model = '';

                    if (nhtsaData.Results?.[0]) {
                        const vehicle = nhtsaData.Results[0];
                        // console.log('[VIN Decode] Full response:', vehicle);

                        year = vehicle.ModelYear || '';
                        make = vehicle.Make || '';
                        model = vehicle.Model || vehicle.Series || vehicle.Trim || '';

                        // Fill form fields and highlight
                        if (year) {
                            const el = document.getElementById('year');
                            el.value = year;
                            el.classList.add('auto-filled');
                        }
                        if (make) {
                            const el = document.getElementById('make');
                            el.value = make;
                            el.classList.add('auto-filled');
                        }
                        if (model) {
                            const el = document.getElementById('model');
                            el.value = model;
                            el.classList.add('auto-filled');
                        }
                    }

                    // Show result summary
                    showVinResult({ vin, year, make, model });

                } catch (e) {
                    console.error('[VIN Scan] Error:', e);
                    progressFill.style.width = '0%';
                    progress.style.display = 'none';
                    content.style.display = 'block';
                    showToast(`‚ùå ${e.message}`, 'error');
                }
            };
            reader.readAsDataURL(file);

            // Reset input
            event.target.value = '';
        }

        // Keep old handleOcrCapture for modal (backward compat)

        async function handleOcrCapture(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('ocrPreview');
            const progress = document.getElementById('ocrProgress');
            const progressFill = document.getElementById('ocrProgressFill');
            const progressText = document.getElementById('ocrProgressText');
            const status = document.getElementById('scannerStatus');

            // Check for API key
            if (!GOOGLE_VISION_API_KEY) {
                showToast('‚ö†Ô∏è Google Vision API key not configured', 'error');
                status.textContent = '‚ùå API key missing - contact admin';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = async function (e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="VIN Photo">`;

                // Get base64 data (remove prefix)
                const base64Image = e.target.result.split(',')[1];

                // Show progress
                progress.style.display = 'block';
                progressFill.style.width = '20%';
                progressText.textContent = 'Uploading to Google Vision...';
                status.textContent = 'üîÑ Processing with Google AI...';

                try {
                    // console.log('[Vision API] Sending image to Google Vision...');

                    // Call Google Vision API
                    const response = await fetch(
                        `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                requests: [{
                                    image: { content: base64Image },
                                    features: [{ type: 'TEXT_DETECTION', maxResults: 10 }]
                                }]
                            })
                        }
                    );

                    progressFill.style.width = '60%';
                    progressText.textContent = 'Analyzing text...';

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('[Vision API] Error:', errorData);
                        throw new Error(errorData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    // console.log('[Vision API] Full response:', data);

                    progressFill.style.width = '80%';
                    progressText.textContent = 'Searching for VIN...';

                    // Extract text from response
                    const annotations = data.responses?.[0]?.textAnnotations;
                    if (!annotations || annotations.length === 0) {
                        status.textContent = '‚ùå No text found in image';
                        showToast('‚ùå No text detected - try a clearer photo', 'error');
                        setTimeout(() => resetOcrView(), 3000);
                        return;
                    }

                    // First annotation contains all detected text
                    const fullText = annotations[0].description;
                    // console.log('[Vision API] Detected text:', fullText);

                    // Clean text for VIN extraction
                    let cleanText = fullText.toUpperCase()
                        .replace(/O/g, '0')  // O -> 0 (no O in VINs)
                        .replace(/I/g, '1')  // I -> 1 (no I in VINs)
                        .replace(/Q/g, '0')  // Q -> 0 (no Q in VINs)
                        .replace(/[^A-Z0-9]/g, '');

                    // console.log('[Vision API] Cleaned text:', cleanText);

                    progressFill.style.width = '100%';

                    // Look for exact 17-character VIN pattern
                    const vinPattern = /[A-HJ-NPR-Z0-9]{17}/g;
                    const matches = cleanText.match(vinPattern);

                    if (matches && matches.length > 0) {
                        const vin = matches[0];
                        // console.log('[Vision API] ‚úÖ Found VIN:', vin);

                        haptic('heavy');
                        closeScanner();
                        document.getElementById('vin').value = vin;
                        updateVinCounter();
                        decodeVin(vin);
                        showToast(`‚úÖ VIN detected: ${vin}`, 'success');
                    } else {
                        // Try looser pattern (15-19 chars)
                        const loosePattern = /[A-HJ-NPR-Z0-9]{15,19}/g;
                        const looseMatches = cleanText.match(loosePattern);

                        if (looseMatches && looseMatches.length > 0) {
                            const possibleVin = looseMatches[0].substring(0, 17);
                            console.log('[Vision API] Possible VIN:', possibleVin);

                            document.getElementById('vin').value = possibleVin;
                            updateVinCounter();
                            decodeVin(possibleVin);

                            status.textContent = `‚ö†Ô∏è Found: ${possibleVin}`;
                            showToast(`‚ö†Ô∏è VIN may need verification`, 'error');

                            setTimeout(() => closeScanner(), 1500);
                        } else {
                            // Show what was found
                            const preview = cleanText.length > 30 ? cleanText.substring(0, 30) + '...' : cleanText;
                            status.textContent = `‚ö†Ô∏è No VIN found: "${preview}"`;
                            showToast('‚ö†Ô∏è Could not find VIN in text', 'error');
                            setTimeout(() => resetOcrView(), 3000);
                        }
                    }

                } catch (e) {
                    console.error('[Vision API] Error:', e);
                    status.textContent = `‚ùå ${e.message || 'API error'}`;
                    showToast(`‚ùå ${e.message || 'Vision API failed'}`, 'error');
                    setTimeout(() => resetOcrView(), 3000);
                }
            };
            reader.readAsDataURL(file);

            // Reset file input
            event.target.value = '';
        }

        function manualVinEntry() {
            closeScanner();
            document.getElementById('vin').focus();
            showToast('üí° Type VIN - auto-lookup will find Year/Make/Model', 'info');
        }

        // NHTSA VIN Decoder API (Free)
        async function decodeVin(vin) {
            // Track this VIN to prevent duplicate lookups
            lastDecodedVin = vin;

            const status = document.getElementById('scannerStatus');
            showToast('üîç Looking up vehicle...', 'info');

            try {
                const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
                const data = await response.json();

                if (data.Results && data.Results.length > 0) {
                    const vehicle = data.Results[0];

                    // Log full response for debugging
                    // console.log('[VIN Decode] Full response:', vehicle);

                    // Extract values with fallbacks
                    const year = vehicle.ModelYear || '';
                    const make = vehicle.Make || '';
                    // Model has fallbacks: Model -> Series -> Trim -> BodyClass
                    let model = vehicle.Model || vehicle.Series || vehicle.Trim || '';
                    const bodyClass = vehicle.BodyClass || '';

                    // If still no model but we have body class, use it
                    if (!model && bodyClass) {
                        model = bodyClass;
                    }

                    // Auto-fill Year
                    if (year) {
                        const yearSelect = document.getElementById('year');
                        for (let i = 0; i < yearSelect.options.length; i++) {
                            if (yearSelect.options[i].value === year) {
                                yearSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    // Auto-fill Make
                    if (make) {
                        const makeSelect = document.getElementById('make');
                        // Try to find exact match (case-insensitive)
                        let found = false;
                        const makeLower = make.toLowerCase();
                        for (let i = 0; i < makeSelect.options.length; i++) {
                            if (makeSelect.options[i].value.toLowerCase() === makeLower ||
                                makeSelect.options[i].textContent.toLowerCase() === makeLower) {
                                makeSelect.selectedIndex = i;
                                found = true;
                                break;
                            }
                        }
                        // If not found, add it as new option
                        if (!found && make) {
                            const opt = document.createElement('option');
                            // Capitalize properly
                            const formattedMake = make.charAt(0).toUpperCase() + make.slice(1).toLowerCase();
                            opt.value = formattedMake;
                            opt.textContent = formattedMake;
                            makeSelect.appendChild(opt);
                            makeSelect.value = formattedMake;
                        }
                    }

                    // Auto-fill Model
                    if (model) {
                        document.getElementById('model').value = model;
                    }

                    haptic();

                    // Show appropriate success message
                    if (year && make && model) {
                        showToast(`‚úÖ ${year} ${make} ${model}`, 'success');
                    } else if (year && make) {
                        showToast(`‚úÖ ${year} ${make} (model not in database)`, 'success');
                    } else {
                        showToast(`‚ö†Ô∏è Partial data: ${year || 'No year'} ${make || 'No make'}`, 'error');
                    }

                    saveDraft();
                } else {
                    showToast('‚ö†Ô∏è VIN not found in database', 'error');
                }
            } catch (e) {
                console.error('[VIN Decode] Error:', e);
                showToast('‚ö†Ô∏è Could not decode VIN - check connection', 'error');
            }
        }


        // ==================== APP BUTTON (Install/Update) ====================
        const LOCAL_APP_VERSION = '2026.01.24.01';
        let deferredInstallPrompt = null;
        let appButtonState = 'checking'; // checking, install, update, current

        // Capture the install prompt before it's shown
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            console.log('[PWA] Install prompt captured');
            // If we're still checking, this means we can show install
            if (appButtonState === 'checking' || appButtonState === 'current') {
                setAppButtonState('install');
            }
        });

        function setAppButtonState(state) {
            appButtonState = state;
            const btn = document.getElementById('appBtn');
            if (!btn) return;

            // Remove all state classes
            btn.classList.remove('state-checking', 'state-install', 'state-update', 'state-current');

            switch (state) {
                case 'checking':
                    btn.classList.add('state-checking');
                    btn.innerHTML = '‚è≥ Checking...';
                    break;
                case 'install':
                    btn.classList.add('state-install');
                    btn.innerHTML = 'üì• Install App';
                    break;
                case 'update':
                    btn.classList.add('state-update');
                    btn.innerHTML = 'üîÑ Update Available';
                    break;
                case 'current':
                    btn.classList.add('state-current');
                    btn.innerHTML = '‚úì v' + LOCAL_APP_VERSION;
                    break;
            }
        }

        async function checkForUpdates() {
            try {
                const response = await fetch('version.json?t=' + Date.now(), { cache: 'no-store' });
                if (!response.ok) {
                    setAppButtonState('current');
                    return;
                }

                const data = await response.json();
                const serverVersion = data.version;

                console.log('[Version Check] Local:', LOCAL_APP_VERSION, 'Server:', serverVersion);

                if (serverVersion && serverVersion !== LOCAL_APP_VERSION) {
                    setAppButtonState('update');
                } else if (deferredInstallPrompt) {
                    setAppButtonState('install');
                } else {
                    setAppButtonState('current');
                }
            } catch (err) {
                console.log('[Version Check] Error:', err.message);
                setAppButtonState('current');
            }
        }

        async function handleAppButton() {
            const btn = document.getElementById('appBtn');

            if (appButtonState === 'install' && deferredInstallPrompt) {
                // Trigger PWA install
                deferredInstallPrompt.prompt();
                const { outcome } = await deferredInstallPrompt.userChoice;
                console.log('[PWA] Install outcome:', outcome);
                deferredInstallPrompt = null;
                if (outcome === 'accepted') {
                    setAppButtonState('current');
                }
            } else if (appButtonState === 'update') {
                // Clear cache and reload
                if (btn) {
                    btn.innerHTML = '‚è≥ Updating...';
                    btn.disabled = true;
                }

                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }

                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));

                    console.log('[Update] Caches cleared, reloading...');
                    window.location.reload(true);
                } catch (err) {
                    console.error('[Update] Error:', err);
                    alert('Update failed. Please clear your browser cache manually.');
                    setAppButtonState('update');
                }
            }
            // If state is 'current' or 'checking', button does nothing
        }

        // ==================== GLOBAL FIELD HIGHLIGHTING ====================
        function setupFieldHighlighting() {
            // Target all relevant inputs in the form
            const inputs = document.querySelectorAll('#scopeForm input:not([type="hidden"]):not([type="submit"]):not([type="file"]):not([type="checkbox"]):not([type="radio"]), #scopeForm select, #scopeForm textarea');

            function updateHighlight(el) {
                if (el.value && el.value.trim() !== '') {
                    el.classList.add('auto-filled');
                } else {
                    el.classList.remove('auto-filled');
                }
            }

            inputs.forEach(el => {
                // Initial check
                updateHighlight(el);

                // Add listeners
                el.addEventListener('input', () => updateHighlight(el));
                el.addEventListener('change', () => updateHighlight(el));
            });
        }

        // Initialize highlighting
        document.addEventListener('DOMContentLoaded', setupFieldHighlighting);

        // Check for updates on page load
        window.addEventListener('load', () => {
            setTimeout(checkForUpdates, 1500);
            initGoogleAuth();
        });
    </script>
</body>

</html>